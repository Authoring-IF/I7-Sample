!function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=14)}([function(e,t,r){"use strict";function n(){for(var e,t,r=arguments[0],n=1;n<arguments.length;)for(t in e=arguments[n++])r[t]=e[t];return r}function i(){}function s(e){for(var t=0,r=e.length,n=new Uint16Array(r/2);t<r;)n[t/2]=e[t++]<<8|e[t++];return n}i.subClass=function(e){function t(){this.init&&this.init.apply(this,arguments)}return t.prototype=n(Object.create(this.prototype),e),t.subClass=this.subClass,t.super=t.prototype.super=this.prototype,t},e.exports={extend:n,Class:i,MemoryView:function(e,t,r){return"number"==typeof e?e=new ArrayBuffer(e):e.buffer&&(t|=0,void 0===r&&(r=e.byteLength-t),t+=e.byteOffset,e=e.buffer),n(new DataView(e,t,r),{getUint8Array:function(e,t){return e+=this.byteOffset,new Uint8Array(this.buffer.slice(e,e+t))},getUint16Array:function(e,t){return e+=this.byteOffset,s(new Uint8Array(this.buffer,e,2*t))},setUint8Array:function(e,t){t instanceof ArrayBuffer&&(t=new Uint8Array(t)),new Uint8Array(this.buffer,this.byteOffset,this.byteLength).set(t,e)},getFourCC:function(e){return String.fromCharCode(this.getUint8(e),this.getUint8(e+1),this.getUint8(e+2),this.getUint8(e+3))},setFourCC:function(e,t){this.setUint8(e,t.charCodeAt(0)),this.setUint8(e+1,t.charCodeAt(1)),this.setUint8(e+2,t.charCodeAt(2)),this.setUint8(e+3,t.charCodeAt(3))}})},U2S16:function(e){return e<<16>>16},S2U16:function(e){return 65535&e},Uint8toUint16Array:s}},function(module,__webpack_exports__,__webpack_require__){"use strict";var Dialog=function(){var dialog_el_id="dialog",is_open=!1,dialog_callback=null,will_save,confirming,editing,editing_dirent,cur_usage,cur_usage_name,cur_gameid,cur_filelist;function dialog_open(e,t,r,n){if(is_open)throw new Error("Dialog: dialog box is already open.");if(!Storage)throw new Error("Dialog: no storage API is available.");dialog_callback=n,will_save=e,confirming=!1,editing=!1,editing_dirent=null,cur_gameid=r,cur_usage_name=label_for_usage(cur_usage=t);var i="windowport",s=window.Game;window.GlkOte&&(s=window.GlkOte.getinterface()),s&&s.windowport&&(i=s.windowport);var o=$("#"+i);if(!o.length)throw new Error("Dialog: unable to find root element #"+i+".");var a=$("#"+dialog_el_id+"_screen");a.length||(a=$("<div>",{id:dialog_el_id+"_screen"}),o.append(a));var l=$("#"+dialog_el_id+"_frame");l.length||(l=$("<div>",{id:dialog_el_id+"_frame"}),o.append(l));var u,f,c,d=$("#"+dialog_el_id);d.length&&d.remove(),d=$("<div>",{id:dialog_el_id}),(u=$("<form>")).on("submit",will_save?evhan_accept_save_button:evhan_accept_load_button),d.append(u),c=$("<div>",{class:"DiaButtonsFloat"}),(f=$("<button>",{id:dialog_el_id+"_edit",type:"button"})).append("Edit"),f.on("click",evhan_edit_button),c.append(f),u.append(c),(c=$("<div>",{id:dialog_el_id+"_cap",class:"DiaCaption"})).append("XXX"),u.append(c),will_save&&(c=$("<div>",{id:dialog_el_id+"_input",class:"DiaInput"}),u.append(c),f=$("<input>",{id:dialog_el_id+"_infield",type:"text",name:"filename"}),c.append(f),(c=$("<div>",{id:dialog_el_id+"_warning",class:"DiaWarning"})).text("Warning: data may be erased by clearing cookies or browser privacy policies."),u.append(c)),c=$("<div>",{id:dialog_el_id+"_body",class:"DiaBody"}),u.append(c),(c=$("<div>",{id:dialog_el_id+"_cap2",class:"DiaCaption"})).hide(),u.append(c),c=$("<div>",{id:dialog_el_id+"_buttonrow",class:"DiaButtons"}),(f=$("<button>",{id:dialog_el_id+"_cancel",type:"button"})).append("Cancel"),f.on("click",evhan_cancel_button),c.append(f),(f=$("<button>",{id:dialog_el_id+"_delete",type:"button"})).append("Delete"),f.on("click",evhan_delete_button),f.hide(),c.append(f),(f=$("<button>",{id:dialog_el_id+"_display",type:"button"})).append("Display"),f.on("click",evhan_display_button),f.hide(),c.append(f),(f=$("<button>",{id:dialog_el_id+"_accept",type:"submit"})).append(will_save?"Save":"Load"),f.on("click",will_save?evhan_accept_save_button:evhan_accept_load_button),c.append(f),u.append(c),l.append(d),is_open=!0,evhan_storage_changed(),defer_func(will_save?function(){var e=$("#"+dialog_el_id+"_infield");e.length&&e.focus()}:function(){var e=$("#"+dialog_el_id+"_select");e.length&&e.focus()})}function dialog_close(){var e=$("#"+dialog_el_id);e.length&&e.remove();var t=$("#"+dialog_el_id+"_frame");t.length&&t.remove();var r=$("#"+dialog_el_id+"_screen");r.length&&r.remove(),is_open=!1,dialog_callback=null,cur_filelist=null,editing=!1,editing_dirent=null}function set_caption(e,t){var r=$("#"+(t?dialog_el_id+"_cap":dialog_el_id+"_cap2"));r.length&&(e?(r.text(e),r.show()):r.hide())}function label_for_usage(e){switch(e){case"data":return"data file";case"save":return"save file";case"transcript":return"transcript";case"command":return"command script";default:return"file"}}function usage_is_textual(e){return"transcript"==e||"command"==e}function defer_func(e){return window.setTimeout(e,10)}function evhan_select_change(){if(!is_open)return!1;if(confirming)return!1;var e=$("#"+dialog_el_id+"_select");if(!e.length)return!1;var t=e.prop("selectedIndex");if(!cur_filelist||t<0||t>=cur_filelist.length)return!1;var r=cur_filelist[t],n=$("#"+dialog_el_id+"_infield");return!!n.length&&(n.val(r.dirent.filename),!1)}function evhan_select_change_editing(){if(!is_open)return!1;if(!editing||editing_dirent)return!1;var e=$("#"+dialog_el_id+"_delete");e.prop("disabled",!0),(e=$("#"+dialog_el_id+"_display")).prop("disabled",!0);var t=$("#"+dialog_el_id+"_select");if(!t.length)return!1;var r=t.prop("selectedIndex");if(!cur_filelist||r<0||r>=cur_filelist.length)return!1;var n=cur_filelist[r];if(!n||!n.dirent||!file_ref_exists(n.dirent))return!1;(e=$("#"+dialog_el_id+"_delete")).prop("disabled",!1),(e=$("#"+dialog_el_id+"_display")).prop("disabled",!1)}function evhan_accept_load_button(e){if(e.preventDefault(),!is_open)return!1;if(editing)return!1;var t=$("#"+dialog_el_id+"_select");if(!t.length)return!1;var r=t.prop("selectedIndex");if(!cur_filelist||r<0||r>=cur_filelist.length)return!1;var n=cur_filelist[r];if(!n||!n.dirent||!file_ref_exists(n.dirent))return!1;var i=dialog_callback;return dialog_close(),i&&i(n.dirent),!1}function evhan_accept_save_button(e){if(e.preventDefault(),!is_open)return!1;if(editing)return!1;var t=$("#"+dialog_el_id+"_infield");if(!t.length)return!1;var r=t.val();if(!(r=jQuery.trim(r)).length)return!1;var n=file_construct_ref(r,cur_usage,cur_gameid);if(file_ref_exists(n)&&!confirming)return confirming=!0,set_caption("You already have a "+cur_usage_name+' "'+n.filename+'". Do you want to replace it?',!1),t.prop("disabled",!0),$("#"+dialog_el_id+"_accept").text("Replace"),!1;var i=dialog_callback;return dialog_close(),i&&i(n),!1}function evhan_edit_button(e){if(e.preventDefault(),!is_open)return!1;if(editing){if(editing_dirent){editing=!0,editing_dirent=null,$("#"+dialog_el_id+"_buttonrow").show();return $("#"+dialog_el_id+"_edit").text("Done"),evhan_storage_changed(),!1}{editing=!1,editing_dirent=null;const e=$("#"+dialog_el_id+"_input");e.length&&e.show();let t=$("#"+dialog_el_id+"_edit");return t.text("Edit"),t=$("#"+dialog_el_id+"_delete"),t.hide(),t=$("#"+dialog_el_id+"_display"),t.hide(),t=$("#"+dialog_el_id+"_accept"),t.show(),evhan_storage_changed(),!1}}{if(editing=!0,editing_dirent=null,confirming){confirming=!1,set_caption(null,!1);$("#"+dialog_el_id+"_infield").prop("disabled",!1);const e=$("#"+dialog_el_id+"_accept");e.prop("disabled",!1),e.text("Save")}const e=$("#"+dialog_el_id+"_input");e.length&&e.hide();let t=$("#"+dialog_el_id+"_edit");return t.text("Done"),t=$("#"+dialog_el_id+"_delete"),t.show(),t=$("#"+dialog_el_id+"_display"),t.show(),t=$("#"+dialog_el_id+"_accept"),t.hide(),evhan_storage_changed(),!1}}function evhan_delete_button(e){if(e.preventDefault(),!is_open)return!1;if(!editing||editing_dirent)return!1;var t=$("#"+dialog_el_id+"_select");if(!t.length)return!1;var r=t.prop("selectedIndex");if(!cur_filelist||r<0||r>=cur_filelist.length)return!1;var n=cur_filelist[r];return!(!n||!n.dirent)&&(file_remove_ref(n.dirent),evhan_storage_changed(),!1)}function evhan_display_button(e){if(e.preventDefault(),!is_open)return!1;if(!editing||editing_dirent)return!1;var t=$("#"+dialog_el_id+"_select");if(!t.length)return!1;var r=t.prop("selectedIndex");if(!cur_filelist||r<0||r>=cur_filelist.length)return!1;var n=cur_filelist[r];return!!(n&&n.dirent&&file_ref_exists(n.dirent))&&($("#"+dialog_el_id+"_buttonrow").hide(),$("#"+dialog_el_id+"_edit").text("Close"),editing_dirent=n.dirent,evhan_storage_changed(),!1)}function evhan_cancel_button(e){if(e.preventDefault(),!is_open)return!1;if(confirming){confirming=!1,set_caption(null,!1),$("#"+dialog_el_id+"_infield").prop("disabled",!1);var t=$("#"+dialog_el_id+"_accept");return t.prop("disabled",!1),t.text("Save"),!1}var r=dialog_callback;return dialog_close(),r&&r(null),!1}function evhan_storage_changed(){if(!is_open)return!1;var e,t,r,n;if(!(t=$("#"+dialog_el_id+"_body")).length)return!1;if(editing&&editing_dirent&&(file_ref_exists(editing_dirent)||(editing_dirent=null,$("#"+dialog_el_id+"_buttonrow").show(),$("#"+dialog_el_id+"_edit").text("Done"))),editing&&editing_dirent){t.empty();var i=file_read(editing_dirent);if(i=String.fromCharCode.apply(this,i),usage_is_textual(editing_dirent.usage)){var s=$("<pre>",{class:"DiaDisplayText"});s.text(i),t.append(s),set_caption("Displaying file contents...",!0)}else{var o=window.btoa(i),a=$("<a>",{href:"data:application/octet-stream;base64,"+o,target:"_blank",download:"data"});a.text(editing_dirent.filename),t.append(a),set_caption('Use "Save As" option in your browser to download this link.',!0)}return!1}if(editing){if(r=files_list(null,cur_gameid),""!=cur_gameid&&(r=r.concat(files_list(null,""))),r.sort((function(e,t){return e.dirent.usage<t.dirent.usage?-1:e.dirent.usage>t.dirent.usage?1:t.modified.getTime()-e.modified.getTime()})),0==r.length)return t.empty(),$("#"+dialog_el_id+"_delete").prop("disabled",!0),$("#"+dialog_el_id+"_display").prop("disabled",!0),set_caption("You have no stored files. Press Done to continue.",!0),!1;cur_filelist=[],n="";for(let e=0;e<r.length;e++)s=r[e],s.dirent.usage!=n&&(n=s.dirent.usage,cur_filelist.push({label:n})),cur_filelist.push(s);r=cur_filelist,t.empty();const i=$("<select>",{id:dialog_el_id+"_select",name:"files"});let s,o;i.prop("size","5");var l=!1;for(let t=0;t<r.length;t++)s=r[t],s.dirent?(e=$("<option>",{name:"f"+t}),l||(l=!0,e.selected=!0),o=format_date(s.modified),e.text(s.dirent.filename+" -- "+o),i.append(e)):((e=$("<option>",{name:"f"+t})).prop("disabled",!0),e.text("-- "+label_for_usage(s.label)+"s --"),i.append(e));return t.append(i),i.on("change",evhan_select_change_editing),evhan_select_change_editing(),set_caption("All stored files are now visible. You may delete them, and display files containing text. Press Done when finished.",!0),!1}if((r=files_list(cur_usage,cur_gameid)).sort((function(e,t){return t.modified.getTime()-e.modified.getTime()})),cur_filelist=r,0==r.length)t.empty();else{t.empty();const n=$("<select>",{id:dialog_el_id+"_select",name:"files"});let i,s;n.prop("size","5");for(let t=0;t<r.length;t++)i=r[t],e=$("<option>",{name:"f"+t}),0==t&&(e.selected=!0),s=format_date(i.modified),e.text(i.dirent.filename+" -- "+s),n.append(e);t.append(n),will_save&&n.on("change",evhan_select_change)}will_save?(set_caption("Name this "+cur_usage_name+".",!0),(e=$("#"+dialog_el_id+"_accept")).prop("disabled",!1)):0==r.length?(set_caption("You have no "+cur_usage_name+"s for this game.",!0),(e=$("#"+dialog_el_id+"_accept")).prop("disabled",!0)):(set_caption("Select a "+cur_usage_name+" to load.",!0),(e=$("#"+dialog_el_id+"_accept")).prop("disabled",!1))}function file_clean_fixed_name(e){return e}function file_construct_ref(e,t,r){e||(e=""),t||(t=""),r||(r="");var n=t+":"+r+":"+e;return{dirent:"dirent:"+n,content:"content:"+n,filename:e,usage:t,gameid:r}}function file_construct_temp_ref(e){var t="_temp_"+(new Date).getTime()+"_"+Math.random();return file_construct_ref(t=t.replace(".",""),e)}function file_decode_ref(e){if("dirent:"!=e.slice(0,7))return null;var t=7,r=e.indexOf(":",t);if(r<0)return null;var n=e.slice(t,r);if(t=r+1,(r=e.indexOf(":",t))<0)return null;var i=e.slice(t,r);t=r+1;var s=e.slice(t),o="cont"+e.slice(3);return{dirent:e,content:o,filename:s,usage:n,gameid:i}}function file_load_dirent(e){if("object"!=typeof e&&!(e=file_decode_ref(e)))return null;var t=Storage.getItem(e.dirent);if(!t)return null;var r,n,i,s,o={dirent:e},a=t.toString().split(",");for(r=0;r<a.length;r++)if(!((n=(s=a[r]).indexOf(":"))<0))switch(i=s.slice(0,n),s=s.slice(n+1),i){case"created":o.created=new Date(Number(s));break;case"modified":o.modified=new Date(Number(s))}return o}function file_ref_exists(e){return!!Storage.getItem(e.dirent)}function file_remove_ref(e){Storage.removeItem(e.dirent),Storage.removeItem(e.content)}function file_write(e,t,r){var n,i,s,o,a=file_load_dirent(e);return a||(a={dirent:e,created:new Date}),a.modified=new Date,r||(t=encode_array(t)),i=[],a.created&&i.push("created:"+a.created.getTime()),a.modified&&i.push("modified:"+a.modified.getTime()),n=i.join(","),s=Storage.setItem(a.dirent.dirent,n),o=Storage.setItem(a.dirent.content,t),!s&&!o}function file_read(e,t){if(!file_load_dirent(e))return null;var r=Storage.getItem(e.content);return null==r?null:(r=r.toString())?t?r:decode_array(r):t?"":[]}function file_notimplemented(){throw new Error("streaming function not implemented in Dialog")}function file_ref_matches(e,t,r){return(null==t||e.usage==t)&&(null==r||e.gameid==r)}function files_list(e,t){var r,n=[];if(!Storage)return n;var i=Storage.getKeys();for(r=0;r<i.length;r++){var s=i[r];if(s){var o=file_decode_ref(s.toString());if(o&&file_ref_matches(o,e,t)){var a=file_load_dirent(o);n.push(a)}}}return n}function format_date(e){return e?e.getMonth()+1+"/"+e.getDate()+" "+(e.getHours()+":"+(e.getMinutes()<10?"0":"")+e.getMinutes()):"???"}function autosave_write(e,t){var r="autosave:"+e;t?Storage.setItem(r,JSON.stringify(t)):Storage.removeItem(r)}function autosave_read(e){var t="autosave:"+e,r=Storage.getItem(t);if(r)try{return JSON.parse(r)}catch(e){return null}return null}var encode_array=null,decode_array=null;window.JSON?(encode_array=function(e){var t=JSON.stringify(e),r=t.length;return'"'==t[0]&&'"'==t[r-1]&&(t=t.slice(1,r-1)),t},decode_array=function(e){return JSON.parse(e)}):(encode_array=function(e){return"["+e+"]"},decode_array=function(val){return eval(val)});var Storage=null;try{var htmlLocalStorage=null;if(null!=window.localStorage?htmlLocalStorage=window.localStorage:null!=window.globalStorage&&(htmlLocalStorage=window.globalStorage[location.hostname]),htmlLocalStorage)try{if(htmlLocalStorage.setItem("_dialogtest","xyzzy"),"xyzzy"!=htmlLocalStorage.getItem("_dialogtest"))throw new Error("localStorage test did not match");htmlLocalStorage.removeItem("_dialogtest"),Storage={getItem:function(e){try{return htmlLocalStorage.getItem(e)}catch(e){return null}},removeItem:function(e){try{htmlLocalStorage.removeItem(e)}catch(e){return null}},setItem:function(e,t){try{htmlLocalStorage.setItem(e,t)}catch(e){return!0}},getKeys:function(){for(var e=[],t=0;t<htmlLocalStorage.length;t++)e.push(htmlLocalStorage.key(t));return e}}}catch(e){}}catch(e){}return null==Storage&&(Storage={data:{},keys:[],getItem:function(e){return Storage.data[e]},setItem:function(e,t){Storage.keys.indexOf(e)<0&&Storage.keys.push(e),Storage.data[e]=t},removeItem:function(e){var t=Storage.keys.indexOf(e);t>=0&&(Storage.keys.splice(t,1),delete Storage.data[e])},getKeys:function(){return Storage.keys.slice(0)}}),$(window).on("storage",evhan_storage_changed),{streaming:!1,open:dialog_open,file_clean_fixed_name:file_clean_fixed_name,file_construct_ref:file_construct_ref,file_construct_temp_ref:file_construct_temp_ref,file_ref_exists:file_ref_exists,file_remove_ref:file_remove_ref,file_write:file_write,file_read:file_read,file_fopen:file_notimplemented,autosave_write:autosave_write,autosave_read:autosave_read}}();__webpack_exports__.a=Dialog},function(e,t){var r=function(){var e={};e.VM=null;var t={0:"window",1:"stream",2:"fileref",3:"schannel"};function r(e,t,r){this.id=e,this.name=t,this.proto=r}function n(e,t){this.args=e,this.retarg=t}function i(){this.macro="Byte",this.refsize=1,this.serialize=function(){return{type:"ArgString"}}}function s(){this.macro="Word",this.refsize=4,this.serialize=function(){return{type:"ArgUnicode"}}}function o(e){this.signed=e,this.macro="Byte",this.refsize=1,this.literal=e?"arg_char_signed":"arg_char_unsigned",this.serialize=function(){return{type:"ArgChar",signed:e}}}function a(e){this.signed=e,this.macro="Word",this.refsize=4,this.literal=e?"arg_int_signed":"arg_int_unsigned",this.serialize=function(){return{type:"ArgInt",signed:e}}}function l(e){this.name=e,this.macro="Word",this.refsize=4}function u(e){this.form=e}function f(e,t,r,n){this.arg=e,this.passin=t,this.passout=r,this.nonnull=n}function c(e,t,r,n,i){this.arg=e,this.retained=t,this.passin=r,this.passout=n,this.nonnull=i}function d(e){switch(e.type){case"ArgString":return new i;case"ArgUnicode":return new s;case"ArgInt":return e.signed?p:h;case"ArgChar":return null===e.signed?g:e.signed?m:_}throw new Error("arg_deserialize: unknown type: "+e.type)}var h=new a(!1),p=new a(!0),_=new o(!1),g=new o(null),m=new o(!0),w=new l("window"),v=new l("stream"),b=new l("fileref"),k=new l("schannel"),y={1:new r(1,"exit",new n([],null)),3:new r(3,"tick",new n([],null)),4:new r(4,"gestalt",new n([h,h],new f(h,!1,!0,!0))),5:new r(5,"gestalt_ext",new n([h,h,new c(h,!1,!0,!0,!1)],new f(h,!1,!0,!0))),32:new r(32,"window_iterate",new n([w,new f(h,!1,!0,!1)],new f(w,!1,!0,!0))),33:new r(33,"window_get_rock",new n([w],new f(h,!1,!0,!0))),34:new r(34,"window_get_root",new n([],new f(w,!1,!0,!0))),35:new r(35,"window_open",new n([w,h,h,h,h],new f(w,!1,!0,!0))),36:new r(36,"window_close",new n([w,new f(new u(new n([h,h],null)),!1,!0,!1)],null)),37:new r(37,"window_get_size",new n([w,new f(h,!1,!0,!1),new f(h,!1,!0,!1)],null)),38:new r(38,"window_set_arrangement",new n([w,h,h,w],null)),39:new r(39,"window_get_arrangement",new n([w,new f(h,!1,!0,!1),new f(h,!1,!0,!1),new f(w,!1,!0,!1)],null)),40:new r(40,"window_get_type",new n([w],new f(h,!1,!0,!0))),41:new r(41,"window_get_parent",new n([w],new f(w,!1,!0,!0))),42:new r(42,"window_clear",new n([w],null)),43:new r(43,"window_move_cursor",new n([w,h,h],null)),44:new r(44,"window_get_stream",new n([w],new f(v,!1,!0,!0))),45:new r(45,"window_set_echo_stream",new n([w,v],null)),46:new r(46,"window_get_echo_stream",new n([w],new f(v,!1,!0,!0))),47:new r(47,"set_window",new n([w],null)),48:new r(48,"window_get_sibling",new n([w],new f(w,!1,!0,!0))),64:new r(64,"stream_iterate",new n([v,new f(h,!1,!0,!1)],new f(v,!1,!0,!0))),65:new r(65,"stream_get_rock",new n([v],new f(h,!1,!0,!0))),66:new r(66,"stream_open_file",new n([b,h,h],new f(v,!1,!0,!0))),67:new r(67,"stream_open_memory",new n([new c(g,!0,!0,!0,!1),h,h],new f(v,!1,!0,!0))),68:new r(68,"stream_close",new n([v,new f(new u(new n([h,h],null)),!1,!0,!1)],null)),69:new r(69,"stream_set_position",new n([v,p,h],null)),70:new r(70,"stream_get_position",new n([v],new f(h,!1,!0,!0))),71:new r(71,"stream_set_current",new n([v],null)),72:new r(72,"stream_get_current",new n([],new f(v,!1,!0,!0))),73:new r(73,"stream_open_resource",new n([h,h],new f(v,!1,!0,!0))),96:new r(96,"fileref_create_temp",new n([h,h],new f(b,!1,!0,!0))),97:new r(97,"fileref_create_by_name",new n([h,new i,h],new f(b,!1,!0,!0))),98:new r(98,"fileref_create_by_prompt",new n([h,h,h],new f(b,!1,!0,!0))),99:new r(99,"fileref_destroy",new n([b],null)),100:new r(100,"fileref_iterate",new n([b,new f(h,!1,!0,!1)],new f(b,!1,!0,!0))),101:new r(101,"fileref_get_rock",new n([b],new f(h,!1,!0,!0))),102:new r(102,"fileref_delete_file",new n([b],null)),103:new r(103,"fileref_does_file_exist",new n([b],new f(h,!1,!0,!0))),104:new r(104,"fileref_create_from_fileref",new n([h,b,h],new f(b,!1,!0,!0))),128:new r(128,"put_char",new n([_],null)),129:new r(129,"put_char_stream",new n([v,_],null)),130:new r(130,"put_string",new n([new i],null)),131:new r(131,"put_string_stream",new n([v,new i],null)),132:new r(132,"put_buffer",new n([new c(g,!1,!0,!1,!0)],null)),133:new r(133,"put_buffer_stream",new n([v,new c(g,!1,!0,!1,!0)],null)),134:new r(134,"set_style",new n([h],null)),135:new r(135,"set_style_stream",new n([v,h],null)),144:new r(144,"get_char_stream",new n([v],new f(p,!1,!0,!0))),145:new r(145,"get_line_stream",new n([v,new c(g,!1,!1,!0,!0)],new f(h,!1,!0,!0))),146:new r(146,"get_buffer_stream",new n([v,new c(g,!1,!1,!0,!0)],new f(h,!1,!0,!0))),160:new r(160,"char_to_lower",new n([_],new f(_,!1,!0,!0))),161:new r(161,"char_to_upper",new n([_],new f(_,!1,!0,!0))),176:new r(176,"stylehint_set",new n([h,h,h,p],null)),177:new r(177,"stylehint_clear",new n([h,h,h],null)),178:new r(178,"style_distinguish",new n([w,h,h],new f(h,!1,!0,!0))),179:new r(179,"style_measure",new n([w,h,h,new f(h,!1,!0,!1)],new f(h,!1,!0,!0))),192:new r(192,"select",new n([new f(new u(new n([h,w,h,h],null)),!1,!0,!0)],null)),193:new r(193,"select_poll",new n([new f(new u(new n([h,w,h,h],null)),!1,!0,!0)],null)),208:new r(208,"request_line_event",new n([w,new c(g,!0,!0,!0,!0),h],null)),209:new r(209,"cancel_line_event",new n([w,new f(new u(new n([h,w,h,h],null)),!1,!0,!1)],null)),210:new r(210,"request_char_event",new n([w],null)),211:new r(211,"cancel_char_event",new n([w],null)),212:new r(212,"request_mouse_event",new n([w],null)),213:new r(213,"cancel_mouse_event",new n([w],null)),214:new r(214,"request_timer_events",new n([h],null)),224:new r(224,"image_get_info",new n([h,new f(h,!1,!0,!1),new f(h,!1,!0,!1)],new f(h,!1,!0,!0))),225:new r(225,"image_draw",new n([w,h,p,p],new f(h,!1,!0,!0))),226:new r(226,"image_draw_scaled",new n([w,h,p,p,h,h],new f(h,!1,!0,!0))),232:new r(232,"window_flow_break",new n([w],null)),233:new r(233,"window_erase_rect",new n([w,p,p,h,h],null)),234:new r(234,"window_fill_rect",new n([w,h,p,p,h,h],null)),235:new r(235,"window_set_background_color",new n([w,h],null)),240:new r(240,"schannel_iterate",new n([k,new f(h,!1,!0,!1)],new f(k,!1,!0,!0))),241:new r(241,"schannel_get_rock",new n([k],new f(h,!1,!0,!0))),242:new r(242,"schannel_create",new n([h],new f(k,!1,!0,!0))),243:new r(243,"schannel_destroy",new n([k],null)),244:new r(244,"schannel_create_ext",new n([h,h],new f(k,!1,!0,!0))),247:new r(247,"schannel_play_multi",new n([new c(k,!1,!0,!1,!0),new c(h,!1,!0,!1,!0),h],new f(h,!1,!0,!0))),248:new r(248,"schannel_play",new n([k,h],new f(h,!1,!0,!0))),249:new r(249,"schannel_play_ext",new n([k,h,h,h],new f(h,!1,!0,!0))),250:new r(250,"schannel_stop",new n([k],null)),251:new r(251,"schannel_set_volume",new n([k,h],null)),252:new r(252,"sound_load_hint",new n([h,h],null)),253:new r(253,"schannel_set_volume_ext",new n([k,h,h,h],null)),254:new r(254,"schannel_pause",new n([k],null)),255:new r(255,"schannel_unpause",new n([k],null)),256:new r(256,"set_hyperlink",new n([h],null)),257:new r(257,"set_hyperlink_stream",new n([v,h],null)),258:new r(258,"request_hyperlink_event",new n([w],null)),259:new r(259,"cancel_hyperlink_event",new n([w],null)),288:new r(288,"buffer_to_lower_case_uni",new n([new c(h,!1,!0,!0,!0),h],new f(h,!1,!0,!0))),289:new r(289,"buffer_to_upper_case_uni",new n([new c(h,!1,!0,!0,!0),h],new f(h,!1,!0,!0))),290:new r(290,"buffer_to_title_case_uni",new n([new c(h,!1,!0,!0,!0),h,h],new f(h,!1,!0,!0))),291:new r(291,"buffer_canon_decompose_uni",new n([new c(h,!1,!0,!0,!0),h],new f(h,!1,!0,!0))),292:new r(292,"buffer_canon_normalize_uni",new n([new c(h,!1,!0,!0,!0),h],new f(h,!1,!0,!0))),296:new r(296,"put_char_uni",new n([h],null)),297:new r(297,"put_string_uni",new n([new s],null)),298:new r(298,"put_buffer_uni",new n([new c(h,!1,!0,!1,!0)],null)),299:new r(299,"put_char_stream_uni",new n([v,h],null)),300:new r(300,"put_string_stream_uni",new n([v,new s],null)),301:new r(301,"put_buffer_stream_uni",new n([v,new c(h,!1,!0,!1,!0)],null)),304:new r(304,"get_char_stream_uni",new n([v],new f(p,!1,!0,!0))),305:new r(305,"get_buffer_stream_uni",new n([v,new c(h,!1,!1,!0,!0)],new f(h,!1,!0,!0))),306:new r(306,"get_line_stream_uni",new n([v,new c(h,!1,!1,!0,!0)],new f(h,!1,!0,!0))),312:new r(312,"stream_open_file_uni",new n([b,h,h],new f(v,!1,!0,!0))),313:new r(313,"stream_open_memory_uni",new n([new c(h,!0,!0,!0,!1),h,h],new f(v,!1,!0,!0))),314:new r(314,"stream_open_resource_uni",new n([h,h],new f(v,!1,!0,!0))),320:new r(320,"request_char_event_uni",new n([w],null)),321:new r(321,"request_line_event_uni",new n([w,new c(h,!0,!0,!0,!0),h],null)),336:new r(336,"set_echo_line_event",new n([w,h],null)),337:new r(337,"set_terminators_line_event",new n([w,new c(h,!1,!0,!1,!1)],null)),352:new r(352,"current_time",new n([new f(new u(new n([p,h,p],null)),!1,!0,!0)],null)),353:new r(353,"current_simple_time",new n([h],new f(p,!1,!0,!0))),360:new r(360,"time_to_date_utc",new n([new f(new u(new n([p,h,p],null)),!0,!1,!0),new f(new u(new n([p,p,p,p,p,p,p,p],null)),!1,!0,!0)],null)),361:new r(361,"time_to_date_local",new n([new f(new u(new n([p,h,p],null)),!0,!1,!0),new f(new u(new n([p,p,p,p,p,p,p,p],null)),!1,!0,!0)],null)),362:new r(362,"simple_time_to_date_utc",new n([p,h,new f(new u(new n([p,p,p,p,p,p,p,p],null)),!1,!0,!0)],null)),363:new r(363,"simple_time_to_date_local",new n([p,h,new f(new u(new n([p,p,p,p,p,p,p,p],null)),!1,!0,!0)],null)),364:new r(364,"date_to_time_utc",new n([new f(new u(new n([p,p,p,p,p,p,p,p],null)),!0,!1,!0),new f(new u(new n([p,h,p],null)),!1,!0,!0)],null)),365:new r(365,"date_to_time_local",new n([new f(new u(new n([p,p,p,p,p,p,p,p],null)),!0,!1,!0),new f(new u(new n([p,h,p],null)),!1,!0,!0)],null)),366:new r(366,"date_to_simple_time_utc",new n([new f(new u(new n([p,p,p,p,p,p,p,p],null)),!0,!1,!0),h],new f(p,!1,!0,!0))),367:new r(367,"date_to_simple_time_local",new n([new f(new u(new n([p,p,p,p,p,p,p,p],null)),!0,!1,!0),h],new f(p,!1,!0,!0))),4352:new r(4352,"garglk_set_zcolors",new n([h,h],null)),4353:new r(4353,"garglk_set_zcolors_stream",new n([v,h,h],null)),4354:new r(4354,"garglk_set_reversevideo",new n([h],null)),4355:new r(4355,"garglk_set_reversevideo_stream",new n([v,h],null))};function x(e,t,r){return e instanceof a?t?e.signed?r+" & 0xFFFFFFFF":r:"0":e instanceof o?t?e.signed?"self.cast_signed_char("+r+")":r+" & 0xFF":"0":e instanceof l?t?'self.class_obj_from_id("'+e.name+'", '+r+")":"null":"???"}function U(e,t){return e instanceof a?t+" >>> 0":e instanceof o?e.signed?"self.uncast_signed_char("+t+")":t+" & 0xFF":e instanceof l?'self.class_obj_to_id("'+e.name+'", '+t+")":"???"}function C(e){return 128&(e&=255)&&(e+=4294967040),e}function S(e,t){return t?t.disprock:0}function M(e,t){return 0!=t&&t?D[e][t]:null}e.arg_int_unsigned=h,e.arg_int_signed=p,e.arg_char_unsigned=_,e.arg_char_native=g,e.arg_char_signed=m,e.cast_signed_char=function(e){return 128&(e&=255)&&(e-=256),e},e.uncast_signed_char=C,e.class_obj_to_id=S,e.class_obj_from_id=M;var j={};var G=null,T=null,z=-1;e.set_blocked_selector=function(e,t){G=e,T=t.slice(0)};var q=[];e.temp_arg_arrays=q;var A=[];e.retained_arrays=A,e.make_arg_array=function(e,t,r,n){var i;e&&(i={arr:e,addr:t,len:r,arg:n},q.push(i))};var F,D={};return function(){var e;for(e in F=1+Math.round(1e3*Math.random()),t)D[t[e]]={}}(),{set_vm:function(t){e.VM=t},get_function:function(t){var r,n=j[t];if(void 0===n){if(void 0===(r=y[t]))throw new Error("dispatch: unknown Glk function: "+t);n=function(t){var r,n,d,h,p,_,g,m,w,v,b,k,y,C,S=[],M={},j=0;for(S.push("// no local vars"),S.push("// "+t.id+": "+t.name),h=null,(d=t.proto).retarg&&(h=d.retarg.arg),S.push("var self = this;"),C=Glk.call_may_not_return(t.id),p=0,_=[],r=0;r<d.args.length;r++)if(m=d.args[r],v="glka"+r,_.push(v),M[v]=!0,m instanceof a||m instanceof o||m instanceof l)b=x(m,!0,"callargs["+p+"]"),S.push(v+" = "+b+";"),p+=1;else if(m instanceof f){if(w=m.arg,S.push("if (callargs["+p+"] == 0) {"),m.nonnull?S.push('  throw new Error("glk '+t.name+': null argument");'):S.push("  "+v+" = null;"),S.push("} else {"),w instanceof a||w instanceof o||w instanceof l)S.push("  "+v+" = new Glk.RefBox();"),b=x(w,m.passin,"self.VM.ReadWord(callargs["+p+"])"),S.push("  "+v+".set_value("+b+");");else{if(!(w instanceof u))throw new Error("buildfunc: unsupported refarg type: "+t.name);for(g=w.form.args,S.push("  "+v+" = new Glk.RefStruct("+g.length+");"),n=0;n<g.length;n++)b=x(g[n],m.passin,"self.VM.ReadStructField(callargs["+p+"], "+n+")"),S.push("  "+v+".push_field("+b+");")}S.push("}"),p+=1}else if(m instanceof c)M.glklen=!0,w=m.arg,S.push("if (callargs["+p+"] == 0) {"),m.nonnull?S.push('  throw new Error("glk '+t.name+': null argument");'):S.push("  "+v+" = null;"),S.push("} else {"),S.push("  glklen = callargs["+(p+1)+"];"),S.push("  "+v+" = Array(glklen);"),m.passin&&(M.ix=!0,M.jx=!0,S.push("  for (ix=0, jx=callargs["+p+"]; ix<glklen; ix++, jx+="+w.refsize+") {"),b=x(w,!0,"self.VM.Read"+w.macro+"(jx)"),S.push("    "+v+"[ix] = "+b+";"),S.push("  }")),m.retained&&(0==j&&S.push("  self.temp_arg_arrays.length = 0;"),j+=1,S.push("  self.make_arg_array("+v+", callargs["+p+"], glklen, self."+w.literal+");")),S.push("}"),p+=2;else{if(!(m instanceof i||m instanceof s))throw new Error("buildfunc: unsupported arg type: "+t.name);var G,T;M.ix=!0,M.jx=!0,m instanceof i?(T="0xE0",G="byte_array_to_string"):(T="0xE2",G="uni_array_to_string"),S.push(v+" = Array();"),S.push("jx = callargs["+p+"];"),S.push("if (self.VM.ReadByte(jx) != "+T+') throw new Error("glk '+t.name+': string argument must be unencoded");'),S.push("for (jx+="+m.refsize+"; true; jx+="+m.refsize+") {"),S.push("  ix = self.VM.Read"+m.macro+"(jx);"),S.push("  if (ix == 0) break;"),S.push("  "+v+".push(ix);"),S.push("}"),S.push(v+" = Glk."+G+"("+v+");"),p+=1}for(S.push("if (callargs.length != "+p+') throw "glk '+t.name+': wrong number of arguments";'),h||C?(M.glkret=!0,k="glkret = "):k="",S.push(k+("Glk.glk_"+t.name).replace("glk_gar","gar")+"("+_.join(", ")+");"),C&&(S.push("if (glkret === Glk.DidNotReturn) {"),S.push("  self.set_blocked_selector("+t.id+", callargs);"),S.push("  return glkret;"),S.push("}")),p=0,r=0;r<d.args.length;r++)if(v="glka"+r,(m=d.args[r])instanceof a||m instanceof o||m instanceof l)p+=1;else if(m instanceof f){if(w=m.arg,m.passout){if(S.push("if ("+v+") {"),w instanceof a||w instanceof o||w instanceof l)b=U(w,v+".get_value()"),S.push("  self.VM.WriteWord(callargs["+p+"], "+b+");");else{if(!(w instanceof u))throw new Error("buildfunc: unsupported refarg type: "+t.name);for(g=w.form.args,n=0;n<g.length;n++)b=U(g[n],v+".get_field("+n+")"),S.push("  self.VM.WriteStructField(callargs["+p+"], "+n+", "+b+");")}S.push("}")}p+=1}else if(m instanceof c)w=m.arg,m.passout&&!m.retained&&(S.push("if ("+v+") {"),M.ix=!0,M.jx=!0,S.push("  for (ix=0, jx=callargs["+p+"]; ix<glklen; ix++, jx+="+w.refsize+") {"),b=U(w,v+"[ix]"),S.push("    self.VM.Write"+w.macro+"(jx, "+b+")"),S.push("  }"),S.push("}")),p+=2;else{if(!(m instanceof i||m instanceof s))throw new Error("buildfunc: unsupported arg type: "+t.name);p+=1}for(b in 0!=j&&S.push("self.temp_arg_arrays.length = 0;"),h?(b=U(h,"glkret"),S.push("return "+b+";")):S.push("return 0;"),y=[],M)y.push(b);return y.length&&(S[0]="var "+y.join(", ")+";"),b=S.join("\n"),new Function("callargs",b).bind(e)}(r),j[t]=n}return n},prepare_resume:function(t){192==G?0!=T[0]&&(z=t.get_field(0)>>>0,e.VM.WriteStructField(T[0],0,t.get_field(0)>>>0),e.VM.WriteStructField(T[0],1,S(0,t.get_field(1))),e.VM.WriteStructField(T[0],2,t.get_field(2)>>>0),e.VM.WriteStructField(T[0],3,t.get_field(3)>>>0)):98==G&&e.VM.SetResumeStore(S(0,t)),G=null,T=null},check_autosave:function(){return 192==G&&T&&T.length>0&&(2==z||3==z||4==z||8==z)?T[0]:null},class_register:function(e,t,r){if(void 0===r){if(t.disprock)throw new Error("class_register: object is already registered");t.disprock=F,F++}else{if(t.disprock!=r)throw new Error("class_register: object is not already registered");F<=r&&(F=r+1)}D[e][t.disprock]=t},class_unregister:function(e,t){if(!t.disprock||void 0===D[e][t.disprock])throw new Error("class_unregister: object is not registered");delete D[e][t.disprock],t.disprock=void 0},class_obj_to_id:S,class_obj_from_id:M,retain_array:function(e,t){var r,n;if(e){if(void 0!==t){if(e!==t.arr)throw new Error("retain_array: array does not match useobj");if((n={addr:t.addr,len:t.len,arr:e,arg:d(t.arg)}).len!=e.length)throw new Error("retain_array: array length from useobj does not match")}else for(n=void 0,r=0;r<q.length;r++)if(q[r].arr===e){n=q[r];break}if(void 0===n)throw new Error("retain_array: array is not an argument");for(r=0;void 0!==A[r];r++);A[r]=n}},unretain_array:function(t){var r,n,i;if(t){for(i=void 0,r=0;r<A.length;r++)if(void 0!==A[r]&&A[r].arr===t){i=A[r],delete A[r];break}if(void 0===i)throw new Error("unretain_array: array was never retained");if(i.arg instanceof a)for(r=0,n=i.addr;r<i.len;r++,n+=4)e.VM.WriteWord(n,i.arr[r]>>>0);else{if(!(i.arg instanceof o))throw new Error("unretain_array: unsupported refarg type");if(i.arg.signed)for(r=0,n=i.addr;r<i.len;r++,n++)e.VM.WriteByte(n,C(i.arr[r]));else for(r=0,n=i.addr;r<i.len;r++,n++)e.VM.WriteByte(n,255&i.arr[r])}}},get_retained_array:function(e){var t;for(t=0;t<A.length;t++)if(void 0!==A[t]&&A[t].arr===e)return A[t];return null}}}();try{t.GiDispa=r}catch(e){}},function(e,t){var r=function(){var e,t,r={vm:null,io:null,spacing:4,use_query_story:!0,default_story:null,set_page_title:!0,default_page_title:"Game",game_format_name:"",exit_warning:"The game session has ended.",image_info_map:null,proxy_url:"https://zcode.appspot.com/proxy/"},n=null,i={},s=null,o={},a={};function l(e){if(e.match(/^(file|data|http|https):/i))return e;var t=document.createElement("div");return t.innerHTML="<a></a>",t.firstChild.href=e,t.innerHTML=t.innerHTML,t.firstChild.href}function u(e){if(null!=r.image_info_map&&(n=r.image_info_map[e]))return n;var t=o["Pict:"+e];if(t){var n={image:e};if("JPEG"==t.type?n.type="jpeg":"PNG "==t.type?n.type="png":n.type="????",void 0===t.imagesize){var i=void 0;"JPEG"==t.type?i=function(e){var t=0;for(;t<e.length;){if(255!=e[t])return void GlkOte.log("find_dimensions_jpeg: marker is not 0xFF");for(;255==e[t];)t+=1;var r=e[t];if(t+=1,!(1==r||r>=208&&r<=217)){var n=e[t+0]<<8|e[t+1];if(r>=192&&r<=207&&200!=r){if(n<7)return void GlkOte.log("find_dimensions_jpeg: SOF block is too small");var i={};return i.height=e[t+3]<<8|e[t+4],i.width=e[t+5]<<8|e[t+6],i}t+=n}}return void GlkOte.log("find_dimensions_jpeg: no SOF marker found")}(t.content):"PNG "==t.type&&(i=function(e){var t=0;if(137!=e[0]||"PNG"!=String.fromCharCode.apply(this,e.slice(1,4)))return void GlkOte.log("find_dimensions_png: PNG signature does not match");t+=8;for(;t<e.length;){var r=e[t+0]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3];t+=4;var n=String.fromCharCode.apply(this,e.slice(t,t+4));if(t+=4,"IHDR"==n){var i={};return i.width=e[t+0]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],t+=4,i.height=e[t+0]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],t+=4,i}t+=r,t+=4}return void GlkOte.log("find_dimensions_png: no PNG header block found")}(t.content)),i&&(t.imagesize=i)}t.imagesize&&(n.width=t.imagesize.width,n.height=t.imagesize.height);var s=a["Pict:"+e];return s&&(n.alttext=s),n}}function f(e){var t,r=Array(e.length);for(t=0;t<e.length;t++)r[t]=255&e.charCodeAt(t);return r}function c(e){for(var t,r=[],n=0;n<e.length;){var i,s,o,a;if(n>=e.length)break;if(i=e[n],n++,i<128)t=i;else{if(n>=e.length)break;if(s=e[n],n++,128!=(192&s))break;if(192==(224&i))t=(31&i)<<6,t|=63&s;else{if(n>=e.length)break;if(o=e[n],n++,128!=(192&o))break;if(224==(240&i))t=(15&i)<<12&61440,t|=(63&s)<<6&4032,t|=63&o;else{if(240!=(240&i))break;if(n>=e.length)break;if(a=e[n],n++,128!=(192&a))break;t=(7&i)<<18&1835008,t|=(63&s)<<12&258048,t|=(63&o)<<6&4032,t|=63&a}}}r.push(t)}return String.fromCharCode.apply(this,r)}if(window.atob)t=function(e){var t,r=atob(e),n=Array(r.length);for(t=0;t<r.length;t++)n[t]=r.charCodeAt(t);return n};else{var d=function(){var e,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",r=[];for(e=0;e<t.length;e++)r[t.charAt(e)]=e;return r}();t=function(e){for(var t,r,n,i,s,o,a=[],l=0,u=e.length;l<u;)t=(d[e.charAt(l++)]<<2)+((i=d[e.charAt(l++)])>>4),r=((15&i)<<4)+((s=d[e.charAt(l++)])>>2),n=((3&s)<<6)+(o=d[e.charAt(l++)]),a.push(t,r,n);return 64==o&&a.pop(),64==s&&a.pop(),a}}function h(e){if(0!=e.length){if(70==e[0]&&79==e[1]&&82==e[2]&&77==e[3]){var t=String.fromCharCode(e[8],e[9],e[10],e[11]);if("IFZS"==t)return void r.io.fatal_error("This is a saved-game file, not a "+r.game_format_name+" game file. You must launch the game first, then restore your save.");if("IFRS"!=t)return void r.io.fatal_error("This IFF file is not a Blorb file!");if(r.blorb_gamechunk_type)try{e=function(e,t){for(var n,l=e.length,u=[],f=null,d=12;d<l;){var h=String.fromCharCode(e[d+0],e[d+1],e[d+2],e[d+3]),p=e[(d+=4)+0]<<24|e[d+1]<<16|e[d+2]<<8|e[d+3];if(d+=4,"RIdx"==h){var _=e[(y=d)+0]<<24|e[y+1]<<16|e[y+2]<<8|e[y+3];for(y+=4,n=0;n<_;n++){var g=String.fromCharCode(e[y+0],e[y+1],e[y+2],e[y+3]),m=e[(y+=4)+0]<<24|e[y+1]<<16|e[y+2]<<8|e[y+3],w=e[(y+=4)+0]<<24|e[y+1]<<16|e[y+2]<<8|e[y+3];y+=4,u.push({usage:g,num:m,pos:w})}}if("IFmd"==h){var v=c(k=e.slice(d,d+p)),b=$("<metadata>").html(v).find("bibliographic").children();if(b.length)for(n=0;n<b.length;n++)j=b[n],i[j.tagName.toLowerCase()]=j.textContent}if("Dbug"==h&&r.debug_info_chunk){var k=e.slice(d,d+p);s=k}if("RDes"==h){var y,x=e[(y=d)+0]<<24|e[y+1]<<16|e[y+2]<<8|e[y+3];for(y+=4,n=0;n<x;n++){var U=String.fromCharCode.apply(this,e.slice(y,y+4)),C=e[(y+=4)+0]<<24|e[y+1]<<16|e[y+2]<<8|e[y+3],S=e[(y+=4)+0]<<24|e[y+1]<<16|e[y+2]<<8|e[y+3];y+=4;var M=c(e.slice(y,y+S));y+=S,a[U+":"+C]=M}}1&(d+=p)&&d++}for(n=0;n<u.length;n++){var j;d=(j=u[n]).pos;h=String.fromCharCode(e[d+0],e[d+1],e[d+2],e[d+3]),p=e[(d+=4)+0]<<24|e[d+1]<<16|e[d+2]<<8|e[d+3];d+=4,j.type=h,j.len=p,j.content=null,"Exec"==j.usage&&0==j.num&&h==t?f=e.slice(d,d+p):(j.content="FORM"==h?e.slice(d-8,d+p):e.slice(d,d+p),o[j.usage+":"+j.num]=j)}return f}(e,r.blorb_gamechunk_type)}catch(e){return void r.io.fatal_error("Blorb file could not be parsed: "+e)}if(!e)return void r.io.fatal_error("Blorb file contains no "+r.game_format_name+" game!")}var l=null;i&&(l=i.title),!l&&n&&(l=n.slice(n.lastIndexOf("/")+1)),l||(l=r.default_page_title),l||(l="Game"),r.recording_label||(r.recording_label=l),r.set_page_title&&(document.title=l+" - "+r.engine_name),r.vm.prepare(e,r),r.io.init(r)}else r.io.fatal_error("No game file was loaded. (Zero-length response.)")}return e=window.btoa?function(e){for(var t=[],r=e.length,n=0;n<r;n+=16384)t.push(String.fromCharCode.apply(String,e.slice(n,n+16384)));return btoa(t.join(""))}:function(e){for(var t,r,n,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",s=[],o=0;o<e.length;o+=3)t=e[o],r=e[o+1],n=e[o+2],s.push(i.charAt(t>>2&63)),s.push(i.charAt(t<<4&48|r>>4&15)),s.push(i.charAt(r<<2&60|n>>6&3)),s.push(i.charAt(63&n));return void 0===r&&s.length>=2&&(s[s.length-2]="="),void 0===n&&s.length>=1&&(s[s.length-1]="="),s.join("")},{load_run:function(e,i,s){s?"string"==typeof s&&(s={format:s}):s={};var o=s.format;if(o||(o="array"),r.io=window.Glk,r.vm=window.Quixe,e||(e=window.game_options),!e||!window.Quixe||e.vm&&e.vm!==window.Quixe||(r.engine_name="Quixe",r.blorb_gamechunk_type="GLUL",r.game_format_name="Glulx"),e&&jQuery.extend(r,e),null!=r.image_info_map&&"string"===jQuery.type(r.image_info_map)&&(window[r.image_info_map]?r.image_info_map=window[r.image_info_map]:delete r.image_info_map),n=null,r.use_query_story){var a=function(){var e={},t=location.search.substring(1,location.search.length);if(t.length){var r=t.split("&");t=t.replace(/\+/g," ");for(var n=0;n<r.length;n++){var i=r[n].split("="),s=decodeURIComponent(i[0]),o=2==i.length?decodeURIComponent(i[1]):s;e[s]=o}}return e}();n=a.story}if(n||!i)if(n||(n=r.default_story),n){i=null;var u=new XMLHttpRequest,c=void 0!==u.overrideMimeType,d=void 0!==u.withCredentials;u=null;var p=/^(file:|(\w+:)?\/\/[^\/?#]+)/,_=p.exec(location)[0],g=p.exec(n),m=!g,w=g?g[0]:_,v=_==w;navigator.userAgent.match(/chrome/i)&&"file:"==w&&(v=!1);var b=n.match(/[.]js$/i);if(GlkOte.log("GiLoad: is_relative="+m+", same_origin="+v+", binary_supported="+c+", crossorigin_supported="+d),b&&v)return GlkOte.log("GiLoad: trying old-fashioned load..."),window.processBase64Zcode=function(e){h(t(e))},void jQuery.ajax(n,{type:"GET",dataType:"script",cache:!0,error:function(e,t,i){r.io.fatal_error("The story could not be loaded. ("+n+"): Error "+t+": "+i)}});if(b){if(GlkOte.log("GiLoad: trying script load..."),window.processBase64Zcode=function(e){h(t(e))},!(x=$("head")).length)return void r.io.fatal_error("This page has no <head> element!");var k=$("<script>",{src:n,type:"text/javascript"});x.get(0).appendChild(k.get(0))}else{if(c&&v)return GlkOte.log("GiLoad: trying binary load..."),void jQuery.ajax(n,{type:"GET",beforeSend:function(e,t){e.overrideMimeType("text/plain; charset=x-user-defined")},success:function(e,t,r){h(f(e))},error:function(e,t,i){r.io.fatal_error("The story could not be loaded. ("+n+"): Error "+t+": "+i)}});if("file:"!=w){var y=n;if(m&&(y=l(n),GlkOte.log("GiLoad: absolutize "+n+" to "+y)),d)return GlkOte.log("GiLoad: trying proxy load... ("+r.proxy_url+")"),void jQuery.ajax(r.proxy_url,{type:"GET",data:{encode:"base64",url:y},error:function(e,t,i){r.io.fatal_error("The story could not be loaded. ("+n+"): Error "+t+": "+i)},success:function(e,r,n){h(t(e))}});var x,U=r.proxy_url+"?encode=base64&callback=processBase64Zcode&url="+y;if(GlkOte.log("GiLoad: trying proxy-script load... ("+U+")"),window.processBase64Zcode=function(e){h(t(e))},(x=$("head")).length){k=$("<script>",{src:U,type:"text/javascript"});x.append(k)}else r.io.fatal_error("This page has no <head> element!")}else r.io.fatal_error("The story could not be loaded. ("+n+"): A local file cannot be sent to the proxy.")}}else r.io.fatal_error("No story file specified!");else{switch(GlkOte.log("GiLoad: trying pre-loaded load ("+o+")..."),o){case"base64":i=t(i);break;case"raw":i=f(i);break;case"array":break;default:return void r.io.fatal_error("Could not decode story file data: "+o)}h(i)}},find_data_chunk:function(e){var t=o["Data:"+e];if(!t)return null;var r=t.type;return"FORM"==r&&(r="BINA"),{data:t.content,type:r}},get_metadata:function(e){return i[e]},get_debug_info:function(){return s},get_image_info:u,get_image_url:function(t){if(r.image_info_map){var n=r.image_info_map[t];if(n&&n.url)return l(n.url)}var i=o["Pict:"+t];if(i){if(i.dataurl)return i.dataurl;if(u(t)&&i.content){var s="application/octet-stream";"JPEG"==i.type?s="image/jpeg":"PNG "==i.type&&(s="image/png");var a=e(i.content);return i.dataurl="data:"+s+";base64,"+a,i.dataurl}}}}}();try{t.GiLoad=r}catch(e){}},function(e,t,r){"use strict";var n=r(0),i=n.MemoryView,s=n.Class.subClass({init:function(e){if(this.type="",this.chunks=[],e){var t,r,n=i(e),s=12;if("FORM"!==n.getFourCC(0))throw new Error("Not an IFF file");for(this.type=n.getFourCC(8),t=n.getUint32(4)+8;s<t;){if((r=n.getUint32(s+4))<0||r+s>t)throw new Error("IFF chunk out of range");this.chunks.push({type:n.getFourCC(s),offset:s,data:n.getUint8Array(s+8,r)}),s+=8+r,r%2&&s++}}},write:function(){for(var e,t,r=12,n=0,s=12;n<this.chunks.length;)this.chunks[n].data.buffer&&(this.chunks[n].data=this.chunks[n].data.buffer),this.chunks[n].length=this.chunks[n].data.byteLength||this.chunks[n].data.length,(r+=8+this.chunks[n++].length)%2&&r++;for((e=i(r)).setFourCC(0,"FORM"),e.setUint32(4,r-8),e.setFourCC(8,this.type),n=0;n<this.chunks.length;)t=this.chunks[n++],e.setFourCC(s,t.type),e.setUint32(s+4,t.length),e.setUint8Array(s+8,t.data),(s+=8+t.length)%2&&s++;return e.buffer}}),o=s.subClass({init:function(e){if(this.super.init.call(this,e),e){if("IFRS"!==this.type)throw new Error("Not a Blorb file");if("RIdx"!==this.chunks[0].type)throw new Error("Malformed Blorb: chunk 1 is not RIdx");for(var t=i(this.chunks[0].data),r=4;r<this.chunks[0].data.length;){if("Exec"===t.getFourCC(r)&&0===t.getUint32(r+4))return void(this.exec=this.chunks.filter((function(e){return e.offset===t.getUint32(r+8)}))[0]);r+=12}}}}),a=s.subClass({init:function(e){if(this.super.init.call(this,e),e){if("IFZS"!==this.type)throw new Error("Not a Quetzal savefile");for(var t,r,n,s=0;s<this.chunks.length;)t=this.chunks[s].type,r=this.chunks[s++].data,"CMem"===t||"UMem"===t?(this.memory=r,this.compressed="CMem"===t):"Stks"===t?this.stacks=r:"IFhd"===t&&(n=i(r.buffer),this.release=n.getUint16(0),this.serial=n.getUint8Array(2,6),this.checksum=n.getUint16(8),this.pc=16777215&n.getUint32(9))}},write:function(){this.type="IFZS";var e=i(13);return e.setUint16(0,this.release),e.setUint8Array(2,this.serial),e.setUint32(9,this.pc),e.setUint16(8,this.checksum),this.chunks=[{type:"IFhd",data:e},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this.super.write.call(this)}});e.exports={IFF:s,Blorb:o,Quetzal:a,identify:function(e){var t,r,n,s=i(e);if("FORM"===s.getFourCC(0)&&"IFRS"===s.getFourCC(8)?(t=new o(e)).exec&&(r=t.exec.type,e=t.exec.data,"GLUL"===r&&(n=(s=i(e)).getUint32(4)),"ZCOD"===r&&(n=e[0])):"Glul"===s.getFourCC(0)?(r="GLUL",n=s.getUint32(4)):(n=s.getUint8(0))>0&&n<9&&(r="ZCOD"),r&&n)return{format:r,version:n,data:e}}}},function(e,t,r){"use strict";var n=r(0),i=n.Class,s=n.U2S16,o=i.subClass({init:function(e,t){this.e=e,this.v=t},toString:function(){return this.v},U2S:function(){return s(this.v)}}),a=o.subClass({toString:function(){var e=this.v;return this.indirect?"e.indirect("+e+")":0===e?"s[--e.sp]":--e<15?"l["+e+"]":"e.m.getUint16("+(this.e.globals+2*(e-15))+")"},store:function(e){var t=this.v;return this.indirect?"e.indirect("+t+","+e+")":this.returnval?"e.variable("+t+","+e+")":0===t?"t="+e+";s[e.sp++]=t":--t<15?"l["+t+"]="+e:"e.ram.setUint16("+(this.e.globals+2*(t-15))+","+e+")"},U2S:function(){return"e.U2S("+this+")"}}),l=i.subClass({init:function(e,t,r,n,i,s){this.e=e,this.context=t,this.code=r,this.pc=n,this.labels=[this.pc+"/"+this.code],this.next=i,this.operands=s,this.post&&this.post()},toString:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(e){return this.operands.join(e)},label:function(){return"/* "+this.labels.join()+" */ "}}),u=l.subClass({stopper:1}),f=u.subClass({post:function(){this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return"e.stop=1;e.pc="+this.next+";"+this.origfunc.apply(this,arguments)}}),c=f.subClass({storer:1,post:function(){this.storer=this.operands.pop(),this.origfunc=this.func,this.func=this.newfunc}}),d=i.subClass({init:function(e,t){this.ops=e||[],this.code=t||"||"},toString:function(){for(var e,t=0,r=[];t<this.ops.length;)e=this.ops[t++],r.push(e.func?(e.iftrue?"":"!(")+e.func.apply(e,e.operands)+(e.iftrue?"":")"):e);return(this.invert?"(!(":"(")+r.join(this.code)+(this.invert?"))":")")}}),h=l.subClass({brancher:1,keyword:"if",post:function(){var e,t,r=this.operands.pop(),n=r[1];this.iftrue=r[0],0===n||1===n?e="e.ret("+n+")":(n+=this.next-2,this.context.targets.push(n),e="e.pc="+n),this.result=e+";return",this.offset=n,this.cond=new d([this]),this.context.ops.length&&((t=this.context.ops.pop()).offset===n?(this.cond.ops.unshift(t.cond),this.labels=t.labels,this.labels.push(this.pc+"/"+this.code)):this.context.ops.push(t))},toString:function(){var e=this.result;return e instanceof w&&(this.e.options.debug&&(e.context=this.context),e+=e.stopper?"; return":"",this.result.ops.length>1&&(e="\n"+e+"\n",this.e.options.debug&&(e+=this.context.spacer))),this.label()+this.keyword+this.cond+" {"+e+"}"}}),p=h.subClass({storer:1,post:function(){p.super.post.call(this),this.storer=this.operands.pop(),this.storer.returnval=1,this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return this.storer.store(this.origfunc.apply(this,arguments))}}),_=l.subClass({storer:1,post:function(){this.storer=this.operands.pop()},toString:function(){var e=_.super.toString.call(this);return this.storer?this.storer.store(e):e}}),g=u.subClass({result:{v:-1},toString:function(){return this.label()+"e.call("+this.operands.shift()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),m=g.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),w=i.subClass({init:function(e,t){this.e=e,this.pc=t,this.pre=[],this.ops=[],this.post=[],this.targets=[],e.options.debug&&(this.spacer="")},toString:function(){return this.e.options.debug?(this.context&&(this.spacer=this.context.spacer+"  "),this.pre.join("")+(this.ops.length>1?this.spacer:"")+this.ops.join(";\n"+this.spacer)+this.post.join("")):this.pre.join("")+this.ops.join(";")+this.post.join("")}}),v=w.subClass({toString:function(){return this.pre.unshift("var l=e.l,s=e.s,t=0;\n"),v.super.toString.call(this)}});e.exports={Operand:o,Variable:a,Opcode:l,Stopper:u,Pauser:f,PauserStorer:c,BrancherLogic:d,Brancher:h,BrancherStorer:p,Storer:_,Caller:g,CallerStorer:m,Context:w,RoutineContext:v,opcode_builder:function(e,t,r){return r=r||{},t&&(r.func=t),e.subClass(r)}}},function(e,t,r){"use strict";var n=r(0),i=r(4),s={stack_len:1e5,undo_len:1e6},o={init:function(){this.jit={},this.init=this.start},prepare:function(e,t){if(!t.Glk)throw new Error("A reference to Glk is required");this.Glk=t.Glk,this.data=e,this.options=n.extend({},s,t)},start:function(){var e,t=this.Glk;try{if(e=i.identify(this.data),delete this.data,!e||"ZCOD"!==e.format)throw new Error("This is not a Z-Code file");if([3,4,5,8].indexOf(e.version)<0)throw new Error("Unsupported Z-Machine version: "+e.version);this.m=n.MemoryView(e.data),this.staticmem=this.m.getUint16(14),this.ram=n.MemoryView(this.m,0,this.staticmem),this.origram=this.m.getUint8Array(0,this.staticmem);let r,s="",o=0;for(;o<30;)s+=(this.origram[o]<16?"0":"")+this.origram[o++].toString(16);this.signature=s;const a=this.options.Dialog;if(a)if(this.options.clear_vm_autosave)a.autosave_write(s,null);else if(this.options.do_vm_autosave)try{const e=a.autosave_read(s);e&&(this.do_autorestore(e),r=1)}catch(e){this.log("Autorestore failed, deleting it"),a.autosave_write(s,null)}r||(this.restart(),this.run()),this.quit||(this.glk_event=new t.RefStruct,this.glk_blocking_call?this.glk_event.push_field(this.glk_blocking_call):t.glk_select(this.glk_event)),t.update()}catch(e){t.fatal_error(e),console.log(e)}},resume:function(e){var t,r,n=this.Glk,i=this.glk_event;try{2===(t=i.get_field(0))&&(this.handle_char_input(i.get_field(2)),r=1),3===t&&(this.handle_line_input(i.get_field(2),i.get_field(3)),r=1),5===t&&this.update_screen_size(),"fileref_create_by_prompt"===t&&(r=this.handle_create_fileref(e)),this.glk_blocking_call=null,r&&this.run(),this.quit||(this.glk_event=new n.RefStruct,this.glk_blocking_call?this.glk_event.push_field(this.glk_blocking_call):n.glk_select(this.glk_event)),n.update()}catch(e){n.fatal_error(e),console.log(e)}},get_signature:function(){return this.signature},run:function(){var e,t;for(this.stop=0;!this.stop;)e=this.pc,this.jit[e]||this.compile(),t=this.jit[e](this),isNaN(t)||this.ret(t)},compile:function(){var e=this.disassemble();this.jit[e.pc]=new Function("e",""+e),e.pc<this.staticmem&&this.log("Caching a JIT function in dynamic memory: "+e.pc)}},a=n.Class.subClass(n.extend(o,r(9),r(11),r(12),r(13)));e.exports=a},function(e,t,r){const n={serialize:()=>({})};class i{constructor(){this.class_map={fileref:{},stream:{},window:{}},this.last_used_id=101}check_autosave(){return!this.vm.glk_blocking_call}class_obj_from_id(e,t){return this.class_map[e][t]}class_register(e,t,r){if(r){if(t.disprock!==r)throw new Error("class_register: object is not already registered");this.last_used_id<=r&&(this.last_used_id=r+1)}else{if(t.disprock)throw new Error("class_register: object is already registered");t.disprock=this.last_used_id++}this.class_map[e][t.disprock]=t}class_unregister(e,t){if(!t.disprock||null==this.class_map[e][t.disprock])throw new Error("class_unregister: object is not registered");delete this.class_map[e][t.disprock],t.disprock=null}get_retained_array(e){return{arg:n,arr:e.slice(),len:e.length}}prepare_resume(){}retain_array(){}set_vm(e){this.vm=e}unretain_array(){}}e.exports&&(e.exports=i),"undefined"!=typeof window&&(window.GiDispa=new i)},function(e,t){var r=function(){var e={};function t(e){if("string"==typeof e)return e;var t=e.toString();return e.message&&(t=t+" "+e.message),e.fileName&&(t=t+" "+e.fileName),e.lineNumber&&(t=t+" line:"+e.lineNumber),e.name&&(t=t+" "+e.name),e.number&&(t=t+" "+e.number),t}function r(e){window.console&&console.log?console.log(e):window.opera&&opera.postError&&opera.postError(e)}function n(){if(ye&&ye.length){var e,t,n,i,s=[];for(e=0;e<ye.length;e++)(i=ye[e]).vmfunc.funcaddr?(t="0x"+i.vmfunc.funcaddr.toString(16),(n=at.functionmap[i.vmfunc.funcaddr])&&(t=t+' "'+n.name+'"'),s.push(t)):s.push("(anonymous)");r("VM stack dump: "+s.join(", "))}}void 0===Math.imul&&(r("Polyfilling Math.imul()."),Math.imul=function(e,t){var r=65535&e,n=65535&t;return r*n+((e>>>16&65535)*n+r*(t>>>16&65535)<<16>>>0)|0});var i=Array(256),s=Array(256);function o(e,t){return 16777216*e[t]+65536*e[t+1]+256*e[t+2]+e[t+3]}function a(e,t){return 256*e[t]+e[t+1]}function l(e,t){return e[t]}function u(e){return ke[e]}function f(e){return 256*ke[e]+ke[e+1]}function c(e){return 16777216*ke[e]+65536*ke[e+1]+256*ke[e+2]+ke[e+3]}function d(e,t){return ke.slice(e,e+t)}function h(e,t){ke[e]=255&t}function p(e,t){ke[e]=t>>8&255,ke[e+1]=255&t}function _(e,t){ke[e]=t>>24&255,ke[e+1]=t>>16&255,ke[e+2]=t>>8&255,ke[e+3]=255&t}function g(e,t){for(var r=0;r<t.length;r++)e.push(t.charCodeAt(r))}function m(e,t){e.push(t>>24&255),e.push(t>>16&255),e.push(t>>8&255),e.push(255&t)}function w(e,t){e.push(t>>8&255),e.push(255&t)}function v(e,t){e.push(255&t)}function b(e,t,r){return String.fromCharCode.apply(this,e.slice(t,t+r))}function k(e){return ke[e]>=128?"0xffffff"+i[ke[e]]:"0x"+i[ke[e]]}function y(e){return ke[e]>=128?"0xffff"+i[ke[e]]+i[ke[e+1]]:ke[e]?"0x"+i[ke[e]]+i[ke[e+1]]:"0x"+i[ke[e+1]]}function x(e){return ke[e]?"0x"+i[ke[e]]+i[ke[e+1]]+i[ke[e+2]]+i[ke[e+3]]:ke[e+1]?"0x"+i[ke[e+1]]+i[ke[e+2]]+i[ke[e+3]]:ke[e+2]?"0x"+i[ke[e+2]]+i[ke[e+3]]:"0x"+i[ke[e+3]]}function U(e){return e<65536?String.fromCharCode(e):(e-=65536,String.fromCharCode(55296+(e>>10),56320+(1023&e)))}function C(e){return function(e){if(e<256)return s[e];if(e<65536){for(e=e.toString(16);e.length<4;)e="0"+e;return"\\u"+e}var t;return t=55296+((e-=65536)>>10),e=56320+(1023&e),"\\u"+t.toString(16)+"\\u"+e.toString(16)}(e.charCodeAt(0))}e.Mem1=u,e.Mem2=f,e.Mem4=c,e.MemSlice=d,e.MemW1=h,e.MemW2=p,e.MemW4=_;var S=/[^a-zA-Z0-9 .,;:?!=_+()-]/g;function M(e){return'"'+(e=e.replace(S,C))+'"'}function j(e){var t,n;if(arguments.length>1){for(e+=" (",t=1;t<arguments.length;t++)1!=t&&(e+=" "),e+=n="number"==typeof(n=arguments[t])?n.toString(16):""+n;e+=")"}throw r(e),new Error(e)}function G(e,t,r,n){return void 0===t&&(t="_func"),void 0===r?new Function("self",e):void 0===n?new Function("self",r,e):new Function("self",r,n,e)}function T(e,t,r,n){var i,s;e?(this.funcaddr=e,this.startpc=t,this.functype=u(e)):(this.funcaddr=null,this.startpc=null,this.functype=null),this.pathaddrs={},this[0]={},this[1]={},this[2]={},this.locallen=null,this.localsformat=r,this.rawformat=n,this.localsindex=[];var o=0;for(i=0;i<this.localsformat.length;i++){var a=this.localsformat[i];if(4==a.size)for(;3&o;)o++;else if(2==a.size)for(;1&o;)o++;for(s=0;s<a.count;s++)this.localsindex.push({size:a.size,pos:o}),o+=a.size}for(;3&o;)o++;this.locallen=o}function z(e){var t;for(this.vmfunc=e,this.depth=null,this.framestart=null,this.framelen=null,this.valstack=[],this.localspos=null,this.localsindex=e.localsindex,this.locals=[],t=0;t<this.localsindex.length;t++){var r=this.localsindex[t];this.locals[r.pos]=0}this.framelen=8+e.rawformat.length+e.locallen}function q(e,t){m(t,e.framelen);var r=e.vmfunc.rawformat;m(t,8+r.length);for(var n=0;n<r.length;n++)t.push(r[n]);for(n=0;n<e.vmfunc.localsindex.length;n++){var i=e.vmfunc.localsindex[n];if(4==i.size){for(;3&t.length;)t.push(0);m(t,e.locals[i.pos])}else if(2==i.size){for(;1&t.length;)t.push(0);w(t,e.locals[i.pos])}else v(t,e.locals[i.pos])}for(;3&t.length;)t.push(0);for(n=0;n<e.valstack.length;n++)m(t,e.valstack[n])}function A(e){var t=o(e,e.length-4);if(!(t<0||t>=e.length)){for(var n=o(e=e.splice(t,e.length),0),i=o(e,4),s=e.slice(8,i),u=[],f=8;;){var c=l(e,f),d=l(e,++f);if(f++,0==c)break;1!=c&&2!=c&&4!=c&&j("Invalid local variable size in function header.",c),u.push({size:c,count:d})}var h=new z(new T(null,null,u,s));h.framestart=t;for(var p=0;p<h.vmfunc.localsindex.length;p++){var _=h.vmfunc.localsindex[p];4==_.size?h.locals[_.pos]=o(e,i+_.pos):2==_.size?h.locals[_.pos]=a(e,i+_.pos):h.locals[_.pos]=l(e,i+_.pos)}for(var g=n;g<e.length;g+=4)h.valstack.push(o(e,g));return h}r("Bad frameptr in serialized stack frame")}function F(e,t){0==e&&j("Tried to create a VMTextEnv for address zero."),this.addr=e,this.cacheable=void 0!==t,this.decoding_tree=t,this.vmstring_tables=[],this.cacheable&&(this.vmstring_tables[0]={},this.vmstring_tables[1]={},this.vmstring_tables[2]={})}e.fatal_error=j;var D=null;function $(e,t,r){var n;switch(t.mode){case 8:if(4==t.argsize){if("0"===(i=r[0]))return e.offstack.push(r),void e.code.push("// push to offstack: "+r);if("_"===i)return function(e,t){e.offstack.push(t);var r=e.holduse[t];r&&!0!==r?r++:r=1;e.holduse[t]=r}(e,r),void e.code.push("// re-push to offstack: "+r)}return n=P(e,!0),e.offstack.push(n),void(4==t.argsize?e.code.push(n+"=("+r+");"):2==t.argsize?e.code.push(n+"=0xffff&("+r+");"):e.code.push(n+"=0xff&("+r+");"));case 0:return void e.code.push("("+r+");");case 11:if(4==t.argsize){var i;if("0"===(i=r[0]))return V(e,t.addr,r,!1),void e.code.push("// store to offloc["+t.addr+"]: "+r);if("_"===i)return V(e,t.addr,r,!0),void e.code.push("// re-store to offloc["+t.addr+"]: "+r)}return V(e,t.addr,void 0),void(4==t.argsize?e.code.push("self.frame.locals["+t.addr+"]=("+r+");"):2==t.argsize?e.code.push("self.frame.locals["+t.addr+"]=(0xffff &"+r+");"):e.code.push("self.frame.locals["+t.addr+"]=(0xff &"+r+");"));case 15:return void(4==t.argsize?e.code.push("self.MemW4("+t.addr+","+r+");"):2==t.argsize?e.code.push("self.MemW2("+t.addr+","+r+");"):e.code.push("self.MemW1("+t.addr+","+r+");"));default:j("Unknown addressing mode in store func operand.")}}function L(e,t,r){void 0===r&&(r=e.cp),e.code.push("self.frame.valstack.push("+t+","+r+",self.frame.framestart);")}function I(e){e.code.push("if (!substring) { substring=true;"),e.code.push("self.frame.valstack.push(0x11,0,nextcp,self.frame.framestart);"),e.code.push("}")}function N(e,t){var r;if(e.code.push("// unload offstate: "+e.offstack.length+" stack"+(e.offloc.length?", plus locs":"")+(t?" (conditional)":"")),e.offstack.length&&e.code.push("self.frame.valstack.push("+e.offstack.join(",")+");"),e.offloc.length)for(r=0;r<e.offloc.length;r++)void 0!==e.offloc[r]&&e.offlocdirty[r]&&e.code.push("self.frame.locals["+r+"]="+e.offloc[r]+";");if(!t){var n;for(r=0;r<e.offloc.length;r++)void 0!==(n=e.offloc[r])&&void 0!==e.holduse[n]&&(e.holduse[n]=!1);for(e.offloc.length=0,e.offlocdirty.length=0;e.offstack.length;)n=e.offstack.pop(),void 0!==e.holduse[n]&&(e.holduse[n]=!1)}}function E(e){if(0!=e.buffer.length){var t=e.buffer.join("");e.buffer.length=0,e.code.push("Glk.glk_put_jstring("+M(t)+");")}}function B(e,t,r){var n;if(H(t))return 2147483648&(n=Number(t))?""+(n-4294967296):t;if(n="("+t+"&0xffffffff)",r){var i=P(e);return e.code.push(i+"="+n+";"),i}return n}function R(e,t,r){var n;if(H(t))return 2147483648==(n=Number(t))?"-0":""+ve(n);if(n="self.decode_float("+t+")",r){var i=P(e);return e.code.push(i+"="+n+";"),i}return n}function W(e,t,r){if(H(t)){var n=Number(t);if(0==n||1==n)r?(e.code.push("// quashing offstack for unconditional return: "+e.offstack.length),e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0):e.code.push("// ignoring offstack for conditional return: "+e.offstack.length),e.code.push("if (self.leave_function()) return self.VMStopped;"),e.code.push("self.pop_callstub("+n+");");else{N(e,!r);var i=e.cp+n-2>>>0;e.code.push("self.pc = "+i+";"),e.vmfunc.pathaddrs[i]=!0}}else N(e,!r),e.code.push("if (("+t+")==0 || ("+t+")==1) {"),e.code.push("if (self.leave_function()) return self.VMStopped;"),e.code.push("self.pop_callstub("+t+");"),e.code.push("}"),e.code.push("else {"),e.code.push("self.pc = ("+e.cp+"+("+t+")-2) >>>0;"),e.code.push("}");e.code.push("return;")}e.funcop_cache={};var O={0:function(e,t){},16:function(e,t){e.code.push(t[2]+"(("+t[0]+")+("+t[1]+")) >>>0);")},17:function(e,t){e.code.push(t[2]+"(("+t[0]+")-("+t[1]+")) >>>0);")},18:function(e,t){var r=B(e,t[0]),n=B(e,t[1]);e.code.push(t[2]+"(Math.imul(("+r+"),("+n+"))) >>>0);")},19:function(e,t){var r=B(e,t[0]),n=B(e,t[1]),i=P(e);e.code.push(i+"=(("+r+")/("+n+"));"),e.code.push("if (!isFinite("+i+")) self.fatal_error('Division by zero.');"),e.code.push(t[2]+"("+i+">=0)?Math.floor("+i+"):(-Math.floor(-"+i+") >>>0));")},20:function(e,t){var r=B(e,t[0]),n=B(e,t[1]),i=P(e);e.code.push(i+"=(("+r+")%("+n+"));"),e.code.push("if (!isFinite("+i+")) self.fatal_error('Modulo division by zero.');"),e.code.push(t[2]+i+" >>>0);")},21:function(e,t){e.code.push(t[1]+"(-("+t[0]+")) >>>0);")},24:function(e,t){e.code.push(t[2]+"(("+t[0]+")&("+t[1]+")) >>>0);")},25:function(e,t){e.code.push(t[2]+"(("+t[0]+")|("+t[1]+")) >>>0);")},26:function(e,t){e.code.push(t[2]+"(("+t[0]+")^("+t[1]+")) >>>0);")},27:function(e,t){e.code.push(t[1]+"(~("+t[0]+")) >>>0);")},28:function(e,t){if(H(t[1])){var r=Number(t[1]);r<32?e.code.push(t[2]+"(("+t[0]+")<<"+r+") >>>0);"):e.code.push(t[2]+"0);")}else e.code.push(t[2]+"("+t[1]+"<32) ? (("+t[0]+"<<"+t[1]+") >>>0) : 0);")},29:function(e,t){if(H(t[1])){var r=Number(t[1]);r<32?e.code.push(t[2]+"(("+t[0]+")>>"+r+") >>>0);"):e.code.push(t[2]+"(("+t[0]+")&0x80000000) ? 0xffffffff : 0);")}else e.code.push("if ("+t[0]+" & 0x80000000) {"),e.code.push(t[2]+"("+t[1]+"<32) ? (("+t[0]+">>"+t[1]+") >>>0) : 0xffffffff);"),e.code.push("} else {"),e.code.push(t[2]+"("+t[1]+"<32) ? (("+t[0]+">>"+t[1]+") >>>0) : 0);"),e.code.push("}")},30:function(e,t){if(H(t[1])){var r=Number(t[1]);r<32?e.code.push(t[2]+"("+t[0]+")>>>"+r+");"):e.code.push(t[2]+"0);")}else e.code.push(t[2]+"("+t[1]+"<32) ? ("+t[0]+">>>"+t[1]+") : 0);")},32:function(e,t){W(e,t[0],!0),e.path_ends=!0},260:function(e,t){if(H(t[0])){var r=Number(t[0]);e.code.push("self.pc = "+r+";"),e.vmfunc.pathaddrs[r]=!0}else e.code.push("self.pc = "+t[0]+";");N(e),e.code.push("return;"),e.path_ends=!0},34:function(e,t){e.code.push("if (("+t[0]+")==0) {"),W(e,t[1]),e.code.push("}")},35:function(e,t){e.code.push("if (("+t[0]+")!=0) {"),W(e,t[1]),e.code.push("}")},36:function(e,t){e.code.push("if (("+t[0]+")==("+t[1]+")) {"),W(e,t[2]),e.code.push("}")},37:function(e,t){e.code.push("if (("+t[0]+")!=("+t[1]+")) {"),W(e,t[2]),e.code.push("}")},38:function(e,t){var r=B(e,t[0]),n=B(e,t[1]);e.code.push("if (("+r+")<("+n+")) {"),W(e,t[2]),e.code.push("}")},39:function(e,t){var r=B(e,t[0]),n=B(e,t[1]);e.code.push("if (("+r+")>=("+n+")) {"),W(e,t[2]),e.code.push("}")},40:function(e,t){var r=B(e,t[0]),n=B(e,t[1]);e.code.push("if (("+r+")>("+n+")) {"),W(e,t[2]),e.code.push("}")},41:function(e,t){var r=B(e,t[0]),n=B(e,t[1]);e.code.push("if (("+r+")<=("+n+")) {"),W(e,t[2]),e.code.push("}")},42:function(e,t){e.code.push("if (("+t[0]+")<("+t[1]+")) {"),W(e,t[2]),e.code.push("}")},43:function(e,t){e.code.push("if (("+t[0]+")>=("+t[1]+")) {"),W(e,t[2]),e.code.push("}")},44:function(e,t){e.code.push("if (("+t[0]+")>("+t[1]+")) {"),W(e,t[2]),e.code.push("}")},45:function(e,t){e.code.push("if (("+t[0]+")<=("+t[1]+")) {"),W(e,t[2]),e.code.push("}")},48:function(e,t){if(H(t[1])){var r,n=Number(t[1]);for(r=0;r<n;r++)if(e.offstack.length){var i=Q(e);e.code.push("self.tempcallargs["+r+"]="+i+";")}else e.code.push("self.tempcallargs["+r+"]=self.frame.valstack.pop();");N(e)}else e.varsused.ix=!0,N(e),e.code.push("for (ix=0; ix<"+t[1]+"; ix++) { self.tempcallargs[ix]=self.frame.valstack.pop(); }");L(e,t[2]),e.code.push("self.enter_function("+t[0]+", "+t[1]+");"),e.code.push("return;"),e.path_ends=!0},52:function(e,t){if(H(t[1])){var r,n=Number(t[1]);for(r=0;r<n;r++)if(e.offstack.length){var i=Q(e);e.code.push("self.tempcallargs["+r+"]="+i+";")}else e.code.push("self.tempcallargs["+r+"]=self.frame.valstack.pop();");N(e)}else e.varsused.ix=!0,N(e),e.code.push("for (ix=0; ix<"+t[1]+"; ix++) { self.tempcallargs[ix]=self.frame.valstack.pop(); }");e.code.push("if (self.leave_function()) return self.VMStopped;"),e.code.push("self.enter_function("+t[0]+", "+t[1]+");"),e.code.push("return;"),e.path_ends=!0},352:function(e,t){N(e),L(e,t[1]),e.code.push("self.enter_function("+t[0]+", 0);"),e.code.push("return;"),e.path_ends=!0},353:function(e,t){N(e),e.code.push("self.tempcallargs[0]=("+t[1]+");"),L(e,t[2]),e.code.push("self.enter_function("+t[0]+", 1);"),e.code.push("return;"),e.path_ends=!0},354:function(e,t){N(e),e.code.push("self.tempcallargs[0]=("+t[1]+");"),e.code.push("self.tempcallargs[1]=("+t[2]+");"),L(e,t[3]),e.code.push("self.enter_function("+t[0]+", 2);"),e.code.push("return;"),e.path_ends=!0},355:function(e,t){N(e),e.code.push("self.tempcallargs[0]=("+t[1]+");"),e.code.push("self.tempcallargs[1]=("+t[2]+");"),e.code.push("self.tempcallargs[2]=("+t[3]+");"),L(e,t[4]),e.code.push("self.enter_function("+t[0]+", 3);"),e.code.push("return;"),e.path_ends=!0},49:function(e,t){e.code.push("// quashing offstack for return: "+e.offstack.length),e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("if (self.leave_function()) return self.VMStopped;"),e.code.push("self.pop_callstub("+t[0]+");"),e.code.push("return;"),e.path_ends=!0},50:function(e,t){N(e),L(e,t[0]),e.code.push("self.store_operand("+t[0]+",self.frame.framestart+self.frame.framelen+4*self.frame.valstack.length);"),W(e,t[1],!0),e.path_ends=!0},51:function(e,t){e.code.push("// quashing offstack for throw: "+e.offstack.length),e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("self.pop_stack_to("+t[1]+");"),e.code.push("self.pop_callstub("+t[0]+");"),e.code.push("return;"),e.path_ends=!0},64:function(e,t){$(e,t[1],t[0])},65:function(e,t){$(e,t[1],t[0])},66:function(e,t){$(e,t[1],t[0])},68:function(e,t){var r;H(t[0])?(r=32768&(r=Number(t[0]))?(4294901760|r)>>>0:65535&r,e.code.push(t[1]+r+");")):e.code.push(t[1]+"("+t[0]+" & 0x8000) ? (("+t[0]+" | 0xffff0000) >>> 0) : ("+t[0]+" & 0xffff));")},69:function(e,t){var r;H(t[0])?(r=128&(r=Number(t[0]))?(4294967040|r)>>>0:255&r,e.code.push(t[1]+r+");")):e.code.push(t[1]+"("+t[0]+" & 0x80) ? (("+t[0]+" | 0xffffff00) >>> 0) : ("+t[0]+" & 0xff));")},72:function(e,t){var r,n;H(t[1])?r=H(t[0])?"self.Mem4("+((n=Number(t[0])+4*Number(t[1]))>>>0)+")":(n=4*Number(t[1]))?"self.Mem4(("+t[0]+"+"+n+") >>>0)":"self.Mem4("+t[0]+")":r="self.Mem4(("+t[0]+"+4*"+t[1]+") >>>0)";e.code.push(t[2]+r+");")},73:function(e,t){var r,n;H(t[1])?r=H(t[0])?"self.Mem2("+((n=Number(t[0])+2*Number(t[1]))>>>0)+")":(n=2*Number(t[1]))?"self.Mem2(("+t[0]+"+"+n+") >>>0)":"self.Mem2("+t[0]+")":r="self.Mem2(("+t[0]+"+2*"+t[1]+") >>>0)";e.code.push(t[2]+r+");")},74:function(e,t){var r,n;H(t[1])?r=H(t[0])?"self.Mem1("+((n=Number(t[0])+Number(t[1]))>>>0)+")":(n=Number(t[1]))?"self.Mem1(("+t[0]+"+"+n+") >>>0)":"self.Mem1("+t[0]+")":r="self.Mem1(("+t[0]+"+"+t[1]+") >>>0)";e.code.push(t[2]+r+");")},76:function(e,t){var r,n;H(t[1])?r=H(t[0])?((n=Number(t[0])+4*Number(t[1]))>>>0)+",":(n=4*Number(t[1]))?"("+t[0]+"+"+n+") >>>0,":t[0]+",":r="("+t[0]+"+4*"+t[1]+") >>>0,";e.code.push("self.MemW4("+r+t[2]+");")},77:function(e,t){var r,n;H(t[1])?r=H(t[0])?((n=Number(t[0])+2*Number(t[1]))>>>0)+",":(n=2*Number(t[1]))?"("+t[0]+"+"+n+") >>>0,":t[0]+",":r="("+t[0]+"+2*"+t[1]+") >>>0,";e.code.push("self.MemW2("+r+t[2]+");")},78:function(e,t){var r,n;H(t[1])?r=H(t[0])?((n=Number(t[0])+Number(t[1]))>>>0)+",":(n=Number(t[1]))?"("+t[0]+"+"+n+") >>>0,":t[0]+",":r="("+t[0]+"+"+t[1]+") >>>0,";e.code.push("self.MemW1("+r+t[2]+");")},75:function(e,t){if(H(t[1])){var r,n,i;r=7&(i=4294967295&Number(t[1])),H(t[0])?(n=Number(t[0]),i>=0?n+=i>>3:n-=1+(-1-i>>3)):n=i>=0?i<=7?t[0]:t[0]+"+"+(i>>3):t[0]+"-"+(1+(-1-i>>3)),e.code.push(t[2]+"(self.Mem1("+n+") & "+(1<<r)+")?1:0);")}else{e.varsused.bitx=!0,e.varsused.addrx=!0;var s=B(e,t[1],!0);e.code.push("bitx = "+s+"&7;"),e.code.push("if ("+s+">=0) addrx = "+t[0]+" + ("+s+">>3);"),e.code.push("else addrx = "+t[0]+" - (1+((-1-("+s+"))>>3));"),e.code.push(t[2]+"(self.Mem1(addrx) & (1<<bitx))?1:0);")}},79:function(e,t){var r,n,i,s;if(H(t[1]))r=7&(s=4294967295&Number(t[1])),H(t[0])?(n=Number(t[0]),s>=0?n+=s>>3:n-=1+(-1-s>>3)):n=s>=0?s<=7?t[0]:t[0]+"+"+(s>>3):t[0]+"-"+(1+(-1-s>>3)),i=1<<r;else{e.varsused.bitx=!0,e.varsused.addrx=!0;var o=B(e,t[1],!0);e.code.push("bitx = "+o+"&7;"),e.code.push("if ("+o+">=0) addrx = "+t[0]+" + ("+o+">>3);"),e.code.push("else addrx = "+t[0]+" - (1+((-1-("+o+"))>>3));"),n="addrx",i="(1<<bitx)"}H(t[2])?Number(t[2])?e.code.push("self.MemW1("+n+", self.Mem1("+n+") | "+i+");"):e.code.push("self.MemW1("+n+", self.Mem1("+n+") & ~("+i+"));"):(e.code.push("if ("+t[2]+") self.MemW1("+n+", self.Mem1("+n+") | "+i+");"),e.code.push("else self.MemW1("+n+", self.Mem1("+n+") & ~("+i+"));"))},80:function(e,t){var r,n=e.offstack.length;r=n?"self.frame.valstack.length+"+n:"self.frame.valstack.length",$(e,t[0],r)},81:function(e,t){var r;if(H(t[0])){var n=Number(t[0]);r=n<e.offstack.length?e.offstack[e.offstack.length-(n+1)]:"self.frame.valstack[self.frame.valstack.length-"+(n+1-e.offstack.length)+"]"}else N(e),r="self.frame.valstack[self.frame.valstack.length-("+t[0]+"+1)]";$(e,t[1],r)},82:function(e,t){var r,n;e.offstack.length<2&&function(e,t){var r;for(;e.offstack.length<t;)r=P(e,!0),e.offstack.unshift(r),e.code.push(r+"=self.frame.valstack.pop();")}(e,2),n=e.offstack.length,r=e.offstack[n-1],e.offstack[n-1]=e.offstack[n-2],e.offstack[n-2]=r},83:function(e,t){N(e),e.varsused.ix=!0,e.varsused.pos=!0,e.varsused.roll=!0,e.varsused.vals1=!0;var r=B(e,t[0],!0),n=B(e,t[1],!0);e.code.push("if ("+r+" > 0) {"),e.code.push("if ("+n+" > 0) {"),e.code.push("vals1 = "+n+" % "+r+";"),e.code.push("} else {"),e.code.push("vals1 = "+r+" - (-("+n+")) % "+r+";"),e.code.push("}"),e.code.push("if (vals1) {"),e.code.push("pos = self.frame.valstack.length - "+r+";"),e.code.push("roll = self.frame.valstack.slice(self.frame.valstack.length-vals1, self.frame.valstack.length).concat(self.frame.valstack.slice(pos, self.frame.valstack.length-vals1));"),e.code.push("for (ix=0; ix<"+r+"; ix++) { self.frame.valstack[pos+ix] = roll[ix]; }"),e.code.push("roll = undefined;"),e.code.push("}"),e.code.push("}")},84:function(e,t){if(N(e),H(t[0])){var r,n,i=Number(t[0]);for(r=0;r<i;r++)n=P(e,!0),e.offstack.push(n),e.code.push(n+"=self.frame.valstack[self.frame.valstack.length-"+(i-r)+"];")}else e.varsused.ix=!0,e.varsused.jx=!0,e.code.push("jx = self.frame.valstack.length-("+t[0]+");"),e.code.push("for (ix=0; ix<"+t[0]+"; ix++) { self.frame.valstack.push(self.frame.valstack[jx+ix]); }")},256:function(e,t){var r="self.do_gestalt(("+t[0]+"),("+t[1]+"))";e.code.push(t[2]+r+");")},257:function(e,t){e.code.push("self.fatal_error('User debugtrap encountered.', "+t[0]+");")},258:function(e,t){e.code.push(t[0]+"self.endmem);")},259:function(e,t){e.code.push("self.change_memsize("+t[0]+",false);"),e.code.push(t[1]+"0);")},272:function(e,t){var r;if(H(t[0])){var n=4294967295&Number(t[0]);r=0==n?"(Math.floor(self.random_func() * 0x10000) | (Math.floor(self.random_func() * 0x10000) << 16)) >>>0":n>0?"Math.floor(self.random_func() * "+n+")":"-Math.floor(self.random_func() * "+-n+")"}else{var i=B(e,t[0],!0),s=P(e);r=s,e.code.push("if ("+i+" > 0)"),e.code.push(s+" = Math.floor(self.random_func() * "+i+");"),e.code.push("else if ("+i+" < 0)"),e.code.push(s+" = -Math.floor(self.random_func() * -"+i+");"),e.code.push("else"),e.code.push(s+" = (Math.floor(self.random_func() * 0x10000) | (Math.floor(self.random_func() * 0x10000) << 16)) >>>0;")}e.code.push(t[1]+r+");")},273:function(e,t){e.code.push("self.set_random("+t[0]+");")},288:function(e,t){e.code.push("// quashing offstack for quit: "+e.offstack.length),e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("return self.VMStopped;"),e.path_ends=!0},289:function(e,t){e.code.push(t[0]+"self.perform_verify());")},290:function(e,t){e.code.push("// quashing offstack for quit: "+e.offstack.length),e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("self.vm_restart();"),e.code.push("return;"),e.path_ends=!0},291:function(e,t){N(e),e.varsused.ix=!0,L(e,t[1]),e.code.push("ix = self.vm_save("+t[0]+");"),e.code.push("self.pop_callstub(ix ? 0 : 1);"),e.code.push("return;"),e.path_ends=!0},292:function(e,t){N(e),e.code.push("if (self.vm_restore("+t[0]+")) {"),e.code.push("self.pop_callstub((-1)>>>0);"),e.code.push("} else {"),$(e,t[1],"1"),N(e),e.code.push("self.pc = "+e.cp+";"),e.code.push("}"),e.code.push("return;"),e.path_ends=!0},293:function(e,t){N(e),L(e,t[0]),e.code.push("self.vm_saveundo();"),e.code.push("self.pop_callstub(0);"),e.code.push("return;"),e.path_ends=!0},294:function(e,t){N(e),e.code.push("if (self.vm_restoreundo()) {"),e.code.push("self.pop_callstub((-1)>>>0);"),e.code.push("} else {"),$(e,t[0],"1"),N(e),e.code.push("self.pc = "+e.cp+";"),e.code.push("}"),e.code.push("return;"),e.path_ends=!0},295:function(e,t){e.code.push("self.protectstart="+t[0]+";"),e.code.push("self.protectend=self.protectstart+("+t[1]+");"),e.code.push("if (self.protectstart==self.protectend) {"),e.code.push("  self.protectstart=0; self.protectend=0;"),e.code.push("}")},368:function(e,t){e.varsused.maddr=!0,e.varsused.mlen=!0,e.varsused.ix=!0,e.code.push("mlen="+t[0]+";"),e.code.push("maddr="+t[1]+";"),e.code.push("for (ix=0; ix<mlen; ix++, maddr++) self.MemW1(maddr, 0);")},369:function(e,t){e.varsused.msrc=!0,e.varsused.mdest=!0,e.varsused.mlen=!0,e.varsused.ix=!0,e.code.push("mlen="+t[0]+";"),e.code.push("msrc="+t[1]+";"),e.code.push("mdest="+t[2]+";"),e.code.push("if (mdest < msrc) {"),e.code.push("for (ix=0; ix<mlen; ix++, msrc++, mdest++) self.MemW1(mdest, self.Mem1(msrc));"),e.code.push("} else {"),e.code.push("msrc += (mlen-1); mdest += (mlen-1);"),e.code.push("for (ix=0; ix<mlen; ix++, msrc--, mdest--) self.MemW1(mdest, self.Mem1(msrc));"),e.code.push("}")},376:function(e,t){var r="self.heap_malloc("+t[0]+")";e.code.push(t[1]+r+");"),e.code.push("self.assert_heap_valid();")},377:function(e,t){e.code.push("self.heap_free("+t[0]+");"),e.code.push("self.assert_heap_valid();")},384:function(e,t){e.code.push("self.accel_funcnum_map["+t[1]+"] = "+t[0]+";"),e.code.push("self.accel_address_map["+t[1]+"] = self.accel_func_map["+t[0]+"];")},385:function(e,t){e.code.push("if ("+t[0]+" < 9) {"),e.code.push("  self.accel_params["+t[0]+"] = "+t[1]+";"),e.code.push("}")},336:function(e,t){var r="self.linear_search(("+t[0]+"),("+t[1]+"),("+t[2]+"),("+t[3]+"),("+t[4]+"),("+t[5]+"),("+t[6]+"))";e.code.push(t[7]+r+");")},337:function(e,t){var r="self.binary_search(("+t[0]+"),("+t[1]+"),("+t[2]+"),("+t[3]+"),("+t[4]+"),("+t[5]+"),("+t[6]+"))";e.code.push(t[7]+r+");")},338:function(e,t){var r="self.linked_search(("+t[0]+"),("+t[1]+"),("+t[2]+"),("+t[3]+"),("+t[4]+"),("+t[5]+"))";e.code.push(t[6]+r+");")},112:function(e,t){switch(e.curiosys){case 2:if(H(t[0])){var r=255&Number(t[0]);e.code.push("Glk.glk_put_char("+r+");")}else e.code.push("Glk.glk_put_char(("+t[0]+")&0xff);");break;case 1:N(e),e.code.push("self.tempcallargs[0]=(("+t[0]+")&0xff);"),L(e,"0,0"),e.code.push("self.enter_function(self.iosysrock, 1);"),e.code.push("return;"),e.path_ends=!0;break;case 0:e.code.push("// null streamchar "+t[0])}},113:function(e,t){switch(e.curiosys){case 2:var r=B(e,t[0]);if(H(t[0])){var n=Number(r).toString(10);e.code.push("Glk.glk_put_jstring("+M(n)+", true);")}else e.code.push("Glk.glk_put_jstring(("+r+").toString(10), true);");break;case 1:N(e),e.code.push("self.stream_num("+e.cp+","+t[0]+", false, 0);"),e.code.push("return;"),e.path_ends=!0;break;case 0:e.code.push("// null streamnum "+t[0])}},114:function(e,t){N(e),e.code.push("if (self.stream_string("+e.cp+","+t[0]+", 0, 0)) return;")},115:function(e,t){switch(e.curiosys){case 2:if(H(t[0])){var r=Number(t[0]);e.code.push("Glk.glk_put_char_uni("+r+");")}else e.code.push("Glk.glk_put_char_uni("+t[0]+");");break;case 1:N(e),e.code.push("self.tempcallargs[0]=("+t[0]+");"),L(e,"0,0"),e.code.push("self.enter_function(self.iosysrock, 1);"),e.code.push("return;"),e.path_ends=!0;break;case 0:e.code.push("// null streamchar "+t[0])}},320:function(e,t){e.code.push(t[0]+"self.stringtable)")},321:function(e,t){e.code.push("self.set_string_table("+t[0]+");")},328:function(e,t){e.code.push(t[0]+"self.iosysmode)"),e.code.push(t[1]+"self.iosysrock)")},329:function(e,t){if(e.code.push("self.set_iosys("+t[0]+","+t[1]+");"),H(t[0])){var r=Number(t[0]);e.curiosys=r}else N(e),e.code.push("self.pc = "+e.cp+";"),e.code.push("return;"),e.path_ends=!0},400:function(e,t){var r=B(e,t[0]);if(H(t[0])){var n=Number(r);e.code.push(t[1]+be(n)+");")}else e.code.push(t[1]+"self.encode_float("+r+"));")},401:function(e,t){e.varsused.valf=!0,e.varsused.res=!0,e.code.push("valf = "+R(e,t[0])+";"),e.code.push("if (!("+t[0]+" & 0x80000000)) {"),e.code.push("  if (isNaN(valf) || !isFinite(valf) || (valf > 0x7fffffff))"),e.code.push("    res = 0x7fffffff;"),e.code.push("  else"),e.code.push("    res = Math.floor(valf);"),e.code.push("} else {"),e.code.push("  if (isNaN(valf) || !isFinite(valf) || (valf < -0x80000000))"),e.code.push("    res = -0x80000000;"),e.code.push("  else"),e.code.push("    res = Math.ceil(valf);"),e.code.push("}"),e.code.push(t[1]+"res>>>0);")},402:function(e,t){e.varsused.valf=!0,e.varsused.res=!0,e.code.push("valf = "+R(e,t[0])+";"),e.code.push("if (!("+t[0]+" & 0x80000000)) {"),e.code.push("  if (isNaN(valf) || !isFinite(valf))"),e.code.push("    res = 0x7fffffff;"),e.code.push("  else"),e.code.push("    res = Math.round(valf);"),e.code.push("  if (res > 0x7fffffff) res = 0x7fffffff;"),e.code.push("} else {"),e.code.push("  if (isNaN(valf) || !isFinite(valf))"),e.code.push("    res = -0x80000000;"),e.code.push("  else"),e.code.push("    res = Math.round(valf);"),e.code.push("  if (res < -0x80000000) res = -0x80000000;"),e.code.push("}"),e.code.push(t[1]+"res>>>0);")},408:function(e,t){var r=R(e,t[0]);e.code.push(t[1]+"self.encode_float(Math.ceil("+r+")));")},409:function(e,t){var r=R(e,t[0]);e.code.push(t[1]+"self.encode_float(Math.floor("+r+")));")},416:function(e,t){var r=R(e,t[0]),n=R(e,t[1]);e.code.push(t[2]+"self.encode_float("+r+" + "+n+"));")},417:function(e,t){var r=R(e,t[0]),n=R(e,t[1]);e.code.push(t[2]+"self.encode_float("+r+" - "+n+"));")},418:function(e,t){var r=R(e,t[0]),n=R(e,t[1]);e.code.push(t[2]+"self.encode_float("+r+" * "+n+"));")},419:function(e,t){var r=R(e,t[0]),n=R(e,t[1]);e.code.push(t[2]+"self.encode_float("+r+" / "+n+"));")},420:function(e,t){var r=R(e,t[0],!0),n=R(e,t[1],!0);e.varsused.modv=!0,e.varsused.quov=!0,e.code.push("modv=("+r+" % "+n+");"),e.code.push("quov=self.encode_float(("+r+" - modv) / "+n+");"),e.code.push("if (quov == 0x0 || quov == 0x80000000) {"),e.code.push("  quov = (("+t[0]+" ^ "+t[1]+") & 0x80000000) >>>0;"),e.code.push("}"),e.code.push(t[2]+"self.encode_float(modv));"),e.code.push(t[3]+"quov);")},424:function(e,t){var r=R(e,t[0]);e.code.push(t[1]+"self.encode_float(Math.sqrt("+r+")));")},425:function(e,t){var r=R(e,t[0]);e.code.push(t[1]+"self.encode_float(Math.exp("+r+")));")},426:function(e,t){var r=R(e,t[0]);e.code.push(t[1]+"self.encode_float(Math.log("+r+")));")},427:function(e,t){e.varsused.valf=!0;var r=R(e,t[0],!0),n=R(e,t[1],!0);e.code.push("if ("+t[0]+" == 0x3f800000) {"),e.code.push("  valf = 0x3f800000;"),e.code.push("} else if ("+t[0]+" == 0xbf800000 && ("+t[1]+" == 0xff800000 || "+t[1]+" == 0x7f800000)) {"),e.code.push("  valf = 0x3f800000;"),e.code.push("} else {"),e.code.push("  valf=self.encode_float(Math.pow("+r+", "+n+"));"),e.code.push("}"),e.code.push(t[2]+"valf);")},432:function(e,t){var r=R(e,t[0]);e.code.push(t[1]+"self.encode_float(Math.sin("+r+")));")},433:function(e,t){var r=R(e,t[0]);e.code.push(t[1]+"self.encode_float(Math.cos("+r+")));")},434:function(e,t){var r=R(e,t[0]);e.code.push(t[1]+"self.encode_float(Math.tan("+r+")));")},435:function(e,t){var r=R(e,t[0]);e.code.push(t[1]+"self.encode_float(Math.asin("+r+")));")},436:function(e,t){var r=R(e,t[0]);e.code.push(t[1]+"self.encode_float(Math.acos("+r+")));")},437:function(e,t){var r=R(e,t[0]);e.code.push(t[1]+"self.encode_float(Math.atan("+r+")));")},438:function(e,t){var r=R(e,t[0]),n=R(e,t[1]);e.code.push(t[2]+"self.encode_float(Math.atan2("+r+", "+n+")));")},448:function(e,t){var r,n,i,s;e.varsused.fequal=!0,e.varsused.fdiff=!0,e.code.push("if (("+t[2]+" & 0x7f800000) == 0x7f800000 && ("+t[2]+" & 0x007fffff) != 0) {"),e.code.push("  fequal = 0;"),e.code.push("} else if (("+t[0]+" == 0xff800000 || "+t[0]+" == 0x7f800000) && ("+t[1]+" == 0xff800000 || "+t[1]+" == 0x7f800000)) {"),e.code.push("  fequal = ("+t[0]+" == "+t[1]+");"),e.code.push("} else {"),H(t[2])?s=""+ve(2147483647&(r=Number(t[2]))):(r="self.decode_float(("+t[2]+") & 0x7fffffff)",s=P(e),e.code.push(s+"="+r+";")),n=R(e,t[0]),i=R(e,t[1]),e.code.push("  fdiff = "+i+" - "+n+";"),e.code.push("  fequal = (fdiff <= "+s+" && fdiff >= -("+s+"));"),e.code.push("}"),e.code.push("if (fequal) {"),W(e,t[3]),e.code.push("}")},449:function(e,t){var r,n,i,s;e.varsused.fequal=!0,e.varsused.fdiff=!0,e.code.push("if (("+t[2]+" & 0x7f800000) == 0x7f800000 && ("+t[2]+" & 0x007fffff) != 0) {"),e.code.push("  fequal = 0;"),e.code.push("} else if (("+t[0]+" == 0xff800000 || "+t[0]+" == 0x7f800000) && ("+t[1]+" == 0xff800000 || "+t[1]+" == 0x7f800000)) {"),e.code.push("  fequal = ("+t[0]+" == "+t[1]+");"),e.code.push("} else {"),H(t[2])?s=""+ve(2147483647&(r=Number(t[2]))):(r="self.decode_float(("+t[2]+") & 0x7fffffff)",s=P(e),e.code.push(s+"="+r+";")),n=R(e,t[0]),i=R(e,t[1]),e.code.push("  fdiff = "+i+" - "+n+";"),e.code.push("  fequal = (fdiff <= "+s+" && fdiff >= -("+s+"));"),e.code.push("}"),e.code.push("if (!fequal) {"),W(e,t[3]),e.code.push("}")},450:function(e,t){var r,n;r=R(e,t[0]),n=R(e,t[1]),e.code.push("if ("+r+" < "+n+") {"),W(e,t[2]),e.code.push("}")},451:function(e,t){var r,n;r=R(e,t[0]),n=R(e,t[1]),e.code.push("if ("+r+" <= "+n+") {"),W(e,t[2]),e.code.push("}")},452:function(e,t){var r,n;r=R(e,t[0]),n=R(e,t[1]),e.code.push("if ("+r+" > "+n+") {"),W(e,t[2]),e.code.push("}")},453:function(e,t){var r,n;r=R(e,t[0]),n=R(e,t[1]),e.code.push("if ("+r+" >= "+n+") {"),W(e,t[2]),e.code.push("}")},456:function(e,t){e.code.push("if (("+t[0]+" & 0x7f800000) == 0x7f800000 && ("+t[0]+" & 0x007fffff) != 0) {"),W(e,t[1]),e.code.push("}")},457:function(e,t){e.code.push("if ("+t[0]+" == 0xff800000 || "+t[0]+" == 0x7f800000) {"),W(e,t[1]),e.code.push("}")},304:function(t,r){var n;if((n=!H(r[0])||Glk.call_may_not_return(Number(r[0])))&&(t.code.push("  self.prevpc = "+t.prevcp+";"),t.code.push("  self.pc = "+t.cp+";")),t.code.push("self.tempglkargs.length = "+r[1]+";"),H(r[1])){var i,s=Number(r[1]);for(i=0;i<s;i++)if(t.offstack.length){var o=Q(t);t.code.push("self.tempglkargs["+i+"]="+o+";")}else t.code.push("self.tempglkargs["+i+"]=self.frame.valstack.pop();");N(t)}else t.varsused.ix=!0,N(t),t.code.push("for (ix=0; ix<"+r[1]+"; ix++) { self.tempglkargs[ix]=self.frame.valstack.pop(); }");t.varsused.glkret=!0,t.code.push("glkret = GiDispa.get_function("+r[0]+")(self.tempglkargs);"),n&&(t.code.push("if (glkret === Glk.DidNotReturn) {"),t.code.push("  self.resumefuncop = "+function(t){if(0==t.mode)return"null";var r="m"+t.mode;if(null!=t.argsize&&(r=r+"s"+t.argsize),null!=t.addr&&(r=r+"a"+t.addr),e.funcop_cache.key)return"self.funcop_cache."+r;var n={key:r,mode:t.mode,argsize:t.argsize,addr:t.addr};return e.funcop_cache[r]=n,"self.funcop_cache."+r}(r[2])+";"),t.code.push("  self.resumevalue = 0;"),t.code.push("  self.pc = "+t.cp+";"),t.code.push("  self.done_executing = true;"),t.code.push("  return;"),t.code.push("}")),$(t,r[2],"glkret")}};function P(e,t){for(var r,n=0;;){if(r="_hold"+n,!e.holduse[r])return e.holduse[r]=!t||1,r;n++}}function Q(e){var t=e.offstack.pop();if(H(t))return t;var r=e.holduse[t];return(isNaN(r)||!1===r||!0===r)&&j("Offstack variable not marked as stack.",t),0==--r&&(r=!0),e.holduse[t]=r,t}function V(e,t,r,n){var i=e.offloc[t];if(i&&"_"===i[0]){var s=e.holduse[i];0==--s&&(s=!0),e.holduse[i]=s}if(void 0===r)return e.offloc[t]=void 0,void(e.offlocdirty[t]=!1);if(e.offloc[t]=r,e.offlocdirty[t]=!0,n){var o=r;(s=e.holduse[o])&&!0!==s?s++:s=1,e.holduse[o]=s}}function H(e){return"0"===e[0]}function Y(e,t,r,n){var i,s,o,a,l,d,h;for(n.desttype=0,n.numops=r.numops,i=t,t+=r.numops+1>>1,s=0;s<r.numops;s++){0==(1&s)?a=15&(o=u(i)):(a=o>>4&15,i++);var p=r.formlist[s];if("L"!=p)if("E"!=p)if("S"!=p)if("F"!=p)if("C"!=p)j("Unknown operand type.",p);else{switch(a){case 8:n[s]="3,0";continue;case 0:n[s]="0,0";continue}if(a>=9&&a<=11){9==a?(d=u(t),t++):10==a?(d=f(t),t+=2):11==a&&(d=c(t),t+=4),n[s]="2,"+d;continue}switch(a){case 15:d=c(t)+Me,t+=4;break;case 14:d=f(t)+Me,t+=2;break;case 13:d=u(t)+Me,t++;break;case 7:d=c(t),t+=4;break;case 6:d=f(t),t+=2;break;case 5:d=u(t),t++;break;default:j("Unknown addressing mode in store operand.")}n[s]="1,"+d}else{var _=n.func_store;switch(a){case 8:_.mode=8,_.argsize=r.argsize,n[s]=_;continue;case 0:_.mode=0,_.argsize=r.argsize,n[s]=_;continue}if(a>=9&&a<=11){9==a?(d=u(t),t++):10==a?(d=f(t),t+=2):11==a&&(d=c(t),t+=4),_.mode=11,_.addr=d,_.argsize=r.argsize,n[s]=_;continue}switch(a){case 15:d=c(t)+Me,t+=4;break;case 14:d=f(t)+Me,t+=2;break;case 13:d=u(t)+Me,t++;break;case 7:d=c(t),t+=4;break;case 6:d=f(t),t+=2;break;case 5:d=u(t),t++;break;default:j("Unknown addressing mode in store operand.")}_.mode=15,_.addr=d,_.argsize=r.argsize,n[s]=_}else{switch(a){case 8:h=P(e,!0),e.offstack.push(h),n[s]=h+"=(";continue;case 0:n[s]="(";continue}if(a>=9&&a<=11){9==a?(d=u(t),t++):10==a?(d=f(t),t+=2):11==a&&(d=c(t),t+=4),4==r.argsize?(V(e,d,h=P(e,!0),!1),n[s]=h+"=("):2==r.argsize?(V(e,d,void 0),n[s]="self.frame.locals["+d+"]=(0xffff &"):(V(e,d,void 0),n[s]="self.frame.locals["+d+"]=(0xff &");continue}switch(a){case 15:d=c(t)+Me,t+=4;break;case 14:d=f(t)+Me,t+=2;break;case 13:d=u(t)+Me,t++;break;case 7:d=c(t),t+=4;break;case 6:d=f(t),t+=2;break;case 5:d=u(t),t++;break;default:j("Unknown addressing mode in store operand.")}l=4==r.argsize?"self.MemW4("+d+",":2==r.argsize?"self.MemW2("+d+",":"self.MemW1("+d+",",n[s]=l}else{switch(a){case 8:e.offstack.length?n[s]=Q(e):n[s]="self.frame.valstack.pop()";continue;case 0:n[s]="0";continue;case 1:l=k(t),t++,n[s]=l;continue;case 2:l=y(t),t+=2,n[s]=l;continue;case 3:l=x(t),t+=4,n[s]=l;continue}if(a>=9&&a<=11){if(9==a?(d=u(t),t++):10==a?(d=f(t),t+=2):11==a&&(d=c(t),t+=4),void 0!==e.offloc[d]){n[s]=e.offloc[d];continue}l=4==r.argsize?"self.frame.locals["+d+"]":2==r.argsize?"self.frame.locals["+d+"] & 0xffff":"self.frame.locals["+d+"] & 0xff",h=P(e,!0),e.code.push(h+"=("+l+");"),e.offloc[d]=h,e.offlocdirty[d]=!1,n[s]=h;continue}switch(a){case 15:d=c(t)+Me,t+=4;break;case 14:d=f(t)+Me,t+=2;break;case 13:d=u(t)+Me,t++;break;case 7:d=c(t),t+=4;break;case 6:d=f(t),t+=2;break;case 5:d=u(t),t++;break;default:j("Unknown addressing mode in load operand.")}l=4==r.argsize?"self.Mem4("+d+")":2==r.argsize?"self.Mem2("+d+")":"self.Mem1("+d+")",n[s]=l}else{switch(a){case 8:e.offstack.length?n[s]=Q(e):(h=P(e),e.code.push(h+"=self.frame.valstack.pop();"),n[s]=h);continue;case 0:n[s]="0";continue;case 1:l=k(t),t++,n[s]=l;continue;case 2:l=y(t),t+=2,n[s]=l;continue;case 3:l=x(t),t+=4,n[s]=l;continue}if(a>=9&&a<=11){if(9==a?(d=u(t),t++):10==a?(d=f(t),t+=2):11==a&&(d=c(t),t+=4),void 0!==e.offloc[d]){n[s]=e.offloc[d];continue}l=4==r.argsize?"self.frame.locals["+d+"]":2==r.argsize?"self.frame.locals["+d+"] & 0xffff":"self.frame.locals["+d+"] & 0xff",h=P(e,!0),e.code.push(h+"=("+l+");"),e.offloc[d]=h,e.offlocdirty[d]=!1,n[s]=h;continue}switch(a){case 15:d=c(t)+Me,t+=4;break;case 14:d=f(t)+Me,t+=2;break;case 13:d=u(t)+Me,t++;break;case 7:d=c(t),t+=4;break;case 6:d=f(t),t+=2;break;case 5:d=u(t),t++;break;default:j("Unknown addressing mode in load operand.")}l=4==r.argsize?"self.Mem4("+d+")":2==r.argsize?"self.Mem2("+d+")":"self.Mem1("+d+")",h=P(e),e.code.push(h+"=("+l+");"),n[s]=h}}return t}function Z(e,t,r){var n,i,s,o=t,a={vmfunc:e,cp:null,prevcp:null,curiosys:r,code:[],holduse:{},varsused:{},offstack:[],offloc:[],offlocdirty:[],path_ends:!1},l={func_store:{}};for(a.code.push("");!a.path_ends;){a.prevcp=o,i=o,void 0===(n=u(o))&&j("Tried to compile nonexistent address",o),o++,128&n&&(64&n?(n=256*(n=256*(n=256*(n&=63)|u(o))|u(++o))|u(++o),o++):(n=256*(n&=127)|u(o),o++)),a.code.push("// "+i.toString(16)+": opcode "+n.toString(16));var f=D[n];f||j("Encountered unknown opcode.",n),o=Y(a,o,f,l),a.cp=o;var c=O[n];for(s in c||j("Encountered unhandled opcode.",n),c(a,l),a.holduse)!0===a.holduse[s]&&(a.holduse[s]=!1);a.offstack.length&&a.code.push("// offstack: "+a.offstack.join(",")),a.offloc.length&&a.code.push("// offloc: "+a.offloc.join(",")+"; dirty: "+a.offlocdirty.join(",")),e.pathaddrs[o]&&!a.path_ends&&(a.code.push("// reached jump-in point"),a.code.push("self.pc="+o+";"),N(a),a.code.push("return;"),a.path_ends=!0)}a.offstack.length&&j("Path compilation ended with nonempty offstack.",a.offstack.length),a.offloc.length&&j("Path compilation ended with nonempty offloc.",a.offloc.length);var d=[];for(s in a.holduse)d.push(s);for(s in a.varsused)d.push(s);return d.length&&(a.code[0]="var "+d.join(",")+";"),G(a.code.join("\n"),"_func_path_"+t)}function J(t,r){var n;We++;var i=ie[t];if(void 0!==i)return Oe++,void X(i(r,e.tempcallargs));var s=xe[t];void 0===s&&(s=function(e){var t=e,r=u(t);192!=r&&193!=r&&j(r>=192&&r<=223?"Call to unknown type of function.":"Call to non-function.",t);for(var n=[],i=++t;;){var s=u(t),o=u(++t);if(t++,0==s)break;1!=s&&2!=s&&4!=s&&j("Invalid local variable size in function header.",s),n.push({size:s,count:o})}for(var a=ke.slice(i,t);a.length%4;)a.push(0);return new T(e,t,n,a)}(t),t<Me&&(xe[t]=s)),e.pc=s.startpc;var o=new z(s);if(o.depth=ye.length,0==ye.length?o.framestart=0:o.framestart=e.frame.framestart+e.frame.framelen+4*e.frame.valstack.length,ye.push(o),e.frame=o,192==s.functype){for(n=r-1;n>=0;n--)e.frame.valstack.push(e.tempcallargs[n]);e.frame.valstack.push(r)}else for(n=0;n<r;n++){var a=s.localsindex[n];if(void 0===a)break;4==a.size?e.frame.locals[a.pos]=e.tempcallargs[n]:2==a.size?e.frame.locals[a.pos]=65535&e.tempcallargs[n]:1==a.size&&(e.frame.locals[a.pos]=255&e.tempcallargs[n])}}function X(t){var r,n;isNaN(t)&&j("Function returned undefined value.");var i=e.frame.valstack,s=i.length,o=i[s-1];switch(o!=e.frame.framestart&&(i.length-=1,j("Call stub frameptr ("+o+") does not match frame ("+e.frame.framestart+")")),e.pc=i[s-2],r=i[s-3],n=i[s-4],i.length-=4,n){case 0:return;case 1:return void _(r,t);case 2:return void(e.frame.locals[r]=t);case 3:return void e.frame.valstack.push(t);case 17:return void j("String-terminator call stub at end of function call.");case 16:return void _e(0,e.pc,225,r);case 18:return void pe(0,e.pc,!0,r);case 19:return void _e(0,e.pc,224,r);case 20:return void _e(0,e.pc,226,r);default:j("Unrecognized desttype in callstub.",n)}}function K(t){0==t?e.random_func=Math.random:(!function(e){var t,r,n,i,s;void 0===re&&(re=Array(55));for(re[54]=e,ee=0,te=31,n=1,t=0;t<55;t++)re[r=21*t%55]=n,n=e-n>>>0,e=re[r];for(s=0;s<4;s++)for(t=0;t<55;t++)i=re[t]-re[(1+t+30)%55],re[t]=i>>>0}(t),e.random_func=ne)}e.enter_function=J,e.leave_function=function(){var t=e.frame.depth;if(ye.pop(),0==ye.length)return e.frame=null,!0;e.frame=ye[ye.length-1],e.frame.depth!=t-1&&j("Stack inconsistent after function exit.")},e.pop_stack_to=function(t){for(;ye.length&&ye[ye.length-1].framestart>t;)ye.pop();0==ye.length&&j("Stack evaporated during throw."),e.frame=ye[ye.length-1],(t-=e.frame.framestart+e.frame.framelen)<0&&j("Attempted to throw below the frame value stack."),3&t&&j("Attempted to throw to an unaligned address."),(t>>>=2)>e.frame.valstack.length&&j("Attempted to throw beyond the frame value stack."),e.frame.valstack.length=t},e.pop_callstub=X,e.store_operand=function(t,r,n){switch(t){case 0:return;case 1:return void _(r,n);case 2:return void(e.frame.locals[r]=n);case 3:return void e.frame.valstack.push(n);default:j("Unrecognized desttype in callstub.",t)}},e.set_random=K;var ee,te,re=void 0;function ne(){return te=(te+1)%55,re[ee=(ee+1)%55]=re[ee]-re[te]>>>0,re[ee]/4294967296}var ie={},se={};e.accel_address_map=ie,e.accel_funcnum_map=se;var oe=[0,0,0,0,0,0,0,0,0];e.accel_params=oe;var ae={1:function(t,r){if(t<1)return 0;var n=r[0];if(n<36)return 0;if(n>=e.endmem)return 0;var i=u(n);return i>=224?3:i>=192?2:i>=112&&i<=127&&n>=Me?1:0},2:function(e,t){var r=e>0?t[0]:0,n=e>1?t[1]:0;if(1!=ae[1](e,t))return Glk.glk_put_jstring('\n[** Programming error: tried to find the "." of (something) **]\n'),0;var i=c(r+16);if(!i)return 0;var s=c(i);return we(n,2,i+=4,10,s,0,0)},3:function(e,t){var r=fe(e>0?t[0]:0,e>1?t[1]:0);return 0==r?0:c(r+4)},4:function(e,t){var r=fe(e>0?t[0]:0,e>1?t[1]:0);return 0==r?0:4*f(r+2)},5:function(e,t){var r,n,i,s,o,a=e>0?t[0]:0,l=e>1?t[1]:0;if(3==(r=ae[1](e,t)))return l==oe[5]?1:0;if(2==r)return l==oe[4]?1:0;if(1!=r)return 0;if(l==oe[2])return ue(a)||a==oe[2]||a==oe[5]||a==oe[4]||a==oe[3]?1:0;if(l==oe[3])return ue(a)||a==oe[2]||a==oe[5]||a==oe[4]||a==oe[3]?0:1;if(l==oe[5]||l==oe[4])return 0;if(!ue(l))return Glk.glk_put_jstring("\n[** Programming error: tried to apply 'ofclass' with non-class **]\n"),0;if(0==(n=fe(a,2)))return 0;if(0==(i=c(n+4)))return 0;for(s=f(n+2),o=0;o<s;o++)if(c(i+4*o)==l)return 1;return 0},6:function(e,t){var r,n=e>1?t[1]:0;return 0==(r=ae[3](e,t))?n>0&&n<oe[1]?c(oe[8]+4*n):(Glk.glk_put_jstring("\n[** Programming error: tried to read (something) **]\n"),0):c(r)},7:function(e,t){var r=e>0?t[0]:0,n=e>1?t[1]:0,i=oe[1],s=ae[1](e,t);return 3==s?n==i+6||n==i+7?1:0:2==s?n==i+5?1:0:1!=s?0:n>=i&&n<i+8&&ue(r)||ae[3](e,t)?1:0},8:function(e,t){var r=e>0?t[0]:0,n=e>1?t[1]:0;if(1!=ae[1](e,t))return Glk.glk_put_jstring('\n[** Programming error: tried to find the "." of (something) **]\n'),0;var i=c(r+4*(3+(oe[7]>>2)));if(!i)return 0;var s=c(i);return we(n,2,i+=4,10,s,0,0)},9:function(e,t){var r=ce(e>0?t[0]:0,e>1?t[1]:0);return 0==r?0:c(r+4)},10:function(e,t){var r=ce(e>0?t[0]:0,e>1?t[1]:0);return 0==r?0:4*f(r+2)},11:function(e,t){var r,n,i,s,o,a=e>0?t[0]:0,l=e>1?t[1]:0;if(3==(r=ae[1](e,t)))return l==oe[5]?1:0;if(2==r)return l==oe[4]?1:0;if(1!=r)return 0;if(l==oe[2])return ue(a)||a==oe[2]||a==oe[5]||a==oe[4]||a==oe[3]?1:0;if(l==oe[3])return ue(a)||a==oe[2]||a==oe[5]||a==oe[4]||a==oe[3]?0:1;if(l==oe[5]||l==oe[4])return 0;if(!ue(l))return Glk.glk_put_jstring("\n[** Programming error: tried to apply 'ofclass' with non-class **]\n"),0;if(0==(n=ce(a,2)))return 0;if(0==(i=c(n+4)))return 0;for(s=f(n+2),o=0;o<s;o++)if(c(i+4*o)==l)return 1;return 0},12:function(e,t){var r,n=e>1?t[1]:0;return 0==(r=ae[9](e,t))?n>0&&n<oe[1]?c(oe[8]+4*n):(Glk.glk_put_jstring("\n[** Programming error: tried to read (something) **]\n"),0):c(r)},13:function(e,t){var r=e>0?t[0]:0,n=e>1?t[1]:0,i=oe[1],s=ae[1](e,t);return 3==s?n==i+6||n==i+7?1:0:2==s?n==i+5?1:0:1!=s?0:n>=i&&n<i+8&&ue(r)||ae[9](e,t)?1:0}};e.accel_func_map=ae;var le=[0,0];function ue(e){return c(e+13+oe[7])==oe[2]}function fe(e,t){var r,n=0;if(4294901760&t){if(n=c(oe[0]+4*(65535&t)),le[0]=e,le[1]=n,0==ae[5](2,le))return 0;t>>=16,e=n}return le[0]=e,le[1]=t,0==(r=ae[2](2,le))||ue(e)&&0==n&&(t<oe[1]||t>=oe[1]+8)||c(oe[6])!=e&&1&u(r+9)?0:r}function ce(e,t){var r,n=0;if(4294901760&t){if(n=c(oe[0]+4*(65535&t)),le[0]=e,le[1]=n,0==ae[11](2,le))return 0;t>>=16,e=n}return le[0]=e,le[1]=t,0==(r=ae[8](2,le))||ue(e)&&0==n&&(t<oe[1]||t>=oe[1]+8)||c(oe[6])!=e&&1&u(r+9)?0:r}function de(t){if(e.stringtable!=t&&(Ce=void 0,Se=void 0,e.stringtable=t,0!=e.stringtable)){var r=Ue[e.stringtable];if(void 0===r){var n=void 0,i=c(e.stringtable),s=c(e.stringtable+8);if(e.stringtable+i<=Me){var o=Array(1);!function e(t,r,n,i){var s,o,a,l;if(0==(o=u(r))&&4==n)return(a=Array(16)).type=0,a.depth=4,t[i]=a,void e(a,r,0,0);if(0==o){var f=c(r+1),d=c(r+5);return e(t,f,n+1,i),void e(t,d,n+1,i|1<<n)}switch(r++,(a={}).type=o,a.depth=n,o){case 2:a.value=u(r),a.cchar=U(a.value);break;case 4:a.value=c(r),a.cchar=U(a.value);break;case 3:case 5:a.addr=r;break;case 8:case 9:a.addr=c(r);break;case 10:case 11:a.addr=r;break;case 1:break;default:j("Unknown node type in string table.",o)}for(l=1<<n,s=i;s<16;s+=l)t[s]=a}(o,s,4,0),void 0===(n=o[0])&&j("Failed to create decoding tree.")}r=new F(e.stringtable,n),Ue[e.stringtable]=r}Ce=r.decoding_tree,Se=r.vmstring_tables[e.iosysmode]}}function he(t,r){switch(t){case 0:r=0;break;case 1:break;case 2:r=0;break;default:t=0,r=0}e.iosysmode=t,e.iosysrock=r;var n=Ue[e.stringtable];Se=void 0===n?void 0:n.vmstring_tables[e.iosysmode]}function pe(t,r,n,i){var s=(4294967295&r).toString(10);switch(e.iosysmode){case 2:i&&(s=s.slice(i)),Glk.glk_put_jstring(s,!0);break;case 1:if(n||(e.frame.valstack.push(17,0,t,e.frame.framestart),n=!0),i<s.length){var o=s.charCodeAt(i);return e.frame.valstack.push(18,i+1,r,e.frame.framestart),e.tempcallargs[0]=o,J(e.iosysrock,1),!0}}n&&(e.frame.valstack.pop()!=e.frame.framestart&&j("Call stub frameptr does not match frame."),e.pc=e.frame.valstack.pop(),e.frame.valstack.pop(),17!=e.frame.valstack.pop()&&j("String-on-string call stub while printing number."))}function _e(t,r,n,i){for(var s,o,a,l,u,f=0!=n;;){if(o=void 0,s=0==n?r:r+"/"+n+"/"+i,void 0!==Se&&r<Me?void 0===(o=Se[s])&&(o=ge(e.iosysmode,r,n,i),Se[s]=o,Ye++,He++):(o=ge(e.iosysmode,r,n,i),Ye++),o instanceof Function){if((a=o(e,t,f))instanceof Array){f=!0,r=a[0],n=a[1],i=a[2];continue}if(a)return!0}else if(Glk.glk_put_jstring(o),!f)return!1;if(e.frame.valstack.pop()!=e.frame.framestart&&j("Call stub frameptr does not match frame."),e.pc=e.frame.valstack.pop(),u=e.frame.valstack.pop(),17==(l=e.frame.valstack.pop()))return!0;16==l?(f=!0,i=u,n=225,r=e.pc):j("Function-terminator call stub at end of string.")}}function ge(t,r,n,i){var s,o=r,a=i,l=void 0;o||j("Called compile_string with null address.");var f={startaddr:r,startbitnum:i,buffer:[],code:[]};if(0==n?(226==(s=u(o))?o+=4:o++,a=0):s=n,225==s)if(Ce){var d,h,p,_,g,m,w=!1;for(d=u(o),a&&(d>>=a),h=8-a,p=!1,Ce instanceof Array||(w=!0),g=Ce;!w;){if(h<4)d|=u(o+1)<<h,h+=8,p=!0;if(h-=(m=g[15&d]).depth,d>>=m.depth,(a+=m.depth)>=8)if(o+=1,a-=8,p)p=!1;else d|=u(o)<<h,h+=8;if(m instanceof Array)g=m;else switch(m.type){case 1:w=!0;break;case 2:case 4:switch(t){case 2:f.buffer.push(m.cchar);break;case 1:E(f),I(f),L(f,"0x10,"+a,o),f.code.push("self.tempcallargs[0]="+m.value+";"),f.code.push("self.enter_function(self.iosysrock, 1);"),l=!0,w=!0}g=Ce;break;case 3:switch(t){case 2:for(_=m.addr;0!=(C=u(_));)f.buffer.push(U(C)),_++;break;case 1:E(f),I(f),L(f,"0x10,"+a,o),l="["+m.addr+", 0xE0, 0]",w=!0}g=Ce;break;case 5:switch(t){case 2:for(_=m.addr;0!=(C=c(_));)f.buffer.push(U(C)),_+=4;break;case 1:E(f),I(f),L(f,"0x10,"+a,o),l="["+m.addr+", 0xE2, 0]",w=!0}g=Ce;break;case 8:case 9:case 10:case 11:E(f),I(f),f.code.push("var otype, retval;"),f.code.push("var oaddr = "+m.addr+";"),m.type>=9&&f.code.push("oaddr = self.Mem4(oaddr);"),11==m.type&&f.code.push("oaddr = self.Mem4(oaddr);"),f.code.push("otype = self.Mem1(oaddr);"),l="retval",w=!0,L(f,"0x10,"+a,o),f.code.push("if (otype >= 0xE0 && otype <= 0xFF) {"),f.code.push("retval = [oaddr, 0, 0];"),f.code.push("}"),f.code.push("else if (otype >= 0xC0 && otype <= 0xDF) {");var v=0;if(10==m.type||11==m.type){v=c(m.addr+4);for(var b=0;b<v;b++)f.code.push("self.tempcallargs["+b+"]="+c(m.addr+8+4*b)+";")}f.code.push("self.enter_function(oaddr, "+v+");"),f.code.push("retval = true;"),f.code.push("}"),f.code.push("else {"),f.code.push("self.fatal_error('Unknown object while decoding string indirect reference.', otype);"),f.code.push("}");break;default:j("Unknown entity in string decoding (cached).")}}}else{var k,y,x;w=!1;for(e.stringtable||j("Attempted to print a compressed string with no table set."),y=u(o),a&&(y>>=a),k=c(e.stringtable+8);!w;)switch(x=u(k),k++,x){case 0:k=c(1&y?k+4:k+0),7==a?(a=0,y=u(++o)):(a++,y>>=1);break;case 1:l=!1,w=!0;break;case 2:switch(C=u(k),t){case 2:f.buffer.push(U(C));break;case 1:E(f),I(f),L(f,"0x10,"+a,o),f.code.push("self.tempcallargs[0]="+C+";"),f.code.push("self.enter_function(self.iosysrock, 1);"),l=!0,w=!0}k=c(e.stringtable+8);break;case 4:switch(C=c(k),t){case 2:f.buffer.push(U(C));break;case 1:E(f),I(f),L(f,"0x10,"+a,o),f.code.push("self.tempcallargs[0]="+C+";"),f.code.push("self.enter_function(self.iosysrock, 1);"),l=!0,w=!0}k=c(e.stringtable+8);break;case 3:switch(t){case 2:for(;0!=(C=u(k));)f.buffer.push(U(C)),k++;break;case 1:E(f),I(f),L(f,"0x10,"+a,o),l="["+k+", 0xE0, 0]",w=!0}k=c(e.stringtable+8);break;case 5:switch(t){case 2:for(;0!=(C=c(k));)f.buffer.push(U(C)),k+=4;break;case 1:E(f),I(f),L(f,"0x10,"+a,o),l="["+k+", 0xE2, 0]",w=!0}k=c(e.stringtable+8);break;case 8:case 9:case 10:case 11:E(f),I(f),f.code.push("var otype, retval;"),f.code.push("var oaddr = "+c(k)+";"),9!=x&&11!=x||f.code.push("oaddr = self.Mem4(oaddr);"),f.code.push("otype = self.Mem1(oaddr);"),l="retval",w=!0,L(f,"0x10,"+a,o),f.code.push("if (otype >= 0xE0 && otype <= 0xFF) {"),f.code.push("retval = [oaddr, 0, 0];"),f.code.push("}"),f.code.push("else if (otype >= 0xC0 && otype <= 0xDF) {");v=0;if(10==x||11==x){v=c(k+4);for(b=0;b<v;b++)f.code.push("self.tempcallargs["+b+"]="+c(k+8+4*b)+";")}f.code.push("self.enter_function(oaddr, "+v+");"),f.code.push("retval = true;"),f.code.push("}"),f.code.push("else {"),f.code.push("self.fatal_error('Unknown object while decoding string indirect reference.', otype);"),f.code.push("}");break;default:j("Unknown entity in string decoding.",x)}}else if(224==s){switch(t){case 2:for(;C=u(o),o++,0!=C;)f.buffer.push(U(C));break;case 1:E(f),I(f),C=u(o),o++,0!=C?(L(f,"0x13,0",o),f.code.push("self.tempcallargs[0]="+C+";"),f.code.push("self.enter_function(self.iosysrock, 1);"),l=!0):l="false"}}else if(226==s){var C;switch(t){case 2:for(;C=c(o),o+=4,0!=C;)f.buffer.push(U(C));break;case 1:E(f),I(f),C=c(o),o+=4,0!=C?(L(f,"0x14,0",o),f.code.push("self.tempcallargs[0]="+C+";"),f.code.push("self.enter_function(self.iosysrock, 1);"),l=!0):l="false"}}else j(s>=224&&s<=255?"Attempt to print unknown type of string.":"Attempt to print non-string.");return l?(E(f),f.code.push("return "+l+";"),G(f.code.join("\n"),"_func_str_"+r,"nextcp","substring")):(f.code.length>1&&j("Simple-case string generated code."),f.buffer.join(""))}function me(e,t,r){if(1&r)return d(e,t);switch(t){case 4:return[e>>24&255,e>>16&255,e>>8&255,255&e];case 2:return[e>>8&255,255&e];case 1:return[255&e];default:j("Direct search key must hold one, two, or four bytes.")}}function we(e,t,r,n,i,s,o){var a,l,f,c,d,h,p,_,g=0!=(4&o),m=me(e,t,o);for(l=0,a=i;l<a;){for(d=0,f=r+(c=a+l>>1)*n,h=0;!d&&h<t;h++)(p=u(f+s+h))<(_=m[h])?d=-1:p>_&&(d=1);if(!d)return g?c:f;d<0?l=c+1:a=c}return g?4294967295:0}function ve(e){var t,r,n;return 2147483648&e?(t=!0,e&=2147483647):t=!1,0==e?t?-0:0:2139095040==(2139095040&e)?0==(8388607&e)?t?-1/0:1/0:NaN:(r=(n=e>>23&255)?(8388607&e|8388608)/8388608*Math.pow(2,n-127):(8388607&e)/8388608*Math.pow(2,-126),t?-r:r)}function be(e){var t,r,n,i,s;return isNaN(e)?2139095041:isFinite(e)?0==e?1/e<0?2147483648:0:(e<0?(s=!0,t=-e):(s=!1,t=e),i=Math.floor(Math.log(t)/Math.log(2)),n=t/Math.pow(2,i),i>=128?s?4286578688:2139095040:(i<-126?(n*=Math.pow(2,126+i),i=0):0==i&&0==n||(i+=127,n-=1),(r=(n*=8388608)+.4999999999999999<<0)>=8388608&&(r=0,++i>=255)?s?4286578688:2139095040:s?(2147483648|i<<23|r)>>>0:i<<23|r)):e<0?4286578688:2139095040}e.set_string_table=de,e.set_iosys=he,e.stream_num=pe,e.stream_string=_e,e.do_gestalt=function(e,t){switch(e){case 0:return 196866;case 1:return 131335;case 2:case 3:return 1;case 4:switch(t){case 0:case 1:case 2:return 1;default:return 0}break;case 5:case 6:case 7:return 1;case 8:return Ae;case 9:return 1;case 10:return ae[t]?1:0;case 11:return 1;default:return 0}},e.linear_search=function(e,t,r,n,i,s,o){var a,l,u,f,c=0!=(4&o),h=0!=(2&o),p=me(e,t,o);for(l=0;l<i;l++,r+=n){for(u=!0,f=d(r+s,t),a=0;u&&a<t;a++)f[a]!=p[a]&&(u=!1);if(u)return c?l:r;if(h){for(u=!0,f=d(r+s,t),a=0;u&&a<t;a++)0!=f[a]&&(u=!1);if(u)break}}return c?4294967295:0},e.binary_search=we,e.linked_search=function(e,t,r,n,i,s){for(var o,a,l=0!=(2&s),f=me(e,t,s);0!=r;){for(a=!0,o=0;a&&o<t;o++)u(r+n+o)!=f[o]&&(a=!1);if(a)return r;if(l){for(a=!0,o=0;a&&o<t;o++)0!=u(r+n+o)&&(a=!1);if(a)break}r=c(r+i)}return 0},e.decode_float=ve,e.encode_float=be;var ke,ye,xe,Ue,Ce,Se,Me,je,Ge,Te,ze,qe,Ae,Fe,De,$e=null,Le=null,Ie=null,Ne=null,Ee=null,Be=null;e.frame=null,e.vm_started=!1,e.vm_stopped=!1,e.tempcallargs=null,e.tempglkargs=null,e.done_executing=null,e.random_func=null,e.pc=null,e.stringtable=null,e.endmem=null,e.protectstart=null,e.protectend=null,e.iosysmode=null,e.iosysrock=null,e.prevpc=null,e.resumefuncop=null,e.resumevalue=null;var Re=0,We=0,Oe=0,Pe=0,Qe=0,Ve=0,He=0,Ye=0;function Ze(){rt();var t=et();ke=null,ke=$e.slice(0,je),e.endmem=ke.length,Ke(Ge,!1),tt(t),ye=[],e.frame=null,e.pc=0,e.prevpc=0,e.iosysmode=0,e.iosysrock=0,de(ze),J(Te,0)}function Je(e){for(var t=[],r=0;r<e.length;r++){var n=e[r].key,i=e[r].chunk;4!=n.length&&j("Bad chunk ID (must be exactly 4 chars): "+n),null==i&&j("Missing chunk data: "+n),g(t,n),m(t,i.length),1&(t=t.concat(i)).length&&t.push(0)}return t}function Xe(e){for(var t={},n=0;n<e.length;){if(n+8>e.length)return void r("IFF chunk header is truncated");var i=b(e,n,4),s=o(e,n+4);if((n+=8)+s>e.length)return void r(i+" chunk is truncated ("+s+" bytes needed, "+(e.length-n)+" available");t[i]=e.slice(n,n+s),1&(n+=s)&&(n+=1)}return t}function Ke(t,r){var n;if(t!=e.endmem){if(!r&&nt()&&j("Cannot resize Glulx memory space while heap is active."),t<Ge&&j("Cannot resize Glulx memory space smaller than it started."),255&t&&j("Can only resize Glulx memory space to a 256-byte boundary."),ke.length=t,t>e.endmem)for(n=e.endmem;n<t;n++)ke[n]=0;e.endmem=t}}function et(){if(e.protectstart>=e.protectend)return null;for(var t=e.protectend-e.protectstart,r={start:e.protectstart,end:e.protectend,len:t},n=ke.slice(e.protectstart,e.protectend);n.length<t;)n.push(0);return r.mem=n,r}function tt(t){if(t){var r,n,i=t.mem,s=t.start,o=t.end;for(o>e.endmem&&(o=e.endmem),r=0,n=s;n<o;r++,n++)ke[n]=i[r]}}function rt(){Ae=0,Fe=[],De=[]}function nt(){return Fe.length>0}function it(e,t){this.addr=e,this.size=t,this.end=e+t}function st(e,t){for(var r=0,n=e.length;r<n;){var i=r+n>>1;e[i].addr<t?r=i+1:n=i}return r}function ot(){if(!nt())return 0!=Ae&&j("Heap inconsistency: heapstart nonzero"),Fe.length>0&&j("Heap inconsistency: usedlist nonempty"),void(De.length>0&&j("Heap inconsistency: usedlist nonempty"));0==Ae&&j("Heap inconsistency: heapstart is zero");for(var t=Ae,r=0,n=0;r<Fe.length||n<De.length;){var i=Fe[r],s=De[n];i&&i.addr==t?(t+=i.size,r++):s&&s.addr==t?(t+=s.size,n++):j("Heap inconsistency: no block at address "+t)}t!=e.endmem&&j("Heap inconsistency: overrun at end of heap")}e.vm_restart=Ze,e.vm_save=function(t){ke.length!=e.endmem&&j("Memory length was incorrect before save."),2!=e.iosysmode&&j("Streams are only available in Glk I/O system.");var r=GiDispa.class_obj_from_id("stream",t);if(!r)return!1;var n=[];n.push({key:"IFhd",chunk:$e.slice(0,128)});for(var i,s,o,a=ke.slice(Me),l=Me;l<$e.length;l++)a[l-Me]^=$e[l];(a=function(e){for(var t=[],r=0;r<e.length;){for(var n=0;r<e.length&&0==e[r]&&n<=255;)n++,r++;for(n>0&&(t.push(0),t.push(n-1));r<e.length&&0!=e[r];)t.push(e[r]),r++}return t}(a)).splice(0,0,0,0,0,0),i=a,s=0,o=e.endmem,i[s]=o>>24&255,i[s+1]=o>>16&255,i[s+2]=o>>8&255,i[s+3]=255&o,n.push({key:"CMem",chunk:a});var u=[];for(n.push({key:"Stks",chunk:u}),l=0;l<ye.length;l++)q(ye[l],u);if(nt()){var f=[];n.push({key:"MAll",chunk:f}),m(f,Ae),m(f,Fe.length);for(l=0;l<Fe.length;l++)m(f,Fe[l].addr),m(f,Fe[l].size)}var c=[];g(c,"IFZS"),c=c.concat(Je(n));var d=Je([{key:"FORM",chunk:c}]);return Glk.glk_put_buffer_stream(r,d),!0},e.vm_restore=function(t){2!=e.iosysmode&&j("Streams are only available in Glk I/O system.");var n=GiDispa.class_obj_from_id("stream",t);if(!n)return!1;for(var i=new Array(0),s=new Array(1024),a=1;a>0;)a=Glk.glk_get_buffer_stream(n,s),i=i.concat(s.slice(0,a));if(!(i=Xe(i)))return r("vm_restore failed: file is not Quetzal"),!1;if(!(i=i.FORM)||"IFZS"!=b(i,0,4))return r("vm_restore failed: file doesn't start with FORM/IFZS header"),!1;var l=Xe(i.slice(4));if(!l.IFhd)return r("vm_restore failed: missing required IFhd chunk"),!1;for(var u=0;u<128;u++)if(l.IFhd[u]!=$e[u])return r("vm_restore failed: this save image is for a different game"),!1;if(!l.CMem)return r("vm_restore failed: missing required CMem chunk"),!1;if(!l.Stks)return r("vm_restore failed: missing required Stks chunk"),!1;var f=et();rt();var c=o(l.CMem,0),d=l.CMem.slice(4);for(d=function(e){for(var t=[],r=0;r<e.length;){var n=e[r++];if(0==n)for(var i=e[r++]+1,s=0;s<i;s++)t.push(0);else t.push(n)}return t}(d);d.length<c-Me;)d.push(0);for(Ke(c,!1),ke=$e.slice(0,Me).concat(d),u=Me;u<$e.length;u++)ke[u]^=$e[u];ke.length!=e.endmem&&j("Memory length was incorrect after restore.");var h=l.Stks;for(ye=[];h.length;)e.frame=A(h),e.frame||j("vm_restore failed: bad stack frame"),ye.unshift(e.frame);for(u=0;u<ye.length;u++)ye[u].depth=u;e.frame=ye[ye.length-1];var p=l.MAll;if(p&&p.length>=8){Ae=o(p,0);var _=o(p,4);for(u=0;u<_;u++){var g=o(p,8+8*u),m=o(p,12+8*u);Fe.push(new it(g,m))}Fe.sort((function(e,t){return e.addr-t.addr}));var w=Ae;for(u=0;u<Fe.length;u++){g=Fe[u].addr,m=Fe[u].size;(g<w||g+m>e.endmem)&&j("vm_restore failed: corrupt dynamic heap"),g>w&&De.push(new it(w,g-w)),w=g+m}w<e.endmem&&De.push(new it(w,e.endmem-w))}return ot(),tt(f),!0},e.vm_saveundo=function(){ke.length!=e.endmem&&j("Memory length was incorrect before saveundo.");var t,r,n={};n.ram=ke.slice(Me),n.endmem=e.endmem,n.pc=e.pc,n.stack=[];for(var i=0;i<ye.length;i++)n.stack[i]=(t=ye[i],r=void 0,(r=new z(t.vmfunc)).depth=t.depth,r.framestart=t.framestart,r.framelen=t.framelen,r.valstack=t.valstack.slice(0),r.localspos=t.localspos,r.locals=t.locals.slice(0),r.framelen=t.framelen,r);n.heapstart=Ae,n.usedlist=Fe.slice(0),n.freelist=De.slice(0),qe.push(n),qe.length>10&&qe.shift()},e.vm_restoreundo=function(){if(0==qe.length)return!1;var t=qe.pop(),r=et();return ke=ke.slice(0,Me).concat(t.ram),e.endmem=t.endmem,ye=t.stack,e.frame=ye[ye.length-1],e.pc=t.pc,Ae=t.heapstart,Fe=t.usedlist,De=t.freelist,tt(r),ke.length!=e.endmem&&j("Memory length was incorrect after undo."),ot(),!0},e.change_memsize=Ke,e.perform_verify=function(){var e,t,r,n=$e.length;if(n<256||0!=(255&n))return 1;if(n!=o($e,12))return 1;for(t=-(r=o($e,32))>>>0,e=0;e<n;e+=4)t=t+o($e,e)>>>0;return t!=r?1:0},e.heap_malloc=function(t){nt()||(Ae=e.endmem);for(var r=0,n=De.length;r<n;r++){var i=De[r];if(i.size>=t){i.size>t?De[r]=new it(i.addr+t,i.size-t):De.splice(r,1);var s=st(Fe,i.addr);return Fe.splice(s,0,new it(i.addr,t)),i.addr}}var o=e.endmem,a=t+255&4294967040;return Ke(e.endmem+a,!0),a>t&&De.push(new it(o+t,a-t)),Fe.push(new it(o,t)),o},e.heap_free=function(e){var t=st(Fe,e),r=Fe[t];if(r&&r.addr==e||j("Tried to free non-existent block"),Fe.splice(t,1),0==Fe.length)return Ke(Ae,!0),void rt();t=st(De,e);var n=De[t];n&&n.addr==r.end&&(r=new it(e,r.size+n.size),De.splice(t,1));var i=De[t-1];i&&i.end==r.addr&&(r=new it(i.addr,i.size+r.size),De.splice(t-1,1),t-=1),De.splice(t,0,r)},e.assert_heap_valid=ot;var at={map:{},functions:[],functionmap:{}};function lt(){var t,n,i,s,o;for(e.resumefuncop&&(!function(t,r){if(t)switch(t.mode){case 8:return void e.frame.valstack.push(r);case 0:return;case 11:return void(4==t.argsize?e.frame.locals[t.addr]=r:2==t.argsize?e.frame.locals[t.addr]=65535&r:e.frame.locals[t.addr]=255&r);case 15:return void(4==t.argsize?_(t.addr,r):2==t.argsize?p(t.addr,r):h(t.addr,r));default:j("Unknown addressing mode in store func by operand.")}}(e.resumefuncop,e.resumevalue),e.resumefuncop=null,e.resumevalue=0),s=(new Date).getTime();!e.done_executing;){void 0===(i=(n=(t=e.frame.vmfunc)[e.iosysmode])[e.pc])&&(t.pathaddrs[e.pc]=!0,i=Z(t,e.pc,e.iosysmode),Ve++,e.pc<Me&&(n[e.pc]=i,Qe++)),Pe++,i(e)===e.VMStopped&&(e.done_executing=!0,e.vm_stopped=!0)}o=(new Date).getTime(),Re+=(o-s)/1e3,e.vm_stopped&&Glk.glk_exit(),Glk.update(),Ie&&r("event executed in "+(o-s)+" ms")}return e.VMStopped={dummy:"The top-level function has returned."},{version:"2.1.7",prepare:function(e,t){var n,i,s=($e=e).slice(0,64);for(n=0;n<s.length;n++)(i=s[n].toString(16)).length<2&&(i="0"+i),s[n]=i;Le=s.join(""),t&&(Ie=t.log_execution_time,Ne=t.rethrow_exceptions,Ee=t.do_vm_autosave,Be=t.clear_vm_autosave),t&&t.debug_info_chunk&&function(){var e,t,n,i=GiLoad.get_debug_info();if(!i)return;if(222!=i[0]||191!=i[1]||0!=i[2]||0!=i[3])return void r("Dbug chunk did not contain an (old-style) Inform gameinfo.dbg file");i[4],i[5];t=6,e=!1;for(;!e;){var s=i[t++];switch(s){case 0:case void 0:e=!0;break;case 1:i[t++];for(n=t;i[t];)t++;String.fromCharCode.apply(this,i.slice(n,t));for(t++,n=t;i[t];)t++;String.fromCharCode.apply(this,i.slice(n,t));t++;break;case 2:for(n=t;i[t];)t++;String.fromCharCode.apply(this,i.slice(n,t));t++;i.slice(t,t+4);t+=4;i.slice(t,t+4);t+=4;break;case 3:i[t++],i[t++];for(n=t;i[t];)t++;String.fromCharCode.apply(this,i.slice(n,t));t++;i.slice(t,t+4);t+=4;i.slice(t,t+4);t+=4;break;case 4:i[t++];for(n=t;i[t];)t++;var o=String.fromCharCode.apply(this,i.slice(n,t));t++;break;case 5:i[t++],i[t++];for(n=t;i[t];)t++;o=String.fromCharCode.apply(this,i.slice(n,t));t++;break;case 6:i[t++],i[t++];for(n=t;i[t];)t++;o=String.fromCharCode.apply(this,i.slice(n,t));t++;break;case 7:i[t++],i[t++];for(n=t;i[t];)t++;o=String.fromCharCode.apply(this,i.slice(n,t));t++;break;case 8:i[t++],i[t++];for(n=t;i[t];)t++;o=String.fromCharCode.apply(this,i.slice(n,t));t++;break;case 9:t+=64;break;case 10:var a=i[t++]<<8|i[t++],l=i[t++]<<8|i[t++];t+=6*l;break;case 11:a=i[t++]<<8|i[t++],i.slice(t,t+4);t+=4;var u=i[t++]<<16|i[t++]<<8|i[t++];for(n=t;i[t];)t++;var f=String.fromCharCode.apply(this,i.slice(n,t));t++;for(var c=[];i[t];){for(n=t;i[t];)t++;var d=String.fromCharCode.apply(this,i.slice(n,t));t++,c.push(d)}t++,at.functions.push({num:a,name:f,addr:u,locals:c});break;case 12:i[t++],i[t++];for(n=t;i[t];)t++;o=String.fromCharCode.apply(this,i.slice(n,t));t++;break;case 13:for(;i[t];){for(n=t;i[t];)t++;o=String.fromCharCode.apply(this,i.slice(n,t));t++;var h=i[t++]<<16|i[t++]<<8|i[t++];at.map[o]=h}t++;break;case 14:a=i[t++]<<8|i[t++],i.slice(t,t+4);t+=4;i[t++],i[t++],i[t++];break;default:r("Unknown record type in debug data: "+s),e=!0}}var p,_=at.map["code area"];if(_)for(p=0;p<at.functions.length;p++){var g=at.functions[p];at.functionmap[_+g.addr]=g}}()},init:function(){if(e.vm_started)Glk.fatal_error("Quixe was inited twice!");else try{!function(){var e,t;for(e=0;e<256;e++)t=e.toString(16),e<16&&(t="0"+t),i[e]=t;for(e=0;e<256;e++)t=e>=32&&e<127?34==e||39==e||92==e?"\\"+String.fromCharCode(e):String.fromCharCode(e):10==e?"\\n":"\\x"+i[e],s[e]=t}(),function(){function e(e,t){this.argsize=t||4,this.numops=e.length;for(var r=[],n=0;n<e.length;n++)r.push(e.charAt(n));this.formlist=r}var t=new e(""),r=new e("L"),n=new e("LL"),i=new e("LLL"),s=new e("LLLL"),o=new e("LS"),a=new e("LLS"),l=new e("LLLLLLS"),u=new e("LLLLLLLS"),f=new e("LLSS"),c=new e("LC"),d=new e("LLC"),h=new e("LLLC"),p=new e("LLLLC"),_=new e("ES"),g=new e("LES"),m=new e("EES"),w=new e("F"),v=new e("LF"),b=new e("LLF"),k=new e("EF"),y=new e("EF",1),x=new e("EF",2),U=new e("S"),C=new e("SS"),S=new e("CL"),M=new e("C");D={0:t,16:m,17:g,18:a,19:a,20:a,21:_,24:m,25:m,26:m,27:_,28:a,29:a,30:a,32:r,34:n,35:n,36:i,37:i,38:i,39:i,40:i,41:i,42:i,43:i,44:i,45:i,48:d,49:r,50:S,51:n,52:n,64:k,65:x,66:y,68:o,69:o,72:a,73:a,74:a,75:a,76:i,77:i,78:i,79:i,80:w,81:v,82:t,83:n,84:r,112:r,113:r,114:r,115:r,256:a,257:r,258:U,259:o,260:r,272:o,273:r,288:t,289:U,290:t,291:c,292:v,293:M,294:w,295:n,304:b,320:U,321:r,328:C,329:n,336:u,337:u,338:l,352:c,353:d,354:h,355:p,368:n,369:i,376:o,377:r,384:n,385:n,400:o,401:o,402:o,408:o,409:o,416:a,417:a,418:a,419:a,420:f,424:o,425:o,426:o,427:a,432:o,433:o,434:o,435:o,436:o,437:o,438:a,448:s,449:s,450:i,451:i,452:i,453:i,456:n,457:n}}(),function(){var n;$e||j("There is no Glulx game file loaded.");e.vm_started=!0,e.resumefuncop=null,e.resumevalue=0,ke=null,ye=[],e.frame=null,e.pc=0,e.prevpc=0,$e.length<36&&j("This is too short to be a valid Glulx file.");1198290284!=o($e,0)&&j("This is not a valid Glulx file.");(n=o($e,4))<131072&&j("This Glulx file is too old a version to execute.");n>=197120&&j("This Glulx file is too new a version to execute.");Me=o($e,8),je=o($e,12),Ge=o($e,16),o($e,20),Te=o($e,24),ze=o($e,28),o($e,32),e.protectstart=0,e.protectend=0,(Me<256||je<Me||Ge<je)&&j("The segment boundaries in the header are in an impossible order.");je!=$e.length&&j("The game file length does not agree with the header.");e.done_executing=!1,xe={},Ue={},Ce=void 0,Se=void 0,e.tempcallargs=Array(8),e.tempglkargs=Array(8),K(0),e.endmem=Ge,e.stringtable=0,qe=[],Ae=0,Fe=[],De=[],Be&&Dialog.autosave_write(Le,null);if(Ee&&!Be)try{var i=Dialog.autosave_read(Le);if(i)return r("Found autosave..."),void function(t){ke=(ke=$e.slice(0,je)).slice(0,Me).concat(t.ram),e.endmem=t.endmem,e.pc=t.pc,ye=[];var r=t.stack.slice(0);for(;r.length;){var n=A(r);n||j("vm_autorestore failed: bad stack frame"),ye.unshift(n)}for(var i=0;i<ye.length;i++)ye[i].depth=i;if(e.frame=ye[ye.length-1],void 0===t.heapstart)Ae=0,Fe=[],De=[];else{Ae=t.heapstart,Fe=[];for(var s=0;s<t.usedlist.length;s+=2){var o=t.usedlist[s],a=t.usedlist[s+1];Fe.push(new it(o,a))}Fe.sort((function(e,t){return e.addr-t.addr})),De=[];var l=Ae;for(i=0;i<Fe.length;i++){o=Fe[i].addr,a=Fe[i].size;(o<l||o+a>e.endmem)&&j("vm_autorestore failed: corrupt dynamic heap"),o>l&&De.push(new it(l,o-l)),l=o+a}l<e.endmem&&De.push(new it(l,e.endmem-l))}ot(),de(t.stringtable),he(t.iosysmode,t.iosysrock),e.protectstart=t.protectstart,e.protectend=t.protectend,void 0===t.srand_table?K(0):(K(1),re=t.srand_table.slice(0),ee=t.srand_index1,te=t.srand_index2);for(var s in oe=t.accel_params.slice(0),t.accel_funcnum_map)se[s]=t.accel_funcnum_map[s],ie[s]=e.accel_func_map[se[s]];Glk.restore_allstate(t.glk),X(0)}(i)}catch(e){r("Autorestore failed, deleting it: "+t(e)),e.stack&&r("JS stack dump:\n"+e.stack),Dialog.autosave_write(Le,null)}Ze()}(),lt()}catch(e){if(e.stack&&r("JS stack dump:\n"+e.stack),n(),Glk.fatal_error("Quixe init: "+t(e)),Ne)throw e}},resume:function(i){try{e.done_executing=e.vm_stopped,lt()}catch(e){if(e.stack&&r("JS stack dump:\n"+e.stack),n(),Glk.fatal_error("Quixe run: "+t(e)),Ne)throw e}},get_signature:function(){return Le},get_vm_internals:function(){return e},get_statistics:function(){return{game_image_length:$e.length,total_execution_time:Re,total_function_calls:We,accel_function_calls:Oe,total_path_calls:Pe,paths_cached:Qe,paths_compiled:Ve,strings_cached:He,strings_compiled:Ye}},get_debuginfo:function(){return at},ReadByte:function(t){return 4294967295==t?255&e.frame.valstack.pop():u(t)},WriteByte:function(t,r){4294967295==t?e.frame.valstack.push(255&r):h(t,r)},ReadWord:function(t){return 4294967295==t?e.frame.valstack.pop():c(t)},WriteWord:function(t,r){4294967295==t?e.frame.valstack.push(r):_(t,r)},ReadStructField:function(t,r){return 4294967295==t?e.frame.valstack.pop():c(t+4*r)},WriteStructField:function(t,r,n){4294967295==t?e.frame.valstack.push(n):_(t+4*r,n)},SetResumeStore:function(t){e.resumevalue=t},do_autosave:function(t){if(t<0)Dialog.autosave_write(Le,null);else{var n,i,s=(n=e.prevpc,i=u(n),n++,128&i&&(64&i?(i=(i=(i=(i&=63)<<8|u(n))<<8|u(++n))<<8|u(++n),n++):(i=(i&=127)<<8|u(n),n++)),304!=i?(r("parse_partial_operand: parsed wrong opcode: "+i),null):{selop:15&u(n),argsop:u(n)>>4&15,resop:15&u(n+1)});if(s){var o={},a=e.frame.valstack,l=a.length;a.push(t),8==s.argsop&&a.push(1),8==s.selop&&a.push(192),a.push(0,0,e.prevpc,e.frame.framestart),o.ram=ke.slice(Me),o.endmem=e.endmem,o.pc=e.pc,o.stack=[];for(var f=0;f<ye.length;f++)q(ye[f],o.stack);if(nt()){o.heapstart=Ae,o.usedlist=[];for(f=0;f<Fe.length;f++)o.usedlist.push(Fe[f].addr),o.usedlist.push(Fe[f].size)}for(var c in a.length=l,o.stringtable=e.stringtable,o.iosysmode=e.iosysmode,o.iosysrock=e.iosysrock,o.protectstart=e.protectstart,o.protectend=e.protectend,e.random_func==ne&&re&&(o.srand_table=re.slice(0),o.srand_index1=ee,o.srand_index2=te),o.accel_params=oe.slice(0),o.accel_funcnum_map={},se)o.accel_funcnum_map[c]=se[c];o.glk=Glk.save_allstate(),Dialog.autosave_write(Le,o)}}}}}();try{t.Quixe=r}catch(e){}},function(e,t,r){"use strict";const n=r(4),i=r(0),s=i.extend,o=i.U2S16,a=i.S2U16;function l(e){const t=e=>"object"==typeof e?l(e):e,r={};if(Array.isArray(e))return e.map(t);for(let n in e)"buffer"!==n&&"str"!==n&&(r[n]=t(e[n]));return r}const u=(f=new Uint8Array(2),new Uint16Array(f.buffer)[0]=1,1===f[0]);var f;function c(e,t,r,n){if(u&&!n)for(;t<r;)e.setUint16(t,e.getUint16(t,1)),t+=2}e.exports={art_shift:function(e,t){return t>0?e<<t:e>>-t},call:function(e,t,r,n){if(0===e)return t>=0&&this.variable(t,0),this.pc=r;this.pc=e*this.addr_multipler;var i=this.m.getUint8(this.pc++),s=this.stack,o=0,a=this.frameptr;for(s.setUint16(a+6,this.sp),this.frames.push(a),a=this.frameptr=this.s.byteOffset+2*this.sp,s.setUint32(a,r<<8),s.setUint8(a+3,(t>=0?0:16)|i),s.setUint8(a+4,t>=0?t:0),s.setUint8(a+5,(1<<n.length)-1),this.make_stacks(),this.sp=0;o<i;)this.l[o]=o<n.length?n[o]:this.version<5?this.m.getUint16(this.pc+2*o):0,o++;this.version<5&&(this.pc+=2*i)},clear_attr:function(e,t){var r=this.objects+(this.version3?9:14)*e+t/8|0;this.ram.setUint8(r,this.m.getUint8(r)&~(128>>t%8))},copy_table:function(e,t,r){r=o(r);var n=this.ram,i=0,s=r<0;if(r=Math.abs(r),0!==t)if(s)for(;i<r;)n.setUint8(t+i,this.m.getUint8(e+i++));else n.setUint8Array(t,this.m.getUint8Array(e,r));else for(;i<r;)n.setUint8(e+i++,0)},do_autorestore:function(e){const t=this.Glk;t.restore_allstate(e.glk),this.io=e.io;const r=new t.RefBox;let n;for(;n=t.glk_window_iterate(n,r);)201===r.value&&(this.mainwin=n,n.linebuf&&(e.read_data.buffer=n.linebuf)),202===r.value&&(this.statuswin=n),203===r.value&&(this.upperwin=n);for(n=null;n=t.glk_stream_iterate(n,r);)210===r.value&&(this.io.streams[2].str=n),211===r.value&&(this.io.streams[4].str=n);this.restart(),this.restore_file(new Uint8Array(e.ram),1),this.read_data=e.read_data,this.xorshift_seed=e.xorshift_seed},do_autosave:function(e){if(!this.options.Dialog)throw new Error("A reference to Dialog is required");let t=null;(e||0)>=0&&(t={glk:this.Glk.save_allstate(),io:l(this.io),ram:this.save_file(this.pc,1),read_data:l(this.read_data),xorshift_seed:this.xorshift_seed}),this.options.Dialog.autosave_write(this.signature,t)},encode_text:function(e,t,r,n){this.ram.setUint8Array(n,this.encode(this.m.getUint8Array(e+r,t)))},extension_table:function(e,t){var r=this.extension;return!r||e>this.extension_count?0:(r+=2*e,void 0===t?this.m.getUint16(r):void this.ram.setUint16(r,t))},find_prop:function(e,t,r){var n,i,s=this.m,o=this.version3,a=0,l=s.getUint16(this.objects+(o?9:14)*e+(o?7:12));for(l+=2*s.getUint8(l)+1;;){if(i=(n=s.getUint8(l))&(o?31:63),a===r)return i;if(i===t)return l+(!o&&128&n?2:1);if(i<t)return 0;a=i,l+=o?2+(n>>5):128&n?(i=63&s.getUint8(l+1))?i+2:66:64&n?3:2}},gestalt:function(e){switch(e){case 1:return 258}return 0},get_child:function(e){return this.version3?this.m.getUint8(this.objects+9*e+6):this.m.getUint16(this.objects+14*e+10)},get_sibling:function(e){return this.version3?this.m.getUint8(this.objects+9*e+5):this.m.getUint16(this.objects+14*e+8)},get_parent:function(e){return this.version3?this.m.getUint8(this.objects+9*e+4):this.m.getUint16(this.objects+14*e+6)},get_prop:function(e,t){var r,n=this.m,i=this.find_prop(e,t);return i?(r=n.getUint8(i-1),n[(this.version3?r>>5:64&r)?"getUint16":"getUint8"](i)):n.getUint16(this.properties+2*(t-1))},get_prop_len:function(e){if(0===e)return 0;var t=this.m.getUint8(e-1);return this.version3?1+(t>>5):128&t?0===(t&=63)?64:t:64&t?2:1},incdec:function(e,t){if(0===e)return this.s[this.sp-1]+=t,this.s[this.sp-1];if(--e<15)return this.l[e]+=t,this.l[e];var r=this.globals+2*(e-15);return this.ram.setUint16(r,this.m.getUint16(r)+t),this.ram.getUint16(r)},indirect:function(e,t){return 0===e?arguments.length>1?this.s[this.sp-1]=t:this.s[this.sp-1]:this.variable(e,t)},insert_obj:function(e,t){this.remove_obj(e),this.set_family(e,t,t,e,e,this.get_child(t))},jeq:function(){for(var e=1;e<arguments.length;)if(arguments[e++]===arguments[0])return 1},jin:function(e,t){return this.get_parent(e)===t},log:function(e){this.options.GlkOte&&this.options.GlkOte.log(e)},log_shift:function(e,t){return t>0?e<<t:e>>>-t},make_stacks:function(){var e=15&this.stack.getUint8(this.frameptr+3);this.l=new Uint16Array(this.stack.buffer,this.frameptr+8,e),this.s=new Uint16Array(this.stack.buffer,this.frameptr+8+2*e)},put_prop:function(e,t,r){var n,i=this.find_prop(e,t);i&&(n=this.m.getUint8(i-1),this.ram[(this.version3?n>>5:64&n)?"setUint16":"setUint8"](i,r))},random:function(e){var t=this.xorshift_seed;return e<1?(this.xorshift_seed=e,0):0===t?1+Math.random()*e|0:(t^=t<<13,t^=t>>17,this.xorshift_seed=t^=t<<5,1+(32767&t)%e)},remove_obj:function(e){var t,r,n,i=this.get_parent(e);if(0!==i)if(t=this.get_child(i),r=this.get_sibling(e),t===e)this.set_family(e,0,i,r);else{for(;(n=this.get_sibling(t))!==e;)t=n;this.set_family(e,0,0,0,t,r)}},restart:function(){var e=this.ram,t=e.getUint8(0),n=3===t,o=n?2:8===t?8:4,a=e.getUint8(17),l=e.getUint16(10),u=t>4?e.getUint16(54):0,f=i.MemoryView(this.options.stack_len);e.setUint8Array(0,this.origram),e.setUint8(17,a),s(this,{stack:f,frameptr:0,frames:[],s:new Uint16Array(f.buffer,8),sp:0,l:[],undo:[],undo_len:0,glk_blocking_call:null,version:t,version3:n,pc:e.getUint16(6),properties:l,objects:l+(n?53:112),globals:e.getUint16(12),eof:(e.getUint16(26)||65536)*o,extension:u,extension_count:u?e.getUint16(u):0,addr_multipler:o,opcodes:r(10)(t)}),this.init_text(),this.init_io(),this.update_header()},restore:function(e){this.pc=e,this.fileref_create_by_prompt({func:"restore",mode:2,usage:1})},restore_file:function(e,t){var r,i=this.ram,s=new n.Quetzal(e),o=s.memory,a=this.stack,l=i.getUint8(17),u=0,f=0;if(i.getUint16(2)!==s.release||i.getUint16(28)!==s.checksum)return 0;for(;u<6;)if(i.getUint8(18+u)!==s.serial[u++])return 0;if(u=0,i.setUint8Array(0,this.origram),s.compressed)for(;u<o.length;)0===(r=o[u++])?f+=1+o[u++]:i.setUint8(f,r^this.origram[f++]);else i.setUint8Array(0,o);for(i.setUint8(17,l),a.setUint8Array(0,s.stacks),this.frames=[],u=0;u<s.stacks.byteLength;)this.frameptr=u,this.frames.push(u),c(a,f=u+8,f+=2*(15&a.getUint8(u+3)),t),c(a,f,f+=2*a.getUint16(u+6),t),u=f;return this.frames.pop(),this.sp=a.getUint16(this.frameptr+6),this.make_stacks(),this.pc=s.pc,this.update_header(),this.version3&&this.split_window(0),2},restore_undo:function(){if(0===this.undo.length)return 0;var e=this.undo.pop();return this.frameptr=e.frameptr,this.pc=e.pc,this.undo_len-=e.ram.byteLength+e.stack.byteLength,e.ram[17]=this.m.getUint8(17),this.ram.setUint8Array(0,e.ram),this.frames=e.frames,this.sp=e.sp,this.stack.setUint8Array(0,e.stack),this.make_stacks(),this.variable(e.var,2),1},ret:function(e){var t=this.stack,r=this.frameptr,n=16&t.getUint8(r+3)?-1:t.getUint8(r+4);this.pc=t.getUint32(r)>>8,r=this.frameptr=this.frames.pop(),this.make_stacks(),this.sp=t.getUint16(r+6),n>=0&&this.variable(n,e||0)},save:function(e){this.pc=e,this.fileref_create_by_prompt({func:"save",mode:1,usage:1})},save_file:function(e,t){var r,s,o,a=this.m,l=new n.Quetzal,f=i.MemoryView(this.stack.buffer.slice()),d=0,h=this.frameptr;if(l.release=a.getUint16(2),l.serial=a.getUint8Array(18,6),l.checksum=a.getUint16(28),l.pc=e,t)l.memory=this.m.getUint8Array(0,this.staticmem);else{const e=[];for(l.compressed=1,r=0;r<this.staticmem;r++)0===(o=a.getUint8(r)^this.origram[r])?256==++d&&(e.push(0,255),d=0):(d&&(e.push(0,d-1),d=0),e.push(o));l.memory=e}if(f.setUint16(h+6,this.sp),u&&!t){const e=this.frames.slice();for(e.push(h),r=0;r<e.length;r++)c(f,s=(h=e[r])+8,s+=2*(15&f.getUint8(h+3))),c(f,s,s+=2*f.getUint16(h+6))}return l.stacks=f.getUint8Array(0,this.frameptr+8+2*(15&f.getUint8(h+3))+2*this.sp),l.write()},save_restore_handler:function(e){var t,r,n,i=this.m,s=this.Glk,o=0,a=[];e&&("save"===this.fileref_data.func?(s.glk_put_buffer_stream(e,new Uint8Array(this.save_file(this.pc))),o=1):(a=new Uint8Array(131072),s.glk_get_buffer_stream(e,a),o=this.restore_file(a.buffer)),s.glk_stream_close(e)),this.version3?(r=128&(t=i.getUint8(this.pc++)),n=64&t?63&t:(t<<8|i.getUint8(this.pc++))<<18>>18,!o==!r&&(0===n||1===n?this.ret(n):this.pc+=n-2)):this.variable(i.getUint8(this.pc++),o)},save_undo:function(e,t){var r;return this.undo_len>this.options.undo_len&&(r=this.undo.shift(),this.undo_len-=r.ram.byteLength+r.stack.byteLength),r={frameptr:this.frameptr,frames:this.frames.slice(),pc:e,ram:this.m.getUint8Array(0,this.staticmem),sp:this.sp,stack:this.stack.getUint8Array(0,this.s.byteOffset+2*this.sp),var:t},this.undo_len+=r.ram.byteLength+r.stack.byteLength,this.undo.push(r),1},scan_table:function(e,t,r,n){var i=128&(n=n||130)?"getUint16":"getUint8";for(r=t+r*(n&=127);t<r;){if(this.m[i](t)===e)return t;t+=n}return 0},set_attr:function(e,t){var r=this.objects+(this.version3?9:14)*e+t/8|0;this.ram.setUint8(r,this.m.getUint8(r)|128>>t%8)},set_family:function(e,t,r,n,i,s){var o=this.ram,a=this.objects;this.version3?(o.setUint8(a+9*e+4,t),r&&o.setUint8(a+9*r+6,n),i&&o.setUint8(a+9*i+5,s)):(o.setUint16(a+14*e+6,t),r&&o.setUint16(a+14*r+10,n),i&&o.setUint16(a+14*i+8,s))},test:function(e,t){return(e&t)===t},test_attr:function(e,t){return this.m.getUint8(this.objects+(this.version3?9:14)*e+t/8|0)<<t%8&128},variable:function(e,t){var r,n=void 0!==t;if(0===e){if(!n)return this.s[--this.sp];this.s[this.sp++]=t}else if(--e<15){if(!n)return this.l[e];this.l[e]=t}else{if(r=this.globals+2*(e-15),!n)return this.m.getUint16(r);this.ram.setUint16(r,t)}return t},U2S:o,S2U:a}},function(e,t,r){"use strict";var n=r(5),i=n.Variable,s=n.Opcode,o=n.Stopper,a=n.Pauser,l=n.PauserStorer,u=n.Brancher,f=n.BrancherStorer,c=n.Storer,d=n.Caller,h=n.CallerStorer,p=n.opcode_builder,_=function(e){return""+e},g=new i(this.e,0),m=p(u,(function(){return 1})),w=p(c,(function(e){return"e.S2U(~"+e+")"})),v=c.subClass({storer:0,post:function(){var e=this.operands,t=e[0],r=t instanceof i;e[0]=new i(this.e,r?t:t.v),(r||0===t.v)&&(e[0].indirect=1),this.storer=142===this.code?e.pop():e.shift(),0===e.length&&e.push(g)},func:_}),b=s.subClass({func:function(e){var t=e.v-1,r=this.code%2?1:-1;return e instanceof i||t>14?"e.incdec("+e+","+r+")":(t<0?"e.s[e.sp-1]":"e.l["+t+"]")+(1===r?"++":"--")}}),k=o.subClass({brancher:1,toString:function(){return"e.stop=1;e."+(181===this.code?"save":"restore")+"("+(this.pc+1)+")"}}),y=p(l,(function(){return"e.restore("+(this.next-1)+")"})),x=p(l,(function(){return"e.save("+(this.next-1)+")"}));e.exports=function(e){return{1:p(u,(function(){return 2===arguments.length?this.args("==="):"e.jeq("+this.args()+")"})),2:p(u,(function(e,t){return e.U2S()+"<"+t.U2S()})),3:p(u,(function(e,t){return e.U2S()+">"+t.U2S()})),4:p(u,(function(e,t){return"e.U2S(e.incdec("+e+",-1))<"+t.U2S()})),5:p(u,(function(e,t){return"e.U2S(e.incdec("+e+",1))>"+t.U2S()})),6:p(u,(function(){return"e.jin("+this.args()+")"})),7:p(u,(function(){return"e.test("+this.args()+")"})),8:p(c,(function(){return this.args("|")})),9:p(c,(function(){return this.args("&")})),10:p(u,(function(){return"e.test_attr("+this.args()+")"})),11:p(s,(function(){return"e.set_attr("+this.args()+")"})),12:p(s,(function(){return"e.clear_attr("+this.args()+")"})),13:v,14:p(s,(function(){return"e.insert_obj("+this.args()+")"})),15:p(c,(function(e,t){return"e.m.getUint16(e.S2U("+e+"+2*"+t.U2S()+"))"})),16:p(c,(function(e,t){return"e.m.getUint8(e.S2U("+e+"+"+t.U2S()+"))"})),17:p(c,(function(){return"e.get_prop("+this.args()+")"})),18:p(c,(function(){return"e.find_prop("+this.args()+")"})),19:p(c,(function(){return"e.find_prop("+this.args(",0,")+")"})),20:p(c,(function(){return"e.S2U("+this.args("+")+")"})),21:p(c,(function(){return"e.S2U("+this.args("-")+")"})),22:p(c,(function(){return"e.S2U("+this.args("*")+")"})),23:p(c,(function(e,t){return"e.S2U(parseInt("+e.U2S()+"/"+t.U2S()+"))"})),24:p(c,(function(e,t){return"e.S2U("+e.U2S()+"%"+t.U2S()+")"})),25:h,26:d,27:p(s,(function(){return"e.set_colour("+this.args()+")"})),28:p(o,(function(e,t){return"while(e.frames.length+1>"+t+"){e.frameptr=e.frames.pop()}return "+e})),128:p(u,(function(e){return e+"===0"})),129:p(f,(function(e){return"e.get_sibling("+e+")"})),130:p(f,(function(e){return"e.get_child("+e+")"})),131:p(c,(function(e){return"e.get_parent("+e+")"})),132:p(c,(function(e){return"e.get_prop_len("+e+")"})),133:b,134:b,135:p(s,(function(e){return"e.print(2,"+e+")"})),136:h,137:p(s,(function(e){return"e.remove_obj("+e+")"})),138:p(s,(function(e){return"e.print(3,"+e+")"})),139:p(o,(function(e){return"return "+e})),140:p(o,(function(e){return"e.pc="+e.U2S()+"+"+(this.next-2)})),141:p(s,(function(e){return"e.print(2,"+e+"*"+this.e.addr_multipler+")"})),142:v.subClass({storer:1}),143:e<5?w:d,176:p(o,(function(){return"return 1"})),177:p(o,(function(){return"return 0"})),178:p(s,(function(e){return"e.print(2,"+e+")"}),{printer:1}),179:p(o,(function(e){return"e.print(2,"+e+");e.print(1,13);return 1"}),{printer:1}),180:s,181:e<4?k:x,182:e<4?k:y,183:p(o,(function(){return"e.erase_window(-1);e.restart()"})),184:p(o,(function(e){return"return "+e}),{post:function(){this.operands.push(g)}}),185:e<5?p(s,(function(){return"s[--e.sp]"})):p(c,(function(){return"e.frames.length+1"})),186:p(a,(function(){return"e.quit=1;e.Glk.glk_exit()"})),187:p(s,(function(){return"e.print(1,13)"})),188:e<4?p(o,(function(){return"e.pc="+this.next+";e.v3_status()"})):s,189:m,191:m,224:h,225:p(s,(function(e,t,r){return"e.ram.setUint16(e.S2U("+e+"+2*"+t.U2S()+"),"+r+")"})),226:p(s,(function(e,t,r){return"e.ram.setUint8(e.S2U("+e+"+"+t.U2S()+"),"+r+")"})),227:p(s,(function(){return"e.put_prop("+this.args()+")"})),228:e<5?p(a,(function(){return"e.read(0,"+this.args()+")"})):p(l,(function(){return"e.read("+this.storer.v+","+this.args()+")"})),229:p(s,(function(e){return"e.print(4,"+e+")"})),230:p(s,(function(e){return"e.print(0,"+e.U2S()+")"})),231:p(c,(function(e){return"e.random("+e.U2S()+")"})),232:p(c,_,{post:function(){this.storer=g},storer:0}),233:v,234:p(s,(function(e){return"e.split_window("+e+")"})),235:p(s,(function(e){return"e.set_window("+e+")"})),236:h,237:p(s,(function(e){return"e.erase_window("+e.U2S()+")"})),238:p(s,(function(e){return"e.erase_line("+e+")"})),239:p(s,(function(e,t){return"e.set_cursor("+e+"-1,"+t+"-1)"})),240:p(s,(function(e){return"e.get_cursor("+e+")"})),241:p(s,(function(e){return"e.set_style("+e+")"})),242:s,243:p(o,(function(){return"e.pc="+this.next+";e.output_stream("+this.args()+")"})),244:p(a,(function(){return"e.input_stream("+this.args()+")"})),245:s,246:p(l,(function(){return"e.read_char("+this.storer.v+","+(this.args()||"1")+")"})),247:p(f,(function(){return"e.scan_table("+this.args()+")"})),248:w,249:d,250:d,251:p(s,(function(){return"e.tokenise("+this.args()+")"})),252:p(s,(function(){return"e.encode_text("+this.args()+")"})),253:p(s,(function(){return"e.copy_table("+this.args()+")"})),254:p(s,(function(){return"e.print_table("+this.args()+")"})),255:p(u,(function(e){return"e.stack.getUint8(e.frameptr+5)&(1<<("+e+"-1))"})),1e3:x,1001:y,1002:p(c,(function(e,t){return"e.S2U(e.log_shift("+e+","+t.U2S()+"))"})),1003:p(c,(function(e,t){return"e.S2U(e.art_shift("+e.U2S()+","+t.U2S()+"))"})),1004:p(c,(function(e){return"e.set_font("+e+")"})),1009:p(c,(function(){return"e.save_undo("+this.next+","+this.storer.v+")"})),1010:p(s,(function(){return"if(e.restore_undo())return"}),{storer:1}),1011:p(s,(function(e){return"e.print(1,"+e+")"})),1012:p(c,(function(){return 3})),1013:p(s,(function(){return"e.set_true_colour("+this.args()+")"})),1014:s.subClass({brancher:1}),1030:p(c,(function(){return"e.gestalt("+this.args()+")"}))}}},function(e,t){e.exports={init_text:function(){var e=this,t=this.m,r=this.version>4&&t.getUint16(52),n=this.extension_table(3),i=n&&t.getUint8(n++);this.abbr_addr=t.getUint16(24),function(t){for(var r=[[],[],[]],n=0;n<78;)r[n/26|0][n%26]=t[n++];r[2][1]=13,e.alphabets=r}(r?t.getUint8Array(r,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ \r0123456789.,!?_#'\"/\\-:()",1)),function(t){for(var r={13:"\r"},n={13:13},i=0;i<t.length;)r[155+i]=String.fromCharCode(t[i]),n[t[i]]=155+i++;for(i=32;i<127;)r[i]=String.fromCharCode(i),n[i]=i++;e.unicode_table=r,e.reverse_unicode_table=n}(n?t.getUint16Array(n,i):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1)),this.dictionaries={},this.dict=t.getUint16(8),this.parse_dict(this.dict)},decode:function(e,t){var r,n,i,s=this.m,o=e,a=[],l=0,u=0,f=[],c=[],d=0;if(this.jit[e])return this.jit[e];for(t=t?t+e:this.eof;e<t&&(r=s.getUint16(e),e+=2,a.push(r>>10&31,r>>5&31,31&r),!(32768&r)););for(;l<a.length;)0===(n=a[l++])?f.push(32):n<4?(i=1,f.push(-1),c.push("+this.abbr("+(32*(n-1)+a[l++])+")+")):n<6?u=n:2===u&&6===n?l+1<a.length&&f.push(a[l++]<<5|a[l++]):n<32&&f.push(this.alphabets[u][n-6]),u=u<4?0:u-3,l%3==0&&(l+=d,d=0);return f=this.zscii_to_text(f,c),i&&(f={toString:Function('return"'+f.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\r/g,"\\r").replace(/\uE000/g,'"')+'"').bind(this)}),o>=this.staticmem&&(this.jit[o]=f),f},encode:function(e){for(var t,r,n=this.alphabets,i=[],s=this.version3?6:9,o=0,a=[];i.length<s;)32===(t=e[o++])?i.push(0):(r=n[0].indexOf(t))>=0?i.push(r+6):(r=n[1].indexOf(t))>=0?i.push(4,r+6):(r=n[2].indexOf(t))>=0?i.push(5,r+6):void 0===t?i.push(5):i.push(5,6,t>>5,31&t);for(i.length=s,o=0;o<s;)a.push(i[o++]<<2|i[o]>>3,(7&i[o++])<<5|i[o++]);return a[a.length-2]|=128,a},zscii_to_text:function(e,t){for(var r,n=0,i=e.length,s=0,o="";n<i;)-1===(r=e[n++])&&(o+=t[s++]),(r=this.unicode_table[r])&&(o+=r);return o},text_to_zscii:function(e,t){for(var r,n=[],i=0,s=e.length;i<s;)r=e.charCodeAt(i++),t||(r=this.reverse_unicode_table[r]||63),n.push(r);return n},parse_dict:function(e){var t,r,n=this.m,i=e,s={},o=n.getUint8(e++);for(s.separators=Array.prototype.slice.call(n.getUint8Array(e,o)),e+=o,t=n.getUint8(e++),r=e+2+t*n.getUint16(e),e+=2;e<r;)s[Array.prototype.toString.call(n.getUint8Array(e,this.version3?4:6))]=e,e+=t;return this.dictionaries[i]=s,s},abbr:function(e){return this.decode(2*this.m.getUint16(this.abbr_addr+2*e))},tokenise:function(e,t,r,n){r=r||this.dict,r=this.dictionaries[r]||this.parse_dict(r);var i,s,o,a,l=this.m,u=this.ram,f=1e3,c=1,d=r.separators,h=[],p=0;for(this.version>4&&(f=l.getUint8(e+c++)+2);c<f&&0!==(i=l.getUint8(e+c));)32===i||d.indexOf(i)>=0?(32!==i&&h.push([[i],c]),s=null):(s||(h.push([[],c]),s=h[h.length-1][0]),s.push(i)),c++;for(o=Math.min(h.length,l.getUint8(t));p<o;)a=r[""+this.encode(h[p][0])],n&&!a||(u.setUint16(t+2+4*p,a||0),u.setUint8(t+4+4*p,h[p][0].length),u.setUint8(t+5+4*p,h[p][1])),p++;u.setUint8(t+1,p)}}},function(e,t,r){"use strict";const n=r(0).U2S16,i=function(){for(var e={4294967289:8,4294967290:13,4294967288:27,4294967292:129,4294967291:130,4294967294:131,4294967293:132,4294967283:146,4294967285:148,4294967284:152,4294967286:154},t=0;t<12;)e[4294967279-t]=133+t++;return e}(),s=[0,2,1,10,4,9,5,6];function o(e){const t=[0,8,16,25,33,41,49,58,66,74,82,90,99,107,115,123,132,140,148,156,165,173,181,189,197,206,214,222,230,239,247,255];return t[31&e]<<16|t[(992&e)>>5]<<8|t[(31744&e)>>10]}const a=[65534,65535,0,29,832,957,22944,31775,30624,32767,23254,17969,11627];e.exports={init_io:function(){this.io=this.io||{reverse:0,bold:0,italic:0,mono:2&this.m.getUint8(17),transcript:1&this.m.getUint8(17),streams:[0,1,{},[],{}],currentwin:0,height:0,maxheight:0,seenheight:0,width:0,row:0,col:0},this.open_windows()},erase_line:function(e){if(1===e){var t=this.io,r=t.row,n=t.col;this._print(Array(t.width-t.col+1).join(" ")),this.set_cursor(r,n)}},erase_window:function(e){e<1&&this.Glk.glk_window_clear(this.mainwin),1!==e&&-2!==e||this.upperwin&&(this.Glk.glk_window_clear(this.upperwin),this.set_cursor(0,0)),-1===e&&this.split_window(0)},fileref_create_by_prompt:function(e){void 0===e.run&&(e.run=1),this.fileref_data=e,this.glk_blocking_call="fileref_create_by_prompt",this.Glk.glk_fileref_create_by_prompt(e.usage,e.mode,e.rock||0)},fix_upper_window:function(){var e=this.Glk,t=this.io;t.seenheight>=t.maxheight&&(t.maxheight=t.height),this.upperwin&&(0===t.maxheight?(e.glk_window_close(this.upperwin),this.upperwin=null):e.glk_window_set_arrangement(e.glk_window_get_parent(this.upperwin),18,t.maxheight,null)),t.seenheight=t.maxheight,t.maxheight=t.height},format:function(){this.Glk.glk_set_style(s[!!this.io.mono|this.io.italic|this.io.bold]),this.Glk.glk_gestalt(4352,0)&&this.Glk.garglk_set_reversevideo(this.io.reverse)},get_cursor:function(e){this.ram.setUint16(e,this.io.row+1),this.ram.setUint16(e+2,this.io.col+1)},handle_char_input:function(e){var t=this.io.streams[4],r=i[e]||this.reverse_unicode_table[e]||63;this.variable(this.read_data.storer,r),1===t.mode&&(t.cache+=r),2===t.mode&&this.Glk.glk_put_char_stream_uni(t.str,r)},handle_create_fileref:function(e){var t,r=this.Glk,n=this.fileref_data;return e&&(t=n.unicode?r.glk_stream_open_file_uni(e,n.mode,n.rock||0):r.glk_stream_open_file(e,n.mode,n.rock||0),r.glk_fileref_destroy(e)),"restore"!==n.func&&"save"!==n.func||this.save_restore_handler(t),"input_stream"===n.func&&(this.io.streams[0]=t),"output_stream"===n.func&&this.output_stream_handler(t),n.run},handle_line_input:function(e,t){var r=this.ram,n=this.read_data,i=this.io.streams,s=String.fromCharCode.apply(null,n.buffer.slice(0,e))+"\n",o=this.text_to_zscii(s.slice(0,-1).toLowerCase());1===i[2].mode&&(i[2].cache+=s),2===i[2].mode&&this.Glk.glk_put_jstring_stream(i[2].str,s),1===i[4].mode&&(i[4].cache+=s),2===i[4].mode&&this.Glk.glk_put_jstring_stream(i[4].str,s),this.version<5?(o.push(0),r.setUint8Array(n.bufaddr+1,o)):(r.setUint8(n.bufaddr+1,e),r.setUint8Array(n.bufaddr+2,o),this.variable(n.storer,isNaN(t)?13:t)),n.parseaddr&&this.tokenise(n.bufaddr,n.parseaddr)},input_stream:function(e){var t=this.io;e&&!t.streams[0]&&this.fileref_create_by_prompt({func:"input_stream",mode:2,rock:212,unicode:1,usage:259}),!e&&t.streams[0]&&(this.Glk.glk_stream_close(t.streams[0]),t.streams[0]=0)},open_windows:function(){if(!this.mainwin){const e=this.Glk,t=[1,2,4,5,6,9,10];for(let r=0;r<7;r++)e.glk_stylehint_set(0,t[r],3,0),e.glk_stylehint_set(0,t[r],4,0),e.glk_stylehint_set(0,t[r],5,0),e.glk_stylehint_set(0,t[r],6,1);e.glk_stylehint_set(0,4,4,1),e.glk_stylehint_set(0,1,5,1),e.glk_stylehint_set(0,5,4,1),e.glk_stylehint_set(0,5,5,1),e.glk_stylehint_set(0,2,6,0),e.glk_stylehint_set(0,9,4,1),e.glk_stylehint_set(0,9,6,0),e.glk_stylehint_set(0,10,5,1),e.glk_stylehint_set(0,10,6,0),e.glk_stylehint_set(0,6,4,1),e.glk_stylehint_set(0,6,5,1),e.glk_stylehint_set(0,6,6,0),this.mainwin=e.glk_window_open(0,0,0,3,201),e.glk_set_window(this.mainwin),this.version3&&(this.statuswin=e.glk_window_open(this.mainwin,18,1,4,202),this.statuswin&&e.garglk_set_reversevideo_stream(e.glk_window_get_stream(this.statuswin),1))}},output_stream:function(e,t,r){var i,s,o=this.ram,a=this.io.streams;1===(e=n(e))&&(a[1]=1),-1===e&&(a[1]=0),2!==e||a[2].mode||(this.fileref_create_by_prompt({func:"output_stream",mode:5,rock:210,run:!r,str:2,unicode:1,usage:258}),a[2].cache="",a[2].mode=1,r||(this.stop=1)),-2===e&&(o.setUint8(17,254&o.getUint8(17)),2===a[2].mode&&this.Glk.glk_stream_close(a[2].str),a[2].mode=this.io.transcript=0),3===e&&a[3].unshift([t,""]),-3===e&&(i=a[3].shift(),s=this.text_to_zscii(i[1]),o.setUint16(i[0],s.length),o.setUint8Array(i[0]+2,s)),4!==e||a[4].mode||(this.fileref_create_by_prompt({func:"output_stream",mode:5,rock:211,str:4,unicode:1,usage:259}),a[4].cache="",a[4].mode=1,this.stop=1),-4===e&&(2===a[4].mode&&this.Glk.glk_stream_close(a[4].str),a[4].mode=0)},output_stream_handler:function(e){var t=this.ram,r=this.io.streams,n=this.fileref_data;2===n.str&&(t.setUint8(17,254&t.getUint8(17)|(e?1:0)),e?(r[2].mode=2,r[2].str=e,this.io.transcript=1,r[2].cache&&this.Glk.glk_put_jstring_stream(r[2].str,r[2].cache)):r[2].mode=this.io.transcript=0),4===n.str&&(e?(r[4].mode=2,r[4].str=e,r[4].cache&&this.Glk.glk_put_jstring_stream(r[4].str,r[4].cache)):r[4].mode=0)},_print:function(e){var t=this.Glk,r=this.io,n=0;if(r.streams[3].length)r.streams[3][0][1]+=e;else if(e=e.replace(/\r/g,"\n"),(1&this.m.getUint8(17))!==r.transcript&&this.output_stream(r.transcript?-2:2,0,1),(2&this.m.getUint8(17))!=(2&r.mono)&&(r.mono^=2,this.format()),r.currentwin&&this.upperwin)for(;n<e.length&&r.row<r.height;)t.glk_put_jstring(e[n++]),r.col++,r.col===r.width&&(r.col=0,r.row++);else r.currentwin||(r.streams[1]&&t.glk_put_jstring(e),1===r.streams[2].mode&&(r.streams[2].cache+=e),2===r.streams[2].mode&&t.glk_put_jstring_stream(r.streams[2].str,e))},print:function(e,t){var r,n;if(0===e&&(n=t),1===e&&(n=String.fromCharCode(t)),2===e&&(n=this.jit[t]||this.decode(t)),3===e&&(r=this.m.getUint16(this.objects+(this.version3?9:14)*t+(this.version3?7:12)),n=this.decode(r+1,2*this.m.getUint8(r))),4===e){if(!this.unicode_table[t])return;n=this.unicode_table[t]}this._print(""+n)},print_table:function(e,t,r,n){r=r||1,n=n||0;for(var i=0;i++<r;)this._print(this.zscii_to_text(this.m.getUint8Array(e,t))+(i<r?"\r":"")),e+=t+n},read:function(e,t,r,n,i){var s,o,a=this.m.getUint8(t);if(this.version3&&(a++,this.v3_status()),(s=Array(a)).fill(0),this.read_data={buffer:s,bufaddr:t,parseaddr:r,routine:i,storer:e,time:n},this.io.streams[0]){if(10===s[(o=this.Glk.glk_get_line_stream_uni(this.io.streams[0],s))-1]&&o--,o)return this._print(String.fromCharCode.apply(null,s.slice(0,o))+"\n"),this.handle_line_input(o),this.stop=0;this.input_stream(0)}this.Glk.glk_request_line_event_uni(this.io.currentwin?this.upperwin:this.mainwin,s,0),this.fix_upper_window()},read_char:function(e,t,r,n){if(this.io.streams[0]){var i=this.Glk.glk_get_char_stream_uni(this.io.streams[0]);if(-1!==i)return this.variable(e,i),this.stop=0;this.input_stream(0)}this.read_data={routine:n,storer:e,time:r},this.Glk.glk_request_char_event_uni(this.io.currentwin?this.upperwin:this.mainwin),this.fix_upper_window()},set_colour:function(e,t){this.set_true_colour(a[e],a[t])},set_cursor:function(e,t){var r=this.io;r.currentwin&&(e>=r.height&&this.split_window(e+1),this.upperwin&&e>=0&&t>=0&&t<r.width&&(this.Glk.glk_window_move_cursor(this.upperwin,t,e),r.row=e,r.col=t))},set_font:function(e){var t=4&this.io.mono?4:1;return 0===e?t:1!==e&&4!==e?0:(e!==t&&(this.io.mono^=4,this.format()),t)},set_style:function(e){var t=this.io;0===e&&(t.reverse=t.bold=t.italic=0,t.mono&=254),1&e&&(t.reverse=1),2&e&&(t.bold=4),4&e&&(t.italic=2),8&e&&(t.mono|=1),this.format()},set_true_colour:function(e,t){const r=this.Glk;if(r.glk_gestalt(4352,0)){let n,i;65534===e?n=-2:65535===e?n=-1:(n=o(e),r.glk_stylehint_set(0,0,7,n)),65534===t?i=-2:65535===t?i=-1:(i=o(t),r.glk_stylehint_set(0,0,8,i)),r.garglk_set_zcolors_stream(this.mainwin.str,n,i),this.upperwin&&r.garglk_set_zcolors_stream(this.upperwin.str,n,i),this.statuswin&&r.garglk_set_zcolors_stream(this.statuswin.str,n,i)}},set_window:function(e){this.io.currentwin=e,e&&this.set_cursor(0,0),this.Glk.glk_set_window(this.upperwin&&e?this.upperwin:this.mainwin),this.format()},split_window:function(e){var t,r=this.Glk,n=this.io,i=n.row,s=n.col,o=n.height;if(n.height=e,this.upperwin&&e>o){for(t=r.glk_window_get_stream(this.upperwin);o<e;)r.glk_window_move_cursor(this.upperwin,0,o++),r.glk_put_jstring_stream(t,Array(n.width+1).join(" "));r.glk_window_move_cursor(this.upperwin,s,i)}e>n.maxheight&&(n.maxheight=e,this.upperwin?r.glk_window_set_arrangement(r.glk_window_get_parent(this.upperwin),18,n.maxheight,null):this.upperwin=r.glk_window_open(this.mainwin,18,n.maxheight,4,203)),e&&(n.row>=e&&this.set_cursor(0,0),this.version3&&r.glk_window_clear(this.upperwin))},update_header:function(){var e=this.ram;if(this.xorshift_seed=0,this.update_screen_size(),this.version3)return e.setUint8(1,143&e.getUint8(1)|(this.statuswin?32:16)|64);e.setUint8(1,28|(this.Glk.glk_gestalt(4352,0)?1:0)),e.setUint8(17,87&e.getUint8(17)),this.version>4&&e.setUint16(38,257),e.setUint16(50,258),this.extension_table(4,0)},update_screen_size:function(){const e=this.Glk,t=new e.RefBox,r=new e.RefBox,n=e.glk_window_open(this.mainwin,18,0,4,0);let i=0,s=0;e.glk_window_get_size(this.mainwin,r,t),i=t.get_value(),this.upperwin&&(e.glk_window_get_size(this.upperwin,r,t),i+=t.get_value()),this.statuswin&&(e.glk_window_get_size(this.statuswin,r,t),i+=t.get_value()),n&&(e.glk_window_get_size(n,r,0),e.glk_window_close(n)),s=r.get_value(),i=Math.min(i,254),s=this.io.width=Math.min(s,255),this.version>3&&(this.ram.setUint8(32,i),this.ram.setUint8(33,s)),this.version>4&&(this.ram.setUint16(34,s),this.ram.setUint16(36,i)),this.io.col>=s&&(this.io.col=s-1)},v3_status:function(){if(this.statuswin){var e,t=this.Glk,r=t.glk_window_get_stream(this.statuswin),n=this.m,i=this.io.width,s=n.getUint16(this.globals+2),o=n.getUint16(this.globals+4),a=n.getUint16(this.objects+9*n.getUint16(this.globals)+7),l=""+this.decode(a+1,2*n.getUint8(a));e=2&n.getUint8(1)?"Time: "+(s%12==0?12:s%12)+":"+(o<10?"0":"")+o+" "+(s>11?"PM":"AM"):"Score: "+s+"  Turns: "+o,t.glk_window_move_cursor(this.statuswin,0,0),t.glk_put_jstring_stream(r,Array(i+1).join(" ")),t.glk_window_move_cursor(this.statuswin,0,0),t.glk_put_jstring_stream(r," "+l.slice(0,i-e.length-4)),t.glk_window_move_cursor(this.statuswin,i-e.length-1,0),t.glk_put_jstring_stream(r,e)}}}},function(e,t,r){var n=r(5);e.exports.disassemble=function(){var e,t,r,i,s,o,a,l=this.m,u=this.opcodes,f=new n.RoutineContext(this,this.pc);function c(e,t){for(var r=0;r<4;r++)t.push((192&e)>>6),e<<=2}for(;;){if(t=e=this.pc,190===(i=l.getUint8(e++))?(o=-1,i=l.getUint8(e++)+1e3):128&i?64&i?(o=-1,32&i||(i&=31)):(o=[(48&i)>>4])[0]<3&&(i&=207):(o=[64&i?2:1,32&i?2:1],i&=31),!u[i])throw this.log(""+f),this.stop=1,new Error("Unknown opcode #"+i+" at pc="+t);for(s=u[i].prototype,-1===o&&(o=[],c(l.getUint8(e++),o),236!==i&&250!==i||c(l.getUint8(e++),o)),a=[],r=0;r<o.length;)0===o[r]&&(a.push(new n.Operand(this,l.getUint16(e))),e+=2),1===o[r]&&a.push(new n.Operand(this,l.getUint8(e++))),2===o[r++]&&a.push(new n.Variable(this,l.getUint8(e++)));if(s.storer&&a.push(new n.Variable(this,l.getUint8(e++))),s.brancher&&(r=l.getUint8(e++),a.push([128&r,64&r?63&r:(r<<8|l.getUint8(e++))<<18>>18])),s.printer)for(a.push(e);e<this.eof&&(r=l.getUint8(e),e+=2,!(128&r)););if(this.pc=e,f.ops.push(new u[i](this,f,i,t,e,a)),r=0,s.stopper&&!r)break}return f}},function(e,t,r){"use strict";r.r(t);var n=r(1),i=function(){var e=null;let t=null,r=null,n=null,i=null;const s={};var o,a,l,u,f,c=!1,d=!1,h=null,p=null,_=0,g=null,m=null;function w(t){var n,o;if(d)return o="### ui is disabled, ignoring event",void(window.console&&console.log&&console.log(o));if(t.gen==_)switch(_+=1,g=t.partial,t.type){case"init":P=t.metrics,t.support&&t.support.forEach(e=>s[e]=1),e.init();break;case"external":{let e=null;u&&(e=u(t.value)),e||"timer"!=t.value||(X=Date.now(),e={type:b.evtype_Timer}),e&&e.type&&v(e);break}case"timer":X=Date.now();v({type:b.evtype_Timer});break;case"hyperlink":!function(t,n){if(!Y)return;var i=null;for(i=R;i&&i.disprock!=t;i=i.next);if(!i||!i.hyperlink_request)return;Y.set_field(0,b.evtype_Hyperlink),Y.set_field(1,i),Y.set_field(2,n),Y.set_field(3,0),i.hyperlink_request=!1,r&&r.prepare_resume(Y);Y=null,e.resume()}(t.window,t.value);break;case"mouse":!function(t,n,i){if(!Y)return;var s=null;for(s=R;s&&s.disprock!=t;s=s.next);if(!s||!s.mouse_request)return;Y.set_field(0,b.evtype_MouseInput),Y.set_field(1,s),Y.set_field(2,n),Y.set_field(3,i),s.mouse_request=!1,r&&r.prepare_resume(Y);Y=null,e.resume()}(t.window,t.x,t.y);break;case"char":!function(t,n){var i;if(!Y)return;var s=null;for(s=R;s&&s.disprock!=t;s=s.next);if(!s||!s.char_request)return;1==n.length?(i=n.charCodeAt(0),s.char_request_uni||(i&=255)):(i=k[n])||(i=b.keycode_Unknown);Y.set_field(0,b.evtype_CharInput),Y.set_field(1,s),Y.set_field(2,i),Y.set_field(3,0),s.char_request=!1,s.char_request_uni=!1,s.input_generation=null,r&&r.prepare_resume(Y);Y=null,e.resume()}(t.window,t.value);break;case"line":!function(t,n,i){var s;if(!Y)return;var o=null;for(o=R;o&&o.disprock!=t;o=o.next);if(!o||!o.line_request)return;n.length>o.linebuf.length&&(n=n.slice(0,o.linebuf.length));o.request_echo_line_input&&(s=o.style,be(o.str,b.style_Input),re(o,n),o.echostr&&ve(o.echostr,n),be(o.str,s),re(o,"\n"),o.echostr&&ve(o.echostr,"\n"));for(s=0;s<n.length;s++)o.linebuf[s]=n.charCodeAt(s);var a=0;i&&k[i]&&(a=k[i]);Y.set_field(0,b.evtype_LineInput),Y.set_field(1,o),Y.set_field(2,n.length),Y.set_field(3,a),r&&r.unretain_array(o.linebuf);o.line_request=!1,o.line_request_uni=!1,o.request_echo_line_input=null,o.input_generation=null,o.linebuf=null,r&&r.prepare_resume(Y);Y=null,e.resume()}(t.window,t.value,t.terminator);break;case"arrange":n={left:(P=t.metrics).outspacingx,top:P.outspacingy,right:P.width-P.outspacingx,bottom:P.height-P.outspacingy},W&&ae(W,n),function(){if(!Y)return;Y.set_field(0,b.evtype_Arrange),Y.set_field(1,null),Y.set_field(2,0),Y.set_field(3,0),r&&r.prepare_resume(Y);Y=null,e.resume()}();break;case"redraw":!function(){if(!Y)return;Y.set_field(0,b.evtype_Redraw),Y.set_field(1,null),Y.set_field(2,0),Y.set_field(3,0),r&&r.prepare_resume(Y);Y=null,e.resume()}();break;case"specialresponse":"fileref_prompt"==t.response&&function(t){var n=t.value,i=p.usage,s=p.rock,o=null;n&&(o=de(n.filename,i,s,n));h=null,p=null,r&&r.prepare_resume(o);e.resume(o)}(t)}else i.log("Input event had wrong generation number: got "+t.gen+", currently at "+_)}function v(t){if(Y){var n=0,i=0;t.val1&&(n=t.val1),t.val2&&(i=t.val2),Y.set_field(0,t.type),Y.set_field(1,null),Y.set_field(2,n),Y.set_field(3,i),r&&r.prepare_resume(Y),Y=null,e.resume()}}var b={gestalt_Version:0,gestalt_CharInput:1,gestalt_LineInput:2,gestalt_CharOutput:3,gestalt_CharOutput_CannotPrint:0,gestalt_CharOutput_ApproxPrint:1,gestalt_CharOutput_ExactPrint:2,gestalt_MouseInput:4,gestalt_Timer:5,gestalt_Graphics:6,gestalt_DrawImage:7,gestalt_Sound:8,gestalt_SoundVolume:9,gestalt_SoundNotify:10,gestalt_Hyperlinks:11,gestalt_HyperlinkInput:12,gestalt_SoundMusic:13,gestalt_GraphicsTransparency:14,gestalt_Unicode:15,gestalt_UnicodeNorm:16,gestalt_LineInputEcho:17,gestalt_LineTerminators:18,gestalt_LineTerminatorKey:19,gestalt_DateTime:20,gestalt_Sound2:21,gestalt_ResourceStream:22,gestalt_GraphicsCharInput:23,gestalt_GarglkText:4352,keycode_Unknown:4294967295,keycode_Left:4294967294,keycode_Right:4294967293,keycode_Up:4294967292,keycode_Down:4294967291,keycode_Return:4294967290,keycode_Delete:4294967289,keycode_Escape:4294967288,keycode_Tab:4294967287,keycode_PageUp:4294967286,keycode_PageDown:4294967285,keycode_Home:4294967284,keycode_End:4294967283,keycode_Func1:4294967279,keycode_Func2:4294967278,keycode_Func3:4294967277,keycode_Func4:4294967276,keycode_Func5:4294967275,keycode_Func6:4294967274,keycode_Func7:4294967273,keycode_Func8:4294967272,keycode_Func9:4294967271,keycode_Func10:4294967270,keycode_Func11:4294967269,keycode_Func12:4294967268,keycode_MAXVAL:28,evtype_None:0,evtype_Timer:1,evtype_CharInput:2,evtype_LineInput:3,evtype_MouseInput:4,evtype_Arrange:5,evtype_Redraw:6,evtype_SoundNotify:7,evtype_Hyperlink:8,evtype_VolumeNotify:9,style_Normal:0,style_Emphasized:1,style_Preformatted:2,style_Header:3,style_Subheader:4,style_Alert:5,style_Note:6,style_BlockQuote:7,style_Input:8,style_User1:9,style_User2:10,style_NUMSTYLES:11,wintype_AllTypes:0,wintype_Pair:1,wintype_Blank:2,wintype_TextBuffer:3,wintype_TextGrid:4,wintype_Graphics:5,winmethod_Left:0,winmethod_Right:1,winmethod_Above:2,winmethod_Below:3,winmethod_DirMask:15,winmethod_Fixed:16,winmethod_Proportional:32,winmethod_DivisionMask:240,winmethod_Border:0,winmethod_NoBorder:256,winmethod_BorderMask:256,fileusage_Data:0,fileusage_SavedGame:1,fileusage_Transcript:2,fileusage_InputRecord:3,fileusage_TypeMask:15,fileusage_TextMode:256,fileusage_BinaryMode:0,filemode_Write:1,filemode_Read:2,filemode_ReadWrite:3,filemode_WriteAppend:5,seekmode_Start:0,seekmode_Current:1,seekmode_End:2,stylehint_Indentation:0,stylehint_ParaIndentation:1,stylehint_Justification:2,stylehint_Size:3,stylehint_Weight:4,stylehint_Oblique:5,stylehint_Proportional:6,stylehint_TextColor:7,stylehint_BackColor:8,stylehint_ReverseColor:9,stylehint_NUMHINTS:10,stylehint_just_LeftFlush:0,stylehint_just_LeftRight:1,stylehint_just_Centered:2,stylehint_just_RightFlush:3,imagealign_InlineUp:1,imagealign_InlineDown:2,imagealign_InlineCenter:3,imagealign_MarginLeft:4,imagealign_MarginRight:5,zcolor_Default:-1,zcolor_Current:-2},k={left:b.keycode_Left,right:b.keycode_Right,up:b.keycode_Up,down:b.keycode_Down,return:b.keycode_Return,delete:b.keycode_Delete,escape:b.keycode_Escape,tab:b.keycode_Tab,pageup:b.keycode_PageUp,pagedown:b.keycode_PageDown,home:b.keycode_Home,end:b.keycode_End,func1:b.keycode_Func1,func2:b.keycode_Func2,func3:b.keycode_Func3,func4:b.keycode_Func4,func5:b.keycode_Func5,func6:b.keycode_Func6,func7:b.keycode_Func7,func8:b.keycode_Func8,func9:b.keycode_Func9,func10:b.keycode_Func10,func11:b.keycode_Func11,func12:b.keycode_Func12},y=null,x={0:"normal",1:"emphasized",2:"preformatted",3:"header",4:"subheader",5:"alert",6:"note",7:"blockquote",8:"input",9:"user1",10:"user2"},U={0:"data",1:"save",2:"transcript",3:"command"},C={181:924,223:[83,83],255:376,305:73,329:[700,78],383:83,405:502,414:544,447:503,454:452,457:455,460:458,477:398,496:[74,780],499:497,595:385,596:390,598:393,599:394,601:399,603:400,608:403,611:404,616:407,617:406,623:412,626:413,629:415,640:422,643:425,648:430,650:433,651:434,658:439,837:921,912:[921,776,769],940:902,941:904,942:905,943:906,944:[933,776,769],962:931,972:908,973:910,974:911,976:914,977:920,981:934,982:928,1008:922,1010:1017,1013:917,1415:[1333,1362],7830:[72,817],7831:[84,776],7832:[87,778],7833:[89,778],7834:[65,702],7835:7776,8016:[933,787],8018:[933,787,768],8020:[933,787,769],8022:[933,787,834],8048:8122,8049:8123,8050:8136,8051:8137,8052:8138,8053:8139,8054:8154,8055:8155,8056:8184,8057:8185,8058:8170,8059:8171,8060:8186,8061:8187,8064:[7944,921],8065:[7945,921],8066:[7946,921],8067:[7947,921],8068:[7948,921],8069:[7949,921],8070:[7950,921],8071:[7951,921],8072:[7944,921],8073:[7945,921],8074:[7946,921],8075:[7947,921],8076:[7948,921],8077:[7949,921],8078:[7950,921],8079:[7951,921],8080:[7976,921],8081:[7977,921],8082:[7978,921],8083:[7979,921],8084:[7980,921],8085:[7981,921],8086:[7982,921],8087:[7983,921],8088:[7976,921],8089:[7977,921],8090:[7978,921],8091:[7979,921],8092:[7980,921],8093:[7981,921],8094:[7982,921],8095:[7983,921],8096:[8040,921],8097:[8041,921],8098:[8042,921],8099:[8043,921],8100:[8044,921],8101:[8045,921],8102:[8046,921],8103:[8047,921],8104:[8040,921],8105:[8041,921],8106:[8042,921],8107:[8043,921],8108:[8044,921],8109:[8045,921],8110:[8046,921],8111:[8047,921],8114:[8122,921],8115:[913,921],8116:[902,921],8118:[913,834],8119:[913,834,921],8124:[913,921],8126:921,8130:[8138,921],8131:[919,921],8132:[905,921],8134:[919,834],8135:[919,834,921],8140:[919,921],8146:[921,776,768],8147:[921,776,769],8150:[921,834],8151:[921,776,834],8162:[933,776,768],8163:[933,776,769],8164:[929,787],8165:8172,8166:[933,834],8167:[933,776,834],8178:[8186,921],8179:[937,921],8180:[911,921],8182:[937,834],8183:[937,834,921],8188:[937,921],64256:[70,70],64257:[70,73],64258:[70,76],64259:[70,70,73],64260:[70,70,76],64261:[83,84],64262:[83,84],64275:[1348,1350],64276:[1348,1333],64277:[1348,1339],64278:[1358,1350],64279:[1348,1341]};!function(){var e,t,r,n=C;for(e=[7936,7937,7938,7939,7940,7941,7942,7943,7952,7953,7954,7955,7956,7957,7968,7969,7970,7971,7972,7973,7974,7975,7984,7985,7986,7987,7988,7989,7990,7991,8e3,8001,8002,8003,8004,8005,8017,8019,8021,8023,8032,8033,8034,8035,8036,8037,8038,8039,8112,8113,8144,8145,8160,8161],t=0;t<54;t++)n[r=e[t]]=r+8;for(r=257;r<=303;r+=2)n[r]=r-1;for(r=331;r<=375;r+=2)n[r]=r-1;for(r=505;r<=543;r+=2)n[r]=r-1;for(r=1121;r<=1153;r+=2)n[r]=r-1;for(r=1163;r<=1215;r+=2)n[r]=r-1;for(r=1233;r<=1269;r+=2)n[r]=r-1;for(r=7681;r<=7829;r+=2)n[r]=r-1;for(r=7841;r<=7929;r+=2)n[r]=r-1;for(e=[307,309,311,314,316,318,320,322,324,326,328,378,380,382,387,389,392,396,402,409,417,419,421,424,429,432,436,438,441,445,453,456,459,462,464,466,468,470,472,474,476,479,481,483,485,487,489,491,493,495,498,501,547,549,551,553,555,557,559,561,563,985,987,989,991,993,995,997,999,1001,1003,1005,1007,1016,1019,1218,1220,1222,1224,1226,1228,1230,1273,1281,1283,1285,1287,1289,1291,1293,1295],t=0;t<91;t++)n[r=e[t]]=r-1;for(r=8560;r<=8575;r+=1)n[r]=r-16;for(r=9424;r<=9449;r+=1)n[r]=r-26;for(r=97;r<=122;r+=1)n[r]=r-32;for(r=224;r<=246;r+=1)n[r]=r-32;for(r=945;r<=961;r+=1)n[r]=r-32;for(r=1072;r<=1103;r+=1)n[r]=r-32;for(r=65345;r<=65370;r+=1)n[r]=r-32;for(e=[248,249,250,251,252,253,254,963,964,965,966,967,968,969,970,971],t=0;t<16;t++)n[r=e[t]]=r-32;for(r=66600;r<=66639;r+=1)n[r]=r-40;for(r=1377;r<=1414;r+=1)n[r]=r-48;for(r=1104;r<=1119;r+=1)n[r]=r-80;n[1009]=929}();var S={304:[105,775],376:255,385:595,390:596,393:598,394:599,398:477,399:601,400:603,403:608,404:611,406:617,407:616,412:623,413:626,415:629,422:640,425:643,430:648,433:650,434:651,439:658,452:454,455:457,458:460,497:499,502:405,503:447,544:414,902:940,904:941,905:942,906:943,908:972,910:973,911:974,1012:952,1017:1010,8122:8048,8123:8049,8124:8115,8136:8050,8137:8051,8138:8052,8139:8053,8140:8131,8154:8054,8155:8055,8170:8058,8171:8059,8172:8165,8184:8056,8185:8057,8186:8060,8187:8061,8188:8179,8486:969,8490:107,8491:229};!function(){var e,t,r,n=S;for(r=1024;r<=1039;r+=1)n[r]=r+80;for(r=1329;r<=1366;r+=1)n[r]=r+48;for(r=66560;r<=66599;r+=1)n[r]=r+40;for(r=65;r<=90;r+=1)n[r]=r+32;for(r=192;r<=214;r+=1)n[r]=r+32;for(r=913;r<=929;r+=1)n[r]=r+32;for(r=1040;r<=1071;r+=1)n[r]=r+32;for(r=65313;r<=65338;r+=1)n[r]=r+32;for(e=[216,217,218,219,220,221,222,931,932,933,934,935,936,937,938,939],t=0;t<16;t++)n[r=e[t]]=r+32;for(r=9398;r<=9423;r+=1)n[r]=r+26;for(r=8544;r<=8559;r+=1)n[r]=r+16;for(r=256;r<=302;r+=2)n[r]=r+1;for(r=330;r<=374;r+=2)n[r]=r+1;for(r=504;r<=542;r+=2)n[r]=r+1;for(r=1120;r<=1152;r+=2)n[r]=r+1;for(r=1162;r<=1214;r+=2)n[r]=r+1;for(r=1232;r<=1268;r+=2)n[r]=r+1;for(r=7680;r<=7828;r+=2)n[r]=r+1;for(r=7840;r<=7928;r+=2)n[r]=r+1;for(e=[306,308,310,313,315,317,319,321,323,325,327,377,379,381,386,388,391,395,401,408,416,418,420,423,428,431,435,437,440,444,453,456,459,461,463,465,467,469,471,473,475,478,480,482,484,486,488,490,492,494,498,500,546,548,550,552,554,556,558,560,562,984,986,988,990,992,994,996,998,1e3,1002,1004,1006,1015,1018,1217,1219,1221,1223,1225,1227,1229,1272,1280,1282,1284,1286,1288,1290,1292,1294],t=0;t<91;t++)n[r=e[t]]=r+1;for(e=[7944,7945,7946,7947,7948,7949,7950,7951,7960,7961,7962,7963,7964,7965,7976,7977,7978,7979,7980,7981,7982,7983,7992,7993,7994,7995,7996,7997,7998,7999,8008,8009,8010,8011,8012,8013,8025,8027,8029,8031,8040,8041,8042,8043,8044,8045,8046,8047,8072,8073,8074,8075,8076,8077,8078,8079,8088,8089,8090,8091,8092,8093,8094,8095,8104,8105,8106,8107,8108,8109,8110,8111,8120,8121,8152,8153,8168,8169],t=0;t<78;t++)n[r=e[t]]=r-8}();var M={223:[83,115],452:453,453:453,454:453,455:456,456:456,457:456,458:459,459:459,460:459,497:498,498:498,499:498,1415:[1333,1410],8114:[8122,837],8115:8124,8116:[902,837],8119:[913,834,837],8124:8124,8130:[8138,837],8131:8140,8132:[905,837],8135:[919,834,837],8140:8140,8178:[8186,837],8179:8188,8180:[911,837],8183:[937,834,837],8188:8188,64256:[70,102],64257:[70,105],64258:[70,108],64259:[70,102,105],64260:[70,102,108],64261:[83,116],64262:[83,116],64275:[1348,1398],64276:[1348,1381],64277:[1348,1387],64278:[1358,1398],64279:[1348,1389]};!function(){var e,t,r,n=M;for(e=[8072,8073,8074,8075,8076,8077,8078,8079,8072,8073,8074,8075,8076,8077,8078,8079,8088,8089,8090,8091,8092,8093,8094,8095,8088,8089,8090,8091,8092,8093,8094,8095,8104,8105,8106,8107,8108,8109,8110,8111,8104,8105,8106,8107,8108,8109,8110,8111],t=0;t<48;t++)r=e[t],n[t+8064]=r}();var j={192:[65,768],193:[65,769],194:[65,770],195:[65,771],196:[65,776],197:[65,778],199:[67,807],200:[69,768],201:[69,769],202:[69,770],203:[69,776],204:[73,768],205:[73,769],206:[73,770],207:[73,776],209:[78,771],210:[79,768],211:[79,769],212:[79,770],213:[79,771],214:[79,776],217:[85,768],218:[85,769],219:[85,770],220:[85,776],221:[89,769],224:[97,768],225:[97,769],226:[97,770],227:[97,771],228:[97,776],229:[97,778],231:[99,807],232:[101,768],233:[101,769],234:[101,770],235:[101,776],236:[105,768],237:[105,769],238:[105,770],239:[105,776],241:[110,771],242:[111,768],243:[111,769],244:[111,770],245:[111,771],246:[111,776],249:[117,768],250:[117,769],251:[117,770],252:[117,776],253:[121,769],296:[73,771],297:[105,771],298:[73,772],299:[105,772],300:[73,774],301:[105,774],302:[73,808],303:[105,808],304:[73,775],308:[74,770],309:[106,770],310:[75,807],311:[107,807],313:[76,769],314:[108,769],315:[76,807],316:[108,807],317:[76,780],318:[108,780],323:[78,769],324:[110,769],325:[78,807],326:[110,807],327:[78,780],328:[110,780],332:[79,772],333:[111,772],334:[79,774],335:[111,774],336:[79,779],337:[111,779],416:[79,795],417:[111,795],431:[85,795],432:[117,795],478:[65,776,772],479:[97,776,772],480:[65,775,772],481:[97,775,772],482:[198,772],483:[230,772],486:[71,780],487:[103,780],488:[75,780],489:[107,780],490:[79,808],491:[111,808],492:[79,808,772],493:[111,808,772],494:[439,780],495:[658,780],496:[106,780],500:[71,769],501:[103,769],542:[72,780],543:[104,780],550:[65,775],551:[97,775],552:[69,807],553:[101,807],554:[79,776,772],555:[111,776,772],556:[79,771,772],557:[111,771,772],558:[79,775],559:[111,775],560:[79,775,772],561:[111,775,772],562:[89,772],563:[121,772],832:768,833:769,835:787,836:[776,769],884:697,894:59,901:[168,769],902:[913,769],903:183,904:[917,769],905:[919,769],906:[921,769],908:[927,769],910:[933,769],911:[937,769],912:[953,776,769],938:[921,776],939:[933,776],940:[945,769],941:[949,769],942:[951,769],943:[953,769],944:[965,776,769],970:[953,776],971:[965,776],972:[959,769],973:[965,769],974:[969,769],979:[978,769],980:[978,776],1024:[1045,768],1025:[1045,776],1027:[1043,769],1031:[1030,776],1036:[1050,769],1037:[1048,768],1038:[1059,774],1049:[1048,774],1081:[1080,774],1104:[1077,768],1105:[1077,776],1107:[1075,769],1111:[1110,776],1116:[1082,769],1117:[1080,768],1118:[1091,774],1142:[1140,783],1143:[1141,783],1217:[1046,774],1218:[1078,774],1232:[1040,774],1233:[1072,774],1234:[1040,776],1235:[1072,776],1238:[1045,774],1239:[1077,774],1242:[1240,776],1243:[1241,776],1244:[1046,776],1245:[1078,776],1246:[1047,776],1247:[1079,776],1250:[1048,772],1251:[1080,772],1252:[1048,776],1253:[1080,776],1254:[1054,776],1255:[1086,776],1258:[1256,776],1259:[1257,776],1260:[1069,776],1261:[1101,776],1262:[1059,772],1263:[1091,772],1264:[1059,776],1265:[1091,776],1266:[1059,779],1267:[1091,779],1268:[1063,776],1269:[1095,776],1272:[1067,776],1273:[1099,776],1570:[1575,1619],1571:[1575,1620],1572:[1608,1620],1573:[1575,1621],1574:[1610,1620],1728:[1749,1620],1730:[1729,1620],1747:[1746,1620],2345:[2344,2364],2353:[2352,2364],2356:[2355,2364],2392:[2325,2364],2393:[2326,2364],2394:[2327,2364],2395:[2332,2364],2396:[2337,2364],2397:[2338,2364],2398:[2347,2364],2399:[2351,2364],2507:[2503,2494],2508:[2503,2519],2524:[2465,2492],2525:[2466,2492],2527:[2479,2492],2611:[2610,2620],2614:[2616,2620],2649:[2582,2620],2650:[2583,2620],2651:[2588,2620],2654:[2603,2620],2888:[2887,2902],2891:[2887,2878],2892:[2887,2903],2908:[2849,2876],2909:[2850,2876],2964:[2962,3031],3018:[3014,3006],3019:[3015,3006],3020:[3014,3031],3144:[3142,3158],3264:[3263,3285],3271:[3270,3285],3272:[3270,3286],3274:[3270,3266],3275:[3270,3266,3285],3402:[3398,3390],3403:[3399,3390],3404:[3398,3415],3546:[3545,3530],3548:[3545,3535],3549:[3545,3535,3530],3550:[3545,3551],3907:[3906,4023],3917:[3916,4023],3922:[3921,4023],3927:[3926,4023],3932:[3931,4023],3945:[3904,4021],3955:[3953,3954],3957:[3953,3956],3958:[4018,3968],3960:[4019,3968],3969:[3953,3968],3987:[3986,4023],3997:[3996,4023],4002:[4001,4023],4007:[4006,4023],4012:[4011,4023],4025:[3984,4021],4134:[4133,4142],7835:[383,775],7960:[917,787],7961:[917,788],7962:[917,787,768],7963:[917,788,768],7964:[917,787,769],7965:[917,788,769],8008:[927,787],8009:[927,788],8010:[927,787,768],8011:[927,788,768],8012:[927,787,769],8013:[927,788,769],8016:[965,787],8017:[965,788],8018:[965,787,768],8019:[965,788,768],8020:[965,787,769],8021:[965,788,769],8022:[965,787,834],8023:[965,788,834],8025:[933,788],8027:[933,788,768],8029:[933,788,769],8118:[945,834],8119:[945,834,837],8120:[913,774],8121:[913,772],8122:[913,768],8123:[913,769],8124:[913,837],8126:953,8129:[168,834],8130:[951,768,837],8131:[951,837],8132:[951,769,837],8134:[951,834],8135:[951,834,837],8136:[917,768],8137:[917,769],8138:[919,768],8139:[919,769],8140:[919,837],8141:[8127,768],8142:[8127,769],8143:[8127,834],8144:[953,774],8145:[953,772],8146:[953,776,768],8147:[953,776,769],8150:[953,834],8151:[953,776,834],8152:[921,774],8153:[921,772],8154:[921,768],8155:[921,769],8178:[969,768,837],8179:[969,837],8180:[969,769,837],8182:[969,834],8183:[969,834,837],8184:[927,768],8185:[927,769],8186:[937,768],8187:[937,769],8188:[937,837],8189:180,8192:8194,8193:8195,8486:937,8490:75,8491:[65,778],8602:[8592,824],8603:[8594,824],8622:[8596,824],8653:[8656,824],8654:[8660,824],8655:[8658,824],8708:[8707,824],8713:[8712,824],8716:[8715,824],8740:[8739,824],8742:[8741,824],8769:[8764,824],8772:[8771,824],8775:[8773,824],8777:[8776,824],8800:[61,824],8802:[8801,824],8813:[8781,824],8814:[60,824],8815:[62,824],8816:[8804,824],8817:[8805,824],8820:[8818,824],8821:[8819,824],8824:[8822,824],8825:[8823,824],8832:[8826,824],8833:[8827,824],8836:[8834,824],8837:[8835,824],8840:[8838,824],8841:[8839,824],8876:[8866,824],8877:[8872,824],8878:[8873,824],8879:[8875,824],8928:[8828,824],8929:[8829,824],8930:[8849,824],8931:[8850,824],8938:[8882,824],8939:[8883,824],8940:[8884,824],8941:[8885,824],9001:12296,9002:12297,10972:[10973,824],12364:[12363,12441],12366:[12365,12441],12368:[12367,12441],12370:[12369,12441],12372:[12371,12441],12374:[12373,12441],12376:[12375,12441],12378:[12377,12441],12380:[12379,12441],12382:[12381,12441],12384:[12383,12441],12386:[12385,12441],12389:[12388,12441],12391:[12390,12441],12393:[12392,12441],12400:[12399,12441],12401:[12399,12442],12403:[12402,12441],12404:[12402,12442],12406:[12405,12441],12407:[12405,12442],12409:[12408,12441],12410:[12408,12442],12412:[12411,12441],12413:[12411,12442],12436:[12358,12441],12446:[12445,12441],12460:[12459,12441],12462:[12461,12441],12464:[12463,12441],12466:[12465,12441],12468:[12467,12441],12470:[12469,12441],12472:[12471,12441],12474:[12473,12441],12476:[12475,12441],12478:[12477,12441],12480:[12479,12441],12482:[12481,12441],12485:[12484,12441],12487:[12486,12441],12489:[12488,12441],12496:[12495,12441],12497:[12495,12442],12499:[12498,12441],12500:[12498,12442],12502:[12501,12441],12503:[12501,12442],12505:[12504,12441],12506:[12504,12442],12508:[12507,12441],12509:[12507,12442],12532:[12454,12441],12535:[12527,12441],12536:[12528,12441],12537:[12529,12441],12538:[12530,12441],12542:[12541,12441],64016:22618,64018:26228,64021:20958,64022:29482,64023:30410,64024:31036,64025:31070,64026:31077,64027:31119,64028:38742,64029:31934,64030:32701,64032:34322,64034:35576,64037:36920,64038:37117,64042:39151,64043:39164,64044:39208,64045:40372,64285:[1497,1460],64287:[1522,1463],64298:[1513,1473],64299:[1513,1474],64300:[1513,1468,1473],64301:[1513,1468,1474],64302:[1488,1463],64303:[1488,1464],64304:[1488,1468],64305:[1489,1468],64306:[1490,1468],64307:[1491,1468],64308:[1492,1468],64309:[1493,1468],64310:[1494,1468],64312:[1496,1468],64313:[1497,1468],64314:[1498,1468],64315:[1499,1468],64316:[1500,1468],64318:[1502,1468],64320:[1504,1468],64321:[1505,1468],64323:[1507,1468],64324:[1508,1468],64326:[1510,1468],64327:[1511,1468],64328:[1512,1468],64329:[1513,1468],64330:[1514,1468],64331:[1493,1465],64332:[1489,1471],64333:[1499,1471],64334:[1508,1471],119134:[119127,119141],119135:[119128,119141],119136:[119128,119141,119150],119137:[119128,119141,119151],119138:[119128,119141,119152],119139:[119128,119141,119153],119140:[119128,119141,119154],119227:[119225,119141],119228:[119226,119141],119229:[119225,119141,119150],119230:[119226,119141,119150],119231:[119225,119141,119151],119232:[119226,119141,119151]};!function(){var e,t,r,n=j;for(e=[[121,776],[65,772],[97,772],[65,774],[97,774],[65,808],[97,808],[67,769],[99,769],[67,770],[99,770],[67,775],[99,775],[67,780],[99,780],[68,780],[100,780]],t=0;t<17;t++)r=e[t],n[t+255]=r;for(e=[[69,772],[101,772],[69,774],[101,774],[69,775],[101,775],[69,808],[101,808],[69,780],[101,780],[71,770],[103,770],[71,774],[103,774],[71,775],[103,775],[71,807],[103,807],[72,770],[104,770]],t=0;t<20;t++)r=e[t],n[t+274]=r;for(e=[[82,769],[114,769],[82,807],[114,807],[82,780],[114,780],[83,769],[115,769],[83,770],[115,770],[83,807],[115,807],[83,780],[115,780],[84,807],[116,807],[84,780],[116,780]],t=0;t<18;t++)r=e[t],n[t+340]=r;for(e=[[85,771],[117,771],[85,772],[117,772],[85,774],[117,774],[85,778],[117,778],[85,779],[117,779],[85,808],[117,808],[87,770],[119,770],[89,770],[121,770],[89,776],[90,769],[122,769],[90,775],[122,775],[90,780],[122,780]],t=0;t<23;t++)r=e[t],n[t+360]=r;for(e=[[65,780],[97,780],[73,780],[105,780],[79,780],[111,780],[85,780],[117,780],[85,776,772],[117,776,772],[85,776,769],[117,776,769],[85,776,780],[117,776,780],[85,776,768],[117,776,768]],t=0;t<16;t++)r=e[t],n[t+461]=r;for(e=[[78,768],[110,768],[65,778,769],[97,778,769],[198,769],[230,769],[216,769],[248,769],[65,783],[97,783],[65,785],[97,785],[69,783],[101,783],[69,785],[101,785],[73,783],[105,783],[73,785],[105,785],[79,783],[111,783],[79,785],[111,785],[82,783],[114,783],[82,785],[114,785],[85,783],[117,783],[85,785],[117,785],[83,806],[115,806],[84,806],[116,806]],t=0;t<36;t++)r=e[t],n[t+504]=r;for(e=[[65,805],[97,805],[66,775],[98,775],[66,803],[98,803],[66,817],[98,817],[67,807,769],[99,807,769],[68,775],[100,775],[68,803],[100,803],[68,817],[100,817],[68,807],[100,807],[68,813],[100,813],[69,772,768],[101,772,768],[69,772,769],[101,772,769],[69,813],[101,813],[69,816],[101,816],[69,807,774],[101,807,774],[70,775],[102,775],[71,772],[103,772],[72,775],[104,775],[72,803],[104,803],[72,776],[104,776],[72,807],[104,807],[72,814],[104,814],[73,816],[105,816],[73,776,769],[105,776,769],[75,769],[107,769],[75,803],[107,803],[75,817],[107,817],[76,803],[108,803],[76,803,772],[108,803,772],[76,817],[108,817],[76,813],[108,813],[77,769],[109,769],[77,775],[109,775],[77,803],[109,803],[78,775],[110,775],[78,803],[110,803],[78,817],[110,817],[78,813],[110,813],[79,771,769],[111,771,769],[79,771,776],[111,771,776],[79,772,768],[111,772,768],[79,772,769],[111,772,769],[80,769],[112,769],[80,775],[112,775],[82,775],[114,775],[82,803],[114,803],[82,803,772],[114,803,772],[82,817],[114,817],[83,775],[115,775],[83,803],[115,803],[83,769,775],[115,769,775],[83,780,775],[115,780,775],[83,803,775],[115,803,775],[84,775],[116,775],[84,803],[116,803],[84,817],[116,817],[84,813],[116,813],[85,804],[117,804],[85,816],[117,816],[85,813],[117,813],[85,771,769],[117,771,769],[85,772,776],[117,772,776],[86,771],[118,771],[86,803],[118,803],[87,768],[119,768],[87,769],[119,769],[87,776],[119,776],[87,775],[119,775],[87,803],[119,803],[88,775],[120,775],[88,776],[120,776],[89,775],[121,775],[90,770],[122,770],[90,803],[122,803],[90,817],[122,817],[104,817],[116,776],[119,778],[121,778]],t=0;t<154;t++)r=e[t],n[t+7680]=r;for(e=[[65,803],[97,803],[65,777],[97,777],[65,770,769],[97,770,769],[65,770,768],[97,770,768],[65,770,777],[97,770,777],[65,770,771],[97,770,771],[65,803,770],[97,803,770],[65,774,769],[97,774,769],[65,774,768],[97,774,768],[65,774,777],[97,774,777],[65,774,771],[97,774,771],[65,803,774],[97,803,774],[69,803],[101,803],[69,777],[101,777],[69,771],[101,771],[69,770,769],[101,770,769],[69,770,768],[101,770,768],[69,770,777],[101,770,777],[69,770,771],[101,770,771],[69,803,770],[101,803,770],[73,777],[105,777],[73,803],[105,803],[79,803],[111,803],[79,777],[111,777],[79,770,769],[111,770,769],[79,770,768],[111,770,768],[79,770,777],[111,770,777],[79,770,771],[111,770,771],[79,803,770],[111,803,770],[79,795,769],[111,795,769],[79,795,768],[111,795,768],[79,795,777],[111,795,777],[79,795,771],[111,795,771],[79,795,803],[111,795,803],[85,803],[117,803],[85,777],[117,777],[85,795,769],[117,795,769],[85,795,768],[117,795,768],[85,795,777],[117,795,777],[85,795,771],[117,795,771],[85,795,803],[117,795,803],[89,768],[121,768],[89,803],[121,803],[89,777],[121,777],[89,771],[121,771]],t=0;t<90;t++)r=e[t],n[t+7840]=r;for(e=[[945,787],[945,788],[945,787,768],[945,788,768],[945,787,769],[945,788,769],[945,787,834],[945,788,834],[913,787],[913,788],[913,787,768],[913,788,768],[913,787,769],[913,788,769],[913,787,834],[913,788,834],[949,787],[949,788],[949,787,768],[949,788,768],[949,787,769],[949,788,769]],t=0;t<22;t++)r=e[t],n[t+7936]=r;for(e=[[951,787],[951,788],[951,787,768],[951,788,768],[951,787,769],[951,788,769],[951,787,834],[951,788,834],[919,787],[919,788],[919,787,768],[919,788,768],[919,787,769],[919,788,769],[919,787,834],[919,788,834],[953,787],[953,788],[953,787,768],[953,788,768],[953,787,769],[953,788,769],[953,787,834],[953,788,834],[921,787],[921,788],[921,787,768],[921,788,768],[921,787,769],[921,788,769],[921,787,834],[921,788,834],[959,787],[959,788],[959,787,768],[959,788,768],[959,787,769],[959,788,769]],t=0;t<38;t++)r=e[t],n[t+7968]=r;for(e=[[933,788,834],[969,787],[969,788],[969,787,768],[969,788,768],[969,787,769],[969,788,769],[969,787,834],[969,788,834],[937,787],[937,788],[937,787,768],[937,788,768],[937,787,769],[937,788,769],[937,787,834],[937,788,834],[945,768],[945,769],[949,768],[949,769],[951,768],[951,769],[953,768],[953,769],[959,768],[959,769],[965,768],[965,769],[969,768],[969,769]],t=0;t<31;t++)r=e[t],n[t+8031]=r;for(e=[[945,787,837],[945,788,837],[945,787,768,837],[945,788,768,837],[945,787,769,837],[945,788,769,837],[945,787,834,837],[945,788,834,837],[913,787,837],[913,788,837],[913,787,768,837],[913,788,768,837],[913,787,769,837],[913,788,769,837],[913,787,834,837],[913,788,834,837],[951,787,837],[951,788,837],[951,787,768,837],[951,788,768,837],[951,787,769,837],[951,788,769,837],[951,787,834,837],[951,788,834,837],[919,787,837],[919,788,837],[919,787,768,837],[919,788,768,837],[919,787,769,837],[919,788,769,837],[919,787,834,837],[919,788,834,837],[969,787,837],[969,788,837],[969,787,768,837],[969,788,768,837],[969,787,769,837],[969,788,769,837],[969,787,834,837],[969,788,834,837],[937,787,837],[937,788,837],[937,787,768,837],[937,788,768,837],[937,787,769,837],[937,788,769,837],[937,787,834,837],[937,788,834,837],[945,774],[945,772],[945,768,837],[945,837],[945,769,837]],t=0;t<53;t++)r=e[t],n[t+8064]=r;for(e=[[8190,768],[8190,769],[8190,834],[965,774],[965,772],[965,776,768],[965,776,769],[961,787],[961,788],[965,834],[965,776,834],[933,774],[933,772],[933,768],[933,769],[929,788],[168,768],[168,769],96],t=0;t<19;t++)r=e[t],n[t+8157]=r;for(e=[35912,26356,36554,36040,28369,20018,21477,40860,40860,22865,37329,21895,22856,25078,30313,32645,34367,34746,35064,37007,27138,27931,28889,29662,33853,37226,39409,20098,21365,27396,29211,34349,40478,23888,28651,34253,35172,25289,33240,34847,24266,26391,28010,29436,37070,20358,20919,21214,25796,27347,29200,30439,32769,34310,34396,36335,38706,39791,40442,30860,31103,32160,33737,37636,40575,35542,22751,24324,31840,32894,29282,30922,36034,38647,22744,23650,27155,28122,28431,32047,32311,38475,21202,32907,20956,20940,31260,32190,33777,38517,35712,25295,27138,35582,20025,23527,24594,29575,30064,21271,30971,20415,24489,19981,27852,25976,32034,21443,22622,30465,33865,35498,27578,36784,27784,25342,33509,25504,30053,20142,20841,20937,26753,31975,33391,35538,37327,21237,21570,22899,24300,26053,28670,31018,38317,39530,40599,40654,21147,26310,27511,36706,24180,24976,25088,25754,28451,29001,29833,31178,32244,32879,36646,34030,36899,37706,21015,21155,21693,28872,35010,35498,24265,24565,25467,27566,31806,29557,20196,22265,23527,23994,24604,29618,29801,32666,32838,37428,38646,38728,38936,20363,31150,37300,38584,24801,20102,20698,23534,23615,26009,27138,29134,30274,34044,36988,40845,26248,38446,21129,26491,26611,27969,28316,29705,30041,30827,32016,39006,20845,25134,38520,20523,23833,28138,36650,24459,24900,26647,29575,38534,21033,21519,23653,26131,26446,26792,27877,29702,30178,32633,35023,35041,37324,38626,21311,28346,21533,29136,29848,34298,38563,40023,40607,26519,28107,33256,31435,31520,31890,29376,28825,35672,20160,33590,21050,20999,24230,25299,31958,23429,27934,26292,36667,34892,38477,35211,24275,20800,21952],t=0;t<270;t++)r=e[t],n[t+63744]=r;for(e=[20398,20711,20813,21193,21220,21329,21917,22022,22120,22592,22696,23652,23662,24724,24936,24974,25074,25935,26082,26257,26757,28023,28186,28450,29038,29227,29730,30865,31038,31049,31048,31056,31062,31069,31117,31118,31296,31361,31680,32244,32265,32321,32626,32773,33261,33401,33401,33879,35088,35222,35585,35641,36051,36104,36790,36920,38627,38911,38971],t=0;t<59;t++)r=e[t],n[t+64048]=r;for(e=[20029,20024,20033,131362,20320,20398,20411,20482,20602,20633,20711,20687,13470,132666,20813,20820,20836,20855,132380,13497,20839,20877,132427,20887,20900,20172,20908,20917,168415,20981,20995,13535,21051,21062,21106,21111,13589,21191,21193,21220,21242,21253,21254,21271,21321,21329,21338,21363,21373,21375,21375,21375,133676,28784,21450,21471,133987,21483,21489,21510,21662,21560,21576,21608,21666,21750,21776,21843,21859,21892,21892,21913,21931,21939,21954,22294,22022,22295,22097,22132,20999,22766,22478,22516,22541,22411,22578,22577,22700,136420,22770,22775,22790,22810,22818,22882,136872,136938,23020,23067,23079,23e3,23142,14062,14076,23304,23358,23358,137672,23491,23512,23527,23539,138008,23551,23558,24403,23586,14209,23648,23662,23744,23693,138724,23875,138726,23918,23915,23932,24033,24034,14383,24061,24104,24125,24169,14434,139651,14460,24240,24243,24246,24266,172946,24318,140081,140081,33281,24354,24354,14535,144056,156122,24418,24427,14563,24474,24525,24535,24569,24705,14650,14620,24724,141012,24775,24904,24908,24910,24908,24954,24974,25010,24996,25007,25054,25074,25078,25104,25115,25181,25265,25300,25424,142092,25405,25340,25448,25475,25572,142321,25634,25541,25513,14894,25705,25726,25757,25719,14956,25935,25964,143370,26083,26360,26185,15129,26257,15112,15076,20882,20885,26368,26268,32941,17369,26391,26395,26401,26462,26451,144323,15177,26618,26501,26706,26757,144493,26766,26655,26900,15261,26946,27043,27114,27304,145059,27355,15384,27425,145575,27476,15438,27506,27551,27578,27579,146061,138507,146170,27726,146620,27839,27853,27751,27926,27966,28023,27969,28009,28024,28037,146718,27956,28207,28270,15667,28363,28359,147153,28153,28526,147294,147342,28614,28729,28702,28699,15766,28746,28797,28791,28845,132389,28997,148067,29084,148395,29224,29237,29264,149e3,29312,29333,149301,149524,29562,29579,16044,29605,16056,16056,29767,29788,29809,29829,29898,16155,29988,150582,30014,150674,30064,139679,30224,151457,151480,151620,16380,16392,30452,151795,151794,151833,151859,30494,30495,30495,30538,16441,30603,16454,16534,152605,30798,30860,30924,16611,153126,31062,153242,153285,31119,31211,16687,31296,31306,31311,153980,154279,154279,31470,16898,154539,31686,31689,16935,154752,31954,17056,31976,31971,32e3,155526,32099,17153,32199,32258,32325,17204,156200,156231,17241,156377,32634,156478,32661,32762,32773,156890,156963,32864,157096,32880,144223,17365,32946,33027,17419,33086,23221,157607,157621,144275,144284,33281,33284,36766,17515,33425,33419,33437,21171,33457,33459,33469,33510,158524,33509,33565,33635,33709,33571,33725,33767,33879,33619,33738,33740,33756,158774,159083,158933,17707,34033,34035,34070,160714,34148,159532,17757,17761,159665,159954,17771,34384,34396,34407,34409,34473,34440,34574,34530,34681,34600,34667,34694,17879,34785,34817,17913,34912,34915,161383,35031,35038,17973,35066,13499,161966,162150,18110,18119,35488,35565,35722,35925,162984,36011,36033,36123,36215,163631,133124,36299,36284,36336,133342,36564,36664,165330,165357,37012,37105,37137,165678,37147,37432,37591,37592,37500,37881,37909,166906,38283,18837,38327,167287,18918,38595,23986,38691,168261,168474,19054,19062,38880,168970,19122,169110,38923,38923,38953,169398,39138,19251,39209,39335,39362,39422,19406,170800,39698,4e4,40189,19662,19693,40295,172238,19704,172293,172558,172689,40635,19798,40697,40702,40709,40719,40726,40763,173568],t=0;t<542;t++)r=e[t],n[t+194560]=r}();var G={768:230,769:230,770:230,771:230,772:230,773:230,774:230,775:230,776:230,777:230,778:230,779:230,780:230,781:230,782:230,783:230,784:230,785:230,786:230,787:230,788:230,789:232,790:220,791:220,792:220,793:220,794:232,795:216,796:220,797:220,798:220,799:220,800:220,801:202,802:202,803:220,804:220,805:220,806:220,807:202,808:202,809:220,810:220,811:220,812:220,813:220,814:220,815:220,816:220,817:220,818:220,819:220,820:1,821:1,822:1,823:1,824:1,825:220,826:220,827:220,828:220,829:230,830:230,831:230,832:230,833:230,834:230,835:230,836:230,837:240,838:230,839:220,840:220,841:220,842:230,843:230,844:230,845:220,846:220,848:230,849:230,850:230,851:220,852:220,853:220,854:220,855:230,861:234,862:234,863:233,864:234,865:234,866:233,867:230,868:230,869:230,870:230,871:230,872:230,873:230,874:230,875:230,876:230,877:230,878:230,879:230,1155:230,1156:230,1157:230,1158:230,1425:220,1426:230,1427:230,1428:230,1429:230,1430:220,1431:230,1432:230,1433:230,1434:222,1435:220,1436:230,1437:230,1438:230,1439:230,1440:230,1441:230,1443:220,1444:220,1445:220,1446:220,1447:220,1448:230,1449:230,1450:220,1451:230,1452:230,1453:222,1454:228,1455:230,1456:10,1457:11,1458:12,1459:13,1460:14,1461:15,1462:16,1463:17,1464:18,1465:19,1467:20,1468:21,1469:22,1471:23,1473:24,1474:25,1476:230,1552:230,1553:230,1554:230,1555:230,1556:230,1557:230,1611:27,1612:28,1613:29,1614:30,1615:31,1616:32,1617:33,1618:34,1619:230,1620:230,1621:220,1622:220,1623:230,1624:230,1648:35,1750:230,1751:230,1752:230,1753:230,1754:230,1755:230,1756:230,1759:230,1760:230,1761:230,1762:230,1763:220,1764:230,1767:230,1768:230,1770:220,1771:230,1772:230,1773:220,1809:36,1840:230,1841:220,1842:230,1843:230,1844:220,1845:230,1846:230,1847:220,1848:220,1849:220,1850:230,1851:220,1852:220,1853:230,1854:220,1855:230,1856:230,1857:230,1858:220,1859:230,1860:220,1861:230,1862:220,1863:230,1864:220,1865:230,1866:230,2364:7,2381:9,2385:230,2386:220,2387:230,2388:230,2492:7,2509:9,2620:7,2637:9,2748:7,2765:9,2876:7,2893:9,3021:9,3149:9,3157:84,3158:91,3260:7,3277:9,3405:9,3530:9,3640:103,3641:103,3642:9,3656:107,3657:107,3658:107,3659:107,3768:118,3769:118,3784:122,3785:122,3786:122,3787:122,3864:220,3865:220,3893:220,3895:220,3897:216,3953:129,3954:130,3956:132,3962:130,3963:130,3964:130,3965:130,3968:130,3970:230,3971:230,3972:9,3974:230,3975:230,4038:220,4151:7,4153:9,5908:9,5940:9,6098:9,6109:230,6313:228,6457:222,6458:230,6459:220,8400:230,8401:230,8402:1,8403:1,8404:230,8405:230,8406:230,8407:230,8408:1,8409:1,8410:1,8411:230,8412:230,8417:230,8421:1,8422:1,8423:230,8424:220,8425:230,8426:1,12330:218,12331:228,12332:232,12333:222,12334:224,12335:224,12441:8,12442:8,64286:26,65056:230,65057:230,65058:230,65059:230,119141:216,119142:216,119143:1,119144:1,119145:1,119149:226,119150:216,119151:216,119152:216,119153:216,119154:216,119163:220,119164:220,119165:220,119166:220,119167:220,119168:220,119169:220,119170:220,119173:230,119174:230,119175:230,119176:230,119177:230,119178:220,119179:220,119210:230,119211:230,119212:230,119213:230},T={60:{824:8814},61:{824:8800},62:{824:8815},65:{768:192,769:193,770:194,771:195,772:256,774:258,775:550,776:196,777:7842,778:197,780:461,783:512,785:514,803:7840,805:7680,808:260},66:{775:7682,803:7684,817:7686},67:{769:262,770:264,775:266,780:268,807:199},68:{775:7690,780:270,803:7692,807:7696,813:7698,817:7694},69:{768:200,769:201,770:202,771:7868,772:274,774:276,775:278,776:203,777:7866,780:282,783:516,785:518,803:7864,807:552,808:280,813:7704,816:7706},70:{775:7710},71:{769:500,770:284,772:7712,774:286,775:288,780:486,807:290},72:{770:292,775:7714,776:7718,780:542,803:7716,807:7720,814:7722},73:{768:204,769:205,770:206,771:296,772:298,774:300,775:304,776:207,777:7880,780:463,783:520,785:522,803:7882,808:302,816:7724},74:{770:308},75:{769:7728,780:488,803:7730,807:310,817:7732},76:{769:313,780:317,803:7734,807:315,813:7740,817:7738},77:{769:7742,775:7744,803:7746},78:{768:504,769:323,771:209,775:7748,780:327,803:7750,807:325,813:7754,817:7752},79:{768:210,769:211,770:212,771:213,772:332,774:334,775:558,776:214,777:7886,779:336,780:465,783:524,785:526,795:416,803:7884,808:490},80:{769:7764,775:7766},82:{769:340,775:7768,780:344,783:528,785:530,803:7770,807:342,817:7774},83:{769:346,770:348,775:7776,780:352,803:7778,806:536,807:350},84:{775:7786,780:356,803:7788,806:538,807:354,813:7792,817:7790},85:{768:217,769:218,770:219,771:360,772:362,774:364,776:220,777:7910,778:366,779:368,780:467,783:532,785:534,795:431,803:7908,804:7794,808:370,813:7798,816:7796},86:{771:7804,803:7806},87:{768:7808,769:7810,770:372,775:7814,776:7812,803:7816},88:{775:7818,776:7820},89:{768:7922,769:221,770:374,771:7928,772:562,775:7822,776:376,777:7926,803:7924},90:{769:377,770:7824,775:379,780:381,803:7826,817:7828},97:{768:224,769:225,770:226,771:227,772:257,774:259,775:551,776:228,777:7843,778:229,780:462,783:513,785:515,803:7841,805:7681,808:261},98:{775:7683,803:7685,817:7687},99:{769:263,770:265,775:267,780:269,807:231},100:{775:7691,780:271,803:7693,807:7697,813:7699,817:7695},101:{768:232,769:233,770:234,771:7869,772:275,774:277,775:279,776:235,777:7867,780:283,783:517,785:519,803:7865,807:553,808:281,813:7705,816:7707},102:{775:7711},103:{769:501,770:285,772:7713,774:287,775:289,780:487,807:291},104:{770:293,775:7715,776:7719,780:543,803:7717,807:7721,814:7723,817:7830},105:{768:236,769:237,770:238,771:297,772:299,774:301,776:239,777:7881,780:464,783:521,785:523,803:7883,808:303,816:7725},106:{770:309,780:496},107:{769:7729,780:489,803:7731,807:311,817:7733},108:{769:314,780:318,803:7735,807:316,813:7741,817:7739},109:{769:7743,775:7745,803:7747},110:{768:505,769:324,771:241,775:7749,780:328,803:7751,807:326,813:7755,817:7753},111:{768:242,769:243,770:244,771:245,772:333,774:335,775:559,776:246,777:7887,779:337,780:466,783:525,785:527,795:417,803:7885,808:491},112:{769:7765,775:7767},114:{769:341,775:7769,780:345,783:529,785:531,803:7771,807:343,817:7775},115:{769:347,770:349,775:7777,780:353,803:7779,806:537,807:351},116:{775:7787,776:7831,780:357,803:7789,806:539,807:355,813:7793,817:7791},117:{768:249,769:250,770:251,771:361,772:363,774:365,776:252,777:7911,778:367,779:369,780:468,783:533,785:535,795:432,803:7909,804:7795,808:371,813:7799,816:7797},118:{771:7805,803:7807},119:{768:7809,769:7811,770:373,775:7815,776:7813,778:7832,803:7817},120:{775:7819,776:7821},121:{768:7923,769:253,770:375,771:7929,772:563,775:7823,776:255,777:7927,778:7833,803:7925},122:{769:378,770:7825,775:380,780:382,803:7827,817:7829},168:{768:8173,769:901,834:8129},194:{768:7846,769:7844,771:7850,777:7848},196:{772:478},197:{769:506},198:{769:508,772:482},199:{769:7688},202:{768:7872,769:7870,771:7876,777:7874},207:{769:7726},212:{768:7890,769:7888,771:7894,777:7892},213:{769:7756,772:556,776:7758},214:{772:554},216:{769:510},220:{768:475,769:471,772:469,780:473},226:{768:7847,769:7845,771:7851,777:7849},228:{772:479},229:{769:507},230:{769:509,772:483},231:{769:7689},234:{768:7873,769:7871,771:7877,777:7875},239:{769:7727},244:{768:7891,769:7889,771:7895,777:7893},245:{769:7757,772:557,776:7759},246:{772:555},248:{769:511},252:{768:476,769:472,772:470,780:474},258:{768:7856,769:7854,771:7860,777:7858},259:{768:7857,769:7855,771:7861,777:7859},274:{768:7700,769:7702},275:{768:7701,769:7703},332:{768:7760,769:7762},333:{768:7761,769:7763},346:{775:7780},347:{775:7781},352:{775:7782},353:{775:7783},360:{769:7800},361:{769:7801},362:{776:7802},363:{776:7803},383:{775:7835},416:{768:7900,769:7898,771:7904,777:7902,803:7906},417:{768:7901,769:7899,771:7905,777:7903,803:7907},431:{768:7914,769:7912,771:7918,777:7916,803:7920},432:{768:7915,769:7913,771:7919,777:7917,803:7921},439:{780:494},490:{772:492},491:{772:493},550:{772:480},551:{772:481},552:{774:7708},553:{774:7709},558:{772:560},559:{772:561},658:{780:495},776:{769:836},913:{768:8122,769:902,772:8121,774:8120,787:7944,788:7945,837:8124},917:{768:8136,769:904,787:7960,788:7961},919:{768:8138,769:905,787:7976,788:7977,837:8140},921:{768:8154,769:906,772:8153,774:8152,776:938,787:7992,788:7993},927:{768:8184,769:908,787:8008,788:8009},929:{788:8172},933:{768:8170,769:910,772:8169,774:8168,776:939,788:8025},937:{768:8186,769:911,787:8040,788:8041,837:8188},940:{837:8116},942:{837:8132},945:{768:8048,769:940,772:8113,774:8112,787:7936,788:7937,834:8118,837:8115},949:{768:8050,769:941,787:7952,788:7953},951:{768:8052,769:942,787:7968,788:7969,834:8134,837:8131},953:{768:8054,769:943,772:8145,774:8144,776:970,787:7984,788:7985,834:8150},959:{768:8056,769:972,787:8e3,788:8001},961:{787:8164,788:8165},965:{768:8058,769:973,772:8161,774:8160,776:971,787:8016,788:8017,834:8166},969:{768:8060,769:974,787:8032,788:8033,834:8182,837:8179},970:{768:8146,769:912,834:8151},971:{768:8162,769:944,834:8167},974:{837:8180},978:{769:979,776:980},1030:{776:1031},1040:{774:1232,776:1234},1043:{769:1027},1045:{768:1024,774:1238,776:1025},1046:{774:1217,776:1244},1047:{776:1246},1048:{768:1037,772:1250,774:1049,776:1252},1050:{769:1036},1054:{776:1254},1059:{772:1262,774:1038,776:1264,779:1266},1063:{776:1268},1067:{776:1272},1069:{776:1260},1072:{774:1233,776:1235},1075:{769:1107},1077:{768:1104,774:1239,776:1105},1078:{774:1218,776:1245},1079:{776:1247},1080:{768:1117,772:1251,774:1081,776:1253},1082:{769:1116},1086:{776:1255},1091:{772:1263,774:1118,776:1265,779:1267},1095:{776:1269},1099:{776:1273},1101:{776:1261},1110:{776:1111},1140:{783:1142},1141:{783:1143},1240:{776:1242},1241:{776:1243},1256:{776:1258},1257:{776:1259},1488:{1463:64302,1464:64303,1468:64304},1489:{1468:64305,1471:64332},1490:{1468:64306},1491:{1468:64307},1492:{1468:64308},1493:{1465:64331,1468:64309},1494:{1468:64310},1496:{1468:64312},1497:{1460:64285,1468:64313},1498:{1468:64314},1499:{1468:64315,1471:64333},1500:{1468:64316},1502:{1468:64318},1504:{1468:64320},1505:{1468:64321},1507:{1468:64323},1508:{1468:64324,1471:64334},1510:{1468:64326},1511:{1468:64327},1512:{1468:64328},1513:{1468:64329,1473:64298,1474:64299},1514:{1468:64330},1522:{1463:64287},1575:{1619:1570,1620:1571,1621:1573},1608:{1620:1572},1610:{1620:1574},1729:{1620:1730},1746:{1620:1747},1749:{1620:1728},2325:{2364:2392},2326:{2364:2393},2327:{2364:2394},2332:{2364:2395},2337:{2364:2396},2338:{2364:2397},2344:{2364:2345},2347:{2364:2398},2351:{2364:2399},2352:{2364:2353},2355:{2364:2356},2465:{2492:2524},2466:{2492:2525},2479:{2492:2527},2503:{2494:2507,2519:2508},2582:{2620:2649},2583:{2620:2650},2588:{2620:2651},2603:{2620:2654},2610:{2620:2611},2616:{2620:2614},2849:{2876:2908},2850:{2876:2909},2887:{2878:2891,2902:2888,2903:2892},2962:{3031:2964},3014:{3006:3018,3031:3020},3015:{3006:3019},3142:{3158:3144},3263:{3285:3264},3270:{3266:3274,3285:3271,3286:3272},3274:{3285:3275},3398:{3390:3402,3415:3404},3399:{3390:3403},3545:{3530:3546,3535:3548,3551:3550},3548:{3530:3549},3904:{4021:3945},3906:{4023:3907},3916:{4023:3917},3921:{4023:3922},3926:{4023:3927},3931:{4023:3932},3953:{3954:3955,3956:3957,3968:3969},3984:{4021:4025},3986:{4023:3987},3996:{4023:3997},4001:{4023:4002},4006:{4023:4007},4011:{4023:4012},4018:{3968:3958},4019:{3968:3960},4133:{4142:4134},7734:{772:7736},7735:{772:7737},7770:{772:7772},7771:{772:7773},7778:{775:7784},7779:{775:7785},7840:{770:7852,774:7862},7841:{770:7853,774:7863},7864:{770:7878},7865:{770:7879},7884:{770:7896},7885:{770:7897},7936:{768:7938,769:7940,834:7942,837:8064},7937:{768:7939,769:7941,834:7943,837:8065},7938:{837:8066},7939:{837:8067},7940:{837:8068},7941:{837:8069},7942:{837:8070},7943:{837:8071},7944:{768:7946,769:7948,834:7950,837:8072},7945:{768:7947,769:7949,834:7951,837:8073},7946:{837:8074},7947:{837:8075},7948:{837:8076},7949:{837:8077},7950:{837:8078},7951:{837:8079},7952:{768:7954,769:7956},7953:{768:7955,769:7957},7960:{768:7962,769:7964},7961:{768:7963,769:7965},7968:{768:7970,769:7972,834:7974,837:8080},7969:{768:7971,769:7973,834:7975,837:8081},7970:{837:8082},7971:{837:8083},7972:{837:8084},7973:{837:8085},7974:{837:8086},7975:{837:8087},7976:{768:7978,769:7980,834:7982,837:8088},7977:{768:7979,769:7981,834:7983,837:8089},7978:{837:8090},7979:{837:8091},7980:{837:8092},7981:{837:8093},7982:{837:8094},7983:{837:8095},7984:{768:7986,769:7988,834:7990},7985:{768:7987,769:7989,834:7991},7992:{768:7994,769:7996,834:7998},7993:{768:7995,769:7997,834:7999},8e3:{768:8002,769:8004},8001:{768:8003,769:8005},8008:{768:8010,769:8012},8009:{768:8011,769:8013},8016:{768:8018,769:8020,834:8022},8017:{768:8019,769:8021,834:8023},8025:{768:8027,769:8029,834:8031},8032:{768:8034,769:8036,834:8038,837:8096},8033:{768:8035,769:8037,834:8039,837:8097},8034:{837:8098},8035:{837:8099},8036:{837:8100},8037:{837:8101},8038:{837:8102},8039:{837:8103},8040:{768:8042,769:8044,834:8046,837:8104},8041:{768:8043,769:8045,834:8047,837:8105},8042:{837:8106},8043:{837:8107},8044:{837:8108},8045:{837:8109},8046:{837:8110},8047:{837:8111},8048:{837:8114},8052:{837:8130},8060:{837:8178},8118:{837:8119},8127:{768:8141,769:8142,834:8143},8134:{837:8135},8182:{837:8183},8190:{768:8157,769:8158,834:8159},8592:{824:8602},8594:{824:8603},8596:{824:8622},8656:{824:8653},8658:{824:8655},8660:{824:8654},8707:{824:8708},8712:{824:8713},8715:{824:8716},8739:{824:8740},8741:{824:8742},8764:{824:8769},8771:{824:8772},8773:{824:8775},8776:{824:8777},8781:{824:8813},8801:{824:8802},8804:{824:8816},8805:{824:8817},8818:{824:8820},8819:{824:8821},8822:{824:8824},8823:{824:8825},8826:{824:8832},8827:{824:8833},8828:{824:8928},8829:{824:8929},8834:{824:8836},8835:{824:8837},8838:{824:8840},8839:{824:8841},8849:{824:8930},8850:{824:8931},8866:{824:8876},8872:{824:8877},8873:{824:8878},8875:{824:8879},8882:{824:8938},8883:{824:8939},8884:{824:8940},8885:{824:8941},10973:{824:10972},12358:{12441:12436},12363:{12441:12364},12365:{12441:12366},12367:{12441:12368},12369:{12441:12370},12371:{12441:12372},12373:{12441:12374},12375:{12441:12376},12377:{12441:12378},12379:{12441:12380},12381:{12441:12382},12383:{12441:12384},12385:{12441:12386},12388:{12441:12389},12390:{12441:12391},12392:{12441:12393},12399:{12441:12400,12442:12401},12402:{12441:12403,12442:12404},12405:{12441:12406,12442:12407},12408:{12441:12409,12442:12410},12411:{12441:12412,12442:12413},12445:{12441:12446},12454:{12441:12532},12459:{12441:12460},12461:{12441:12462},12463:{12441:12464},12465:{12441:12466},12467:{12441:12468},12469:{12441:12470},12471:{12441:12472},12473:{12441:12474},12475:{12441:12476},12477:{12441:12478},12479:{12441:12480},12481:{12441:12482},12484:{12441:12485},12486:{12441:12487},12488:{12441:12489},12495:{12441:12496,12442:12497},12498:{12441:12499,12442:12500},12501:{12441:12502,12442:12503},12504:{12441:12505,12442:12506},12507:{12441:12508,12442:12509},12527:{12441:12535},12528:{12441:12536},12529:{12441:12537},12530:{12441:12538},12541:{12441:12542},64329:{1473:64300,1474:64301},119127:{119141:119134},119128:{119141:119135},119135:{119150:119136,119151:119137,119152:119138,119153:119139,119154:119140},119225:{119141:119227},119226:{119141:119228},119227:{119150:119229,119151:119231},119228:{119150:119230,119151:119232}};function z(e){var t,r,n=e.length;for(t=0;t<n&&!(e[t]<0||e[t]>=256);t++);if(t==n)return e;for(r=Array(n),t=0;t<n;t++)e[t]<0||e[t]>=256?r[t]=63:r[t]=e[t];return r}function q(e){var t,r,n=e.length;if(0==n)return"";for(t=0;t<n&&!(e[t]<0||e[t]>=256);t++);if(t==n)return String.fromCharCode.apply(this,e);for(r=Array(n),t=0;t<n;t++)r[t]=String.fromCharCode(255&e[t]);return r.join("")}function A(e){var t,r,n,i=e.length;if(0==i)return"";for(t=0;t<i&&!(e[t]>=65536);t++);if(t==i)return String.fromCharCode.apply(this,e);for(n=Array(i),t=0;t<i;t++)(r=e[t])<65536?n[t]=String.fromCharCode(r):(r-=65536,n[t]=String.fromCharCode(55296+(r>>10),56320+(1023&r)));return n.join("")}function F(e){var t=0;for(let r=0;r<e.length;r++){const n=e[r];t+=n<128?1:n<2048?2:n<65536?3:n<2097152?4:1}if(t==e.length)return e;const r=[];for(let t=0;t<e.length;t++){const n=e[t];n<128?r.push(n):n<2048?(r.push(192|(1984&n)>>6),r.push(128|63&n)):n<65536?(r.push(224|(61440&n)>>12),r.push(128|(4032&n)>>6),r.push(128|63&n)):n<2097152?(r.push(240|(1835008&n)>>18),r.push(128|(258048&n)>>12),r.push(128|(4032&n)>>6),r.push(128|63&n)):r.push(63)}return r}function D(e){for(var t=new Array(4*e.length),r=0;r<e.length;r++){var n=e[r];t[4*r]=n>>24&255,t[4*r+1]=n>>16&255,t[4*r+2]=n>>8&255,t[4*r+3]=255&n}return t}var $={dummy:"Glk call has not yet returned"};var L=1,I=2,N=3,E=4,B=null,R=null,W=null,O=!0,P=null,Q=null,V=null,H=null,Y=null,Z=1,J=null,X=null,K=null;function ee(e,t){var n={};return n.type=e,n.rock=t,n.disprock=void 0,n.parent=null,n.str=function(e){var t;return(t=le(I,!1,!0,0)).unicode=!0,t.win=e,t}(n),n.echostr=null,n.style=b.style_Normal,n.hyperlink=0,n.input_generation=null,n.linebuf=null,n.char_request=!1,n.line_request=!1,n.char_request_uni=!1,n.line_request_uni=!1,n.hyperlink_request=!1,n.mouse_request=!1,n.echo_line_input=!0,n.line_input_terminators=[],n.request_echo_line_input=null,n.prev=null,n.next=R,R=n,n.next&&(n.next.prev=n),r?r.class_register("window",n):n.disprock=Z++,O=!0,n}function te(e){var t,n;r&&r.class_unregister("window",e),O=!0,e.echostr=null,e.str&&(ue(e.str),e.str=null),t=e.prev,n=e.next,e.prev=null,e.next=null,t?t.next=n:R=n,n&&(n.prev=t),e.parent=null,e.rock=null,e.disprock=null}function re(e,t){var r,n;switch(e.type){case b.wintype_TextBuffer:e.style==e.accumstyle&&e.hyperlink==e.accumhyperlink&&e.fg==e.accum_fg&&e.bg==e.accum_bg&&e.reverse==e.accum_reverse||ie(e),e.accum.push(t);break;case b.wintype_TextGrid:for(r=0;r<t.length;r++){if(n=t.charAt(r),e.cursorx<0?e.cursorx=0:e.cursorx>=e.gridwidth&&(e.cursorx=0,e.cursory++),e.cursory<0)e.cursory=0;else if(e.cursory>=e.gridheight)break;if("\n"!=n){var i=e.lines[e.cursory];i.dirty=!0,i.chars[e.cursorx]=n,i.styles[e.cursorx]=e.style,i.hyperlinks[e.cursorx]=e.hyperlink,i.fgs[e.cursorx]=e.fg,i.bgs[e.cursorx]=e.bg,i.reverses[e.cursorx]=e.reverse,e.cursorx++}else e.cursory++,e.cursorx=0}}}function ne(e){if(e.cursorx<0?e.cursorx=0:e.cursorx>=e.gridwidth&&(e.cursorx=0,e.cursory++),e.cursory<0)e.cursory=0;else if(e.cursory>=e.gridheight)return!0;return!1}function ie(e){var t,r,n,i,s=e.content,o=x[e.accumstyle];if(e.accum.length)for(t=e.accum.join("").split("\n"),r=0;r<t.length;r++)if(i=void 0,0==r?t[r]&&(0==s.length?(i=[],s.push({content:i,append:!0})):(n=s[s.length-1]).content?i=n.content:(i=[],n.content=i)):t[r]?(i=[],s.push({content:i})):s.push({}),void 0!==i)if(e.accumhyperlink||e.accum_fg||e.accum_bg||e.accum_reverse){const n={style:o,text:t[r]};e.accumhyperlink&&(n.hyperlink=e.accumhyperlink),e.accum_fg&&(n.fg=e.accum_fg),e.accum_bg&&(n.bg=e.accum_bg),e.accum_reverse&&(n.reverse=1),i.push(n)}else i.push(o),i.push(t[r]);e.accum.length=0,e.accumstyle=e.style,e.accumhyperlink=e.hyperlink,e.accum_fg=e.fg,e.accum_bg=e.bg,e.accum_reverse=e.reverse}function se(e,t,r){ie(e);var n,i=e.content,s=void 0;0==i.length?(n={content:s=[],append:!0},r&&(n.flowbreak=!0),i.push(n)):(n=i[i.length-1],r&&(n.flowbreak=!0),n.content?s=n.content:(s=[],n.content=s)),void 0!==s&&void 0!==t&&s.push(t)}function oe(e,t){var n;for(n=e.parent;n;n=n.parent)n.type==b.wintype_Pair&&n.pair_key===e&&(n.pair_key=null,n.pair_keydamage=!0);switch(r&&e.linebuf&&(r.unretain_array(e.linebuf),e.linebuf=null),e.type){case b.wintype_Pair:t&&(e.child1&&oe(e.child1,!0),e.child2&&oe(e.child2,!0)),e.child1=null,e.child2=null,e.pair_key=null;break;case b.wintype_TextBuffer:e.accum=null,e.content=null,e.reserve=null;break;case b.wintype_TextGrid:e.lines=null;break;case b.wintype_Graphics:e.content=null,e.reserve=null}te(e)}function ae(e,t){var r,n,i,s,o,a,l,u,f,c,d,h,p,_,g,m;switch(O=!0,e.bbox=t,e.type){case b.wintype_TextGrid:if(r=t.right-t.left,n=t.bottom-t.top,s=e.gridheight,e.gridwidth=Math.max(0,Math.floor((r-P.gridmarginx)/P.gridcharwidth)),e.gridheight=Math.max(0,Math.floor((n-P.gridmarginy)/P.gridcharheight)),s>e.gridheight)e.lines.length=e.gridheight;else if(s<e.gridheight)for(c=s;c<e.gridheight;c++)e.lines[c]={chars:[],styles:[],hyperlinks:[],fgs:[],bgs:[],reverses:[],dirty:!0};for(c=0;c<e.gridheight;c++)if((i=(h=e.lines[c]).chars.length)>e.gridwidth)h.dirty=!0,h.chars.length=e.gridwidth,h.styles.length=e.gridwidth,h.hyperlinks.length=e.gridwidth,h.fgs.length=e.gridwidth,h.bgs.length=e.gridwidth,h.reverses.length=e.gridwidth;else if(i<e.gridwidth)for(h.dirty=!0,d=i;d<e.gridwidth;d++)h.chars[d]=" ",h.styles[d]=b.style_Normal,h.hyperlinks[d]=0,h.fgs[d]=null,h.bgs[d]=null,h.reverses[d]=0;break;case b.wintype_Graphics:r=t.right-t.left,n=t.bottom-t.top,e.graphwidth=Math.max(0,r-P.graphicsmarginx),e.graphheight=Math.max(0,n-P.graphicsmarginy);break;case b.wintype_Pair:e.pair_vertical?(o=e.bbox.left,a=e.bbox.right,f=P.inspacingx):(o=e.bbox.top,a=e.bbox.bottom,f=P.inspacingy),e.pair_hasborder||(f=0),l=a-o,e.pair_division==b.winmethod_Proportional?u=Math.floor(l*e.pair_size/100):e.pair_division==b.winmethod_Fixed?(u=0,e.pair_key&&e.pair_key.type==b.wintype_TextBuffer&&(u=e.pair_vertical?e.pair_size*P.buffercharwidth+P.buffermarginx:e.pair_size*P.buffercharheight+P.buffermarginy),e.pair_key&&e.pair_key.type==b.wintype_TextGrid&&(u=e.pair_vertical?e.pair_size*P.gridcharwidth+P.gridmarginx:e.pair_size*P.gridcharheight+P.gridmarginy),e.pair_key&&e.pair_key.type==b.wintype_Graphics&&(u=e.pair_vertical?e.pair_size+P.graphicsmarginx:e.pair_size+P.graphicsmarginy),u=Math.ceil(u)):u=Math.floor(l/2),u=e.pair_backward?o+u:a-u-f,u=o>=a?o:Math.min(Math.max(u,o),a-f),e.pair_splitpos=u,e.pair_splitwidth=f,_=e.pair_vertical?{left:(p={left:e.bbox.left,right:e.pair_splitpos,top:e.bbox.top,bottom:e.bbox.bottom}).right+e.pair_splitwidth,right:e.bbox.right,top:e.bbox.top,bottom:e.bbox.bottom}:{top:(p={top:e.bbox.top,bottom:e.pair_splitpos,left:e.bbox.left,right:e.bbox.right}).bottom+e.pair_splitwidth,bottom:e.bbox.bottom,left:e.bbox.left,right:e.bbox.right},e.pair_backward?(g=e.child2,m=e.child1):(g=e.child1,m=e.child2),ae(g,p),ae(m,_)}}function le(e,t,n,i){var s={};return s.type=e,s.rock=i,s.disprock=void 0,s.unicode=!1,s.isbinary=!1,s.streaming=!1,s.ref=null,s.win=null,s.file=null,s.buf=null,s.bufpos=0,s.buflen=0,s.bufeof=0,s.timer_id=null,s.flush_func=null,s.fstream=null,s.readcount=0,s.writecount=0,s.readable=t,s.writable=n,s.prev=null,s.next=Q,Q=s,s.next&&(s.next.prev=s),r&&r.class_register("stream",s),s}function ue(e){var t,n;e===H&&(H=null),function(e){var t;for(t=R;t;t=t.next)t.echostr===e&&(t.echostr=null)}(e),e.type==N?r&&r.unretain_array(e.buf):e.type==L&&e.fstream&&(e.fstream.fclose(),e.fstream=null),r&&r.class_unregister("stream",e),t=e.prev,n=e.next,e.prev=null,e.next=null,t?t.next=n:Q=n,n&&(n.prev=t),e.fstream=null,e.buf=null,e.readable=!1,e.writable=!1,e.ref=null,e.win=null,e.file=null,e.rock=null,e.disprock=null}function fe(e){e.streaming&&i.log("### gli_stream_dirty_file called for streaming file!"),null===e.timer_id&&(null===e.flush_func&&(e.flush_func=function(){ce(e)}),e.timer_id=setTimeout(e.flush_func,1e4))}function ce(e){e.streaming&&i.log("### gli_stream_flush_file called for streaming file!"),null!==e.timer_id&&clearTimeout(e.timer_id),e.timer_id=null,t.file_write(e.ref,e.buf)}function de(n,i,s,o){var a={};if(a.filename=n,a.rock=s,a.disprock=void 0,a.textmode=0!=(i&b.fileusage_TextMode),a.filetype=i&b.fileusage_TypeMask,a.filetypename=U[a.filetype],a.filetypename||(a.filetypename="xxx"),!o){var l="";a.filetype==b.fileusage_SavedGame&&(l=e.get_signature()),o=t.file_construct_ref(a.filename,a.filetypename,l)}return a.ref=o,a.prev=null,a.next=V,V=a,a.next&&(a.next.prev=a),r&&r.class_register("fileref",a),a}function he(e,t){if(!e||!e.writable)throw"gli_put_char: invalid stream";switch(e.unicode||(t<0||t>=256)&&(t=63),e.writecount+=1,e.type){case L:var r;if(e.streaming)if(e.unicode)if(e.isbinary)e.buffer4.writeUInt32BE(t,0,!0),e.fstream.fwrite(e.buffer4,4);else if(t<65536)r=e.buffer4.write(String.fromCharCode(t)),e.fstream.fwrite(e.buffer4,r);else{var n=F([t]),i=e.fstream.BufferClass.from(n);e.fstream.fwrite(i)}else e.buffer4[0]=t,e.fstream.fwrite(e.buffer4,1);else if(fe(e),!e.unicode||t<128&&!e.isbinary)e.bufpos<e.buflen&&(e.buf[e.bufpos]=t,e.bufpos+=1,e.bufpos>e.bufeof&&(e.bufeof=e.bufpos));else{let r;r=e.isbinary?D([t]):F([t]);let n=r.length;n>e.buflen-e.bufpos&&(n=e.buflen-e.bufpos);for(let t=0;t<n;t++)e.buf[e.bufpos+t]=r[t];e.bufpos+=n,e.bufpos>e.bufeof&&(e.bufeof=e.bufpos)}break;case N:e.bufpos<e.buflen&&(e.buf[e.bufpos]=t,e.bufpos+=1,e.bufpos>e.bufeof&&(e.bufeof=e.bufpos));break;case I:if(e.win.line_request)throw"gli_put_char: window has pending line request";re(e.win,(s=t)<65536?String.fromCharCode(s):(s-=65536,String.fromCharCode(55296+(s>>10),56320+(1023&s)))),e.win.echostr&&he(e.win.echostr,t)}var s}function pe(e,t,r){var n,i;if(!e||!e.writable)throw"gli_put_array: invalid stream";switch(e.unicode||r||(t=z(t),r=!0),e.writecount+=t.length,e.type){case L:if(e.streaming)if(e.unicode)if(e.isbinary){const r=e.fstream.BufferClass.alloc(4*t.length);for(let e=0;e<t.length;e++)r.writeUInt32BE(t[e],4*e,!0);e.fstream.fwrite(r)}else{const r=F(t),n=e.fstream.BufferClass.from(r);e.fstream.fwrite(n)}else{const r=e.fstream.BufferClass.from(t);e.fstream.fwrite(r)}else{var s;fe(e);let r=(s=e.unicode?e.isbinary?D(t):F(t):t).length;r>e.buflen-e.bufpos&&(r=e.buflen-e.bufpos);for(let t=0;t<r;t++)e.buf[e.bufpos+t]=s[t];e.bufpos+=r,e.bufpos>e.bufeof&&(e.bufeof=e.bufpos)}break;case N:(n=t.length)>e.buflen-e.bufpos&&(n=e.buflen-e.bufpos);for(let r=0;r<n;r++)e.buf[e.bufpos+r]=t[r];e.bufpos+=n,e.bufpos>e.bufeof&&(e.bufeof=e.bufpos);break;case I:if(e.win.line_request)throw"gli_put_array: window has pending line request";i=r?String.fromCharCode.apply(this,t):A(t),re(e.win,i),e.win.echostr&&pe(e.win.echostr,t,r)}}function _e(e,t){var r;if(!e||!e.readable)return-1;switch(e.type){case L:if(e.streaming){if(e.unicode){if(e.isbinary){if(e.fstream.fread(e.buffer4,4)<4)return-1;r=e.buffer4[0]<<24,r|=e.buffer4[1]<<16,r|=e.buffer4[2]<<8,r|=e.buffer4[3]}else{let t,n,i,s;if(!e.fstream.fread(e.buffer4,1))return-1;if(t=e.buffer4[0],t<128)r=t;else{if(!e.fstream.fread(e.buffer4,1))return-1;if(n=e.buffer4[0],128!=(192&n))return-1;if(192==(224&t))r=(31&t)<<6,r|=63&n;else{if(!e.fstream.fread(e.buffer4,1))return-1;if(i=e.buffer4[0],128!=(192&i))return-1;if(224==(240&t))r=(15&t)<<12&61440,r|=(63&n)<<6&4032,r|=63&i;else{if(240!=(240&t))return-1;if(!e.fstream.fread(e.buffer4,1))return-1;if(s=e.buffer4[0],128!=(192&s))return-1;r=(7&t)<<18&1835008,r|=(63&n)<<12&258048,r|=(63&i)<<6&4032,r|=63&s}}}}return e.readcount++,r>>>=0,!t&&r>=256?63:r}return e.fstream.fread(e.buffer4,1)?(e.readcount++,e.buffer4[0]):-1}case E:if(e.unicode){if(e.isbinary){if(e.bufpos>=e.bufeof)return-1;if(r=e.buf[e.bufpos],e.bufpos++,e.bufpos>=e.bufeof)return-1;if(r=r<<8|255&e.buf[e.bufpos],e.bufpos++,e.bufpos>=e.bufeof)return-1;if(r=r<<8|255&e.buf[e.bufpos],e.bufpos++,e.bufpos>=e.bufeof)return-1;r=r<<8|255&e.buf[e.bufpos],e.bufpos++}else{let t,n,i,s;if(e.bufpos>=e.bufeof)return-1;if(t=e.buf[e.bufpos],e.bufpos++,t<128)r=t;else{if(e.bufpos>=e.bufeof)return-1;if(n=e.buf[e.bufpos],e.bufpos++,128!=(192&n))return-1;if(192==(224&t))r=(31&t)<<6,r|=63&n;else{if(e.bufpos>=e.bufeof)return-1;if(i=e.buf[e.bufpos],e.bufpos++,128!=(192&i))return-1;if(224==(240&t))r=(15&t)<<12&61440,r|=(63&n)<<6&4032,r|=63&i;else{if(240!=(240&t))return-1;if(e.bufpos>=e.bufeof)return-1;if(s=e.buf[e.bufpos],e.bufpos++,128!=(192&s))return-1;r=(7&t)<<18&1835008,r|=(63&n)<<12&258048,r|=(63&i)<<6&4032,r|=63&s}}}}return e.readcount++,r>>>=0,!t&&r>=256?63:r}case N:return e.bufpos<e.bufeof?(r=e.buf[e.bufpos],e.bufpos++,e.readcount++,!t&&r>=256?63:r):-1;default:return-1}}function ge(e,t,r){if(!e||!e.readable)return 0;var n,i,s,o=t.length;switch(e.type){case L:if(e.streaming){if(0==o)return 0;for(o-=1,s=!1,n=0;n<o&&!s&&-1!=(i=_e(e,r));n++)t[n]=i,s=10==i;return n}case E:if(e.unicode){if(0==o)return 0;for(o-=1,s=!1,n=0;n<o&&!s&&-1!=(i=_e(e,r));n++)t[n]=i,s=10==i;return n}case N:if(0==o)return 0;if(o-=1,e.bufpos>=e.bufeof?o=0:e.bufpos+o>e.bufeof&&(o=e.bufeof-e.bufpos),s=!1,r)for(n=0;n<o&&!s;n++)i=e.buf[e.bufpos++],t[n]=i,s=10==i;else for(n=0;n<o&&!s;n++)i=e.buf[e.bufpos++],!r&&i>=256&&(i=63),t[n]=i,s=10==i;return e.readcount+=n,n;default:return 0}}function me(e,t,r){if(!e||!e.readable)return 0;var n,i,s=t.length;switch(e.type){case L:if(e.streaming){for(n=0;n<s&&-1!=(i=_e(e,r));n++)t[n]=i;return n}case E:if(e.unicode){for(n=0;n<s&&-1!=(i=_e(e,r));n++)t[n]=i;return n}case N:if(e.bufpos>=e.bufeof?s=0:e.bufpos+s>e.bufeof&&(s=e.bufeof-e.bufpos),r)for(n=0;n<s;n++)t[n]=e.buf[e.bufpos++];else for(n=0;n<s;n++)i=e.buf[e.bufpos++],!r&&i>=256&&(i=63),t[n]=i;return e.readcount+=s,s;default:return 0}}function we(e,t){t&&(t.set_field(0,e.readcount),t.set_field(1,e.writecount))}function ve(e,t,r){var n;if(!e||!e.writable)throw"glk_put_jstring: invalid stream";switch(e.writecount+=t.length,e.type){case L:if(e.streaming)if(e.unicode)if(e.isbinary){const r=e.fstream.BufferClass.alloc(4*t.length);for(let e=0;e<t.length;e++)r.writeUInt32BE(t.charCodeAt(e),4*e,!0);e.fstream.fwrite(r)}else{const r=e.fstream.BufferClass.from(t);e.fstream.fwrite(r)}else{const r=e.fstream.BufferClass.from(t,"binary");e.fstream.fwrite(r)}else{fe(e);const r=[];for(let e=0;e<t.length;e++)r.push(t.charCodeAt(e));let n;n=e.unicode?e.isbinary?D(r):F(r):r;let i=n.length;i>e.buflen-e.bufpos&&(i=e.buflen-e.bufpos);for(let t=0;t<i;t++)e.buf[e.bufpos+t]=n[t];e.bufpos+=i,e.bufpos>e.bufeof&&(e.bufeof=e.bufpos)}break;case N:if((n=t.length)>e.buflen-e.bufpos&&(n=e.buflen-e.bufpos),e.unicode||r)for(let r=0;r<n;r++)e.buf[e.bufpos+r]=t.charCodeAt(r);else for(let r=0;r<n;r++){var i=t.charCodeAt(r);(i<0||i>=256)&&(i=63),e.buf[e.bufpos+r]=i}e.bufpos+=n,e.bufpos>e.bufeof&&(e.bufeof=e.bufpos);break;case I:if(e.win.line_request)throw"glk_put_jstring: window has pending line request";re(e.win,t),e.win.echostr&&ve(e.win.echostr,t,r)}}function be(e,t){if(!e||!e.writable)throw"gli_set_style: invalid stream";t>=b.style_NUMSTYLES&&(t=0),e.type==I&&(e.win.style=t,e.win.echostr&&be(e.win.echostr,t))}function ke(e,t){if(!e||!e.writable)throw"gli_set_hyperlink: invalid stream";e.type==I&&(e.win.hyperlink=t,e.win.echostr&&ke(e.win.echostr,t))}function ye(e,t,r){switch(e){case 0:return 1796;case 1:return t<=b.keycode_Left&&t>=b.keycode_End?1:t>=4294967296-b.keycode_MAXVAL||t>1114111||t>=0&&t<32||t>=127&&t<160?0:1;case 2:return t>1114111||(t>=0&&t<32||t>=127&&t<160)?0:1;case 3:return t>1114111||t>=0&&t<32||t>=127&&t<160?(r&&(r[0]=1),0):(r&&(r[0]=1),2);case 4:return t==b.wintype_TextGrid||s.graphics&&t==b.wintype_Graphics?1:0;case 5:return s.timer||0;case 6:return s.graphics||0;case 7:return!s.graphics||t!==b.wintype_TextBuffer&&t!==b.wintype_Graphics?0:1;case 8:case 9:case 10:return 0;case 11:return s.hyperlinks||0;case 12:return!s.hyperlinks||t!==b.wintype_TextBuffer&&t!==b.wintype_TextGrid?0:1;case 13:return 0;case 14:return s.graphics||0;case 15:case 16:case 17:case 18:return 1;case 19:return t==b.keycode_Escape||t>=b.keycode_Func12&&t<=b.keycode_Func1?1:0;case 20:return 1;case 21:return 0;case 22:return 1;case 23:return 0;case 4352:return s.garglktext||0}if(f){var n=f(e,t,r);if(void 0!==n)return n}return 0}var xe={buffer:[],grid:[]};for(let e=0;e<b.style_NUMSTYLES;e++)xe.buffer.push({}),xe.grid.push({});var Ue=["margin-left","text-indent","text-align","font-size","font-weight","font-style","font-family","color","background-color","reverse"];function Ce(e,t,r){if(!e||!e.writable)throw"garglk_set_zcolors: invalid stream";t>>=0,r>>=0,e.type==I&&(-2!==t&&(e.win.fg=-1===t?null:"#"+("000000"+t.toString(16)).slice(-6)),-2!==r&&(e.win.bg=-1===r?null:"#"+("000000"+r.toString(16)).slice(-6)),e.win.echostr&&Ce(e.win.echostr,t,r))}function Se(e,t){if(!e||!e.writable)throw"garglk_set_reversevideo: invalid stream";e.type==I&&(e.win.reverse=t||null,e.win.echostr&&Se(e.win.echostr,t))}function Me(e){e?(J=e,X=Date.now()):(J=null,X=null)}function je(e){for(var t=(16777215&e).toString(16);t.length<6;)t="0"+t;return"#"+t.toUpperCase()}function Ge(e,t){var r,n,i,s,o,a,l,u,f,c=e.slice(0,t);for(r=0,n=0;n<t;n++)if(s=c[n],void 0===(o=j[s]))e[r]=s,r++;else if(o instanceof Array)for(i=0;i<o.length;i++)e[r]=o[i],r++;else e[r]=o,r++;for(n=0;n<r;)if(G[e[n]]){if(n>=r)break;for(a=n;n<r&&G[e[n]];)n++;if((l=n)-a>=2)for(i=l-1;i>a;i--)for(u=a;u<i;u++)G[e[u]]>G[e[u+1]]&&(f=e[u],e[u]=e[u+1],e[u+1]=f)}else n++;return r}return{version:"2.2.5",init:function(s){if(!s.Dialog)throw new Error("No reference to Dialog");if(t=s.Dialog,s.GiDispa&&(r=s.GiDispa),s.GiLoad&&(n=s.GiLoad),!s.GlkOte)throw new Error("No reference to GlkOte");i=s.GlkOte,e=s.vm,r&&r.set_vm(e),s.accept=w,i.init(s),o=s.exit_warning,a=s.do_vm_autosave,l=s.before_select_hook,u=s.extevent_hook,f=s.glk_gestalt_hook,l&&l()},update:function(){var t,n,s,o,u,f,p,g,w,v,k,y={type:"update",gen:_},U=null,C=null,S=null;if(O)for(O=!1,U=[],t=R;t;t=t.next)if(t.type!=b.wintype_Pair){switch(n={id:t.disprock,rock:t.rock},U.push(n),t.type){case b.wintype_TextBuffer:n.type="buffer",n.stylehints=t.stylehints;break;case b.wintype_TextGrid:n.type="grid",n.gridwidth=t.gridwidth,n.gridheight=t.gridheight,n.stylehints=t.stylehints;break;case b.wintype_Graphics:n.type="graphics",n.graphwidth=t.graphwidth,n.graphheight=t.graphheight}n.left=t.bbox.left,n.top=t.bbox.top,n.width=t.bbox.right-t.bbox.left,n.height=t.bbox.bottom-t.bbox.top}for(t=R;t;t=t.next){switch(o=!1,n={id:t.disprock},null==C&&(C=[]),t.type){case b.wintype_TextBuffer:if(ie(t),t.content.length&&(n.text=t.content.slice(0),t.content.length=0,o=!0),t.clearcontent&&(n.clear=!0,t.bg&&(n["background-color"]=t.bg),t.clearcontent=!1,o=!0,n.text||(n.text=[]),t.reserve.length=0),n.text&&n.text.length)for(g=0;g<n.text.length;g++)t.reserve.push(n.text[g]);t.reserve.length>100&&t.reserve.splice(0,t.reserve.length-100);break;case b.wintype_TextGrid:if(0==t.gridwidth||0==t.gridheight)break;for(n.lines=[],g=0;g<t.gridheight;g++)if((u=t.lines[g]).dirty){for(u.dirty=!1,f=[],k=0,w=0;w<t.gridwidth;){const e=u.styles[w],r=u.hyperlinks[w],n=u.fgs[w],i=u.bgs[w],o=u.reverses[w];for(;w<t.gridwidth&&u.styles[w]===e&&u.hyperlinks[w]===r&&u.fgs[w]===n&&u.bgs[w]===i&&u.reverses[w]===o;w++);k<w&&(r||null!=n||null!=i||o?(s={style:x[e],text:u.chars.slice(k,w).join(""),hyperlink:r,fg:n,bg:i,reverse:o},f.push(s)):(f.push(x[e]),f.push(u.chars.slice(k,w).join(""))),k=w)}n.lines.push({line:g,content:f})}o=n.lines.length;break;case b.wintype_Graphics:t.content.length&&(n.draw=t.content.slice(0),t.content.length=0,o=!0);var M=-1;if(n.draw&&n.draw.length)for(g=0;g<n.draw.length;g++){var j=n.draw[g];"fill"==j.special&&void 0===j.x&&void 0===j.y&&void 0===j.width&&void 0===j.height&&(M=t.reserve.length),t.reserve.push(j)}if(M>=0){var G=null;for(let e=0;e<t.reserve.length&&e<M;e++){const r=t.reserve[e];"setcolor"==r.special&&(G=r)}t.reserve.splice(0,M),G&&t.reserve.unshift(G)}}o&&C.push(n)}for(S=[],t=R;t;t=t.next)n=null,t.char_request&&(n={id:t.disprock,type:"char",gen:t.input_generation},t.type==b.wintype_TextGrid&&(ne(t)?(n.xpos=t.gridwidth,n.ypos=t.gridheight-1):(n.xpos=t.cursorx,n.ypos=t.cursory))),t.line_request&&(v="",m&&(p=m[t.disprock])&&(v=p),n={id:t.disprock,type:"line",gen:t.input_generation,maxlen:t.linebuf.length,initial:v},t.line_input_terminators.length&&(n.terminators=t.line_input_terminators),t.type==b.wintype_TextGrid&&(ne(t)?(n.xpos=t.gridwidth,n.ypos=t.gridheight-1):(n.xpos=t.cursorx,n.ypos=t.cursory))),t.hyperlink_request&&(n||(n={id:t.disprock}),n.hyperlink=!0),t.mouse_request&&(n||(n={id:t.disprock}),n.mouse=!0),n&&S.push(n);if(y.windows=U,y.content=C,y.input=S,K!=J&&(y.timer=J,K=J),h&&(y.specialinput=h),d&&(y.disable=!0),m=null,B&&(y.autorestore=B),B=null,i.update(y,B),l&&l(),a)if(c)e.do_autosave(-1);else if(r){var T=r.check_autosave();T&&e.do_autosave(T)}},save_allstate:function(){var e={};W&&(e.rootwin=W.disprock),H&&(e.currentstr=H.disprock),J&&(e.timer_interval=J),e.windows=[];for(var n=R;n;n=n.next){var s={type:n.type,rock:n.rock,disprock:n.disprock,style:n.style,hyperlink:n.hyperlink};if(n.parent&&(s.parent=n.parent.disprock),s.str=n.str.disprock,n.echostr&&(s.echostr=n.echostr.disprock),s.bbox={left:n.bbox.left,right:n.bbox.right,top:n.bbox.top,bottom:n.bbox.bottom},null!==n.linebuf){var o=r.get_retained_array(n.linebuf);s.linebuf={addr:o.addr,len:o.len,arr:o.arr.slice(0),arg:o.arg.serialize()}}switch(s.char_request=n.char_request,s.line_request=n.line_request,s.char_request_uni=n.char_request_uni,s.line_request_uni=n.line_request_uni,s.hyperlink_request=n.hyperlink_request,s.mouse_request=n.mouse_request,s.echo_line_input=n.echo_line_input,s.request_echo_line_input=n.request_echo_line_input,s.line_input_terminators=n.line_input_terminators.slice(0),n.type){case b.wintype_TextBuffer:s.reserve=n.reserve.slice(0);break;case b.wintype_TextGrid:s.gridwidth=n.gridwidth,s.gridheight=n.gridheight,s.lines=[];for(var a=0;a<n.lines.length;a++){var l=n.lines[a];s.lines.push({chars:l.chars.slice(0),styles:l.styles.slice(0),hyperlinks:l.hyperlinks.slice(0),fgs:l.fgs.slice(0),bgs:l.bgs.slice(0),reverses:l.reverses.slice(0)})}s.cursorx=n.cursorx,s.cursory=n.cursory;break;case b.wintype_Graphics:s.graphwidth=n.graphwidth,s.graphheight=n.graphheight,s.reserve=n.reserve.slice(0);break;case b.wintype_Pair:s.pair_dir=n.pair_dir,s.pair_division=n.pair_division,s.pair_key=n.pair_key.disprock,s.pair_keydamage=!1,s.pair_size=n.pair_size,s.pair_hasborder=n.pair_hasborder,s.pair_vertical=n.pair_vertical,s.pair_backward=n.pair_backward,s.child1=n.child1.disprock,s.child2=n.child2.disprock}e.windows.push(s)}e.streams=[];for(let n=Q;n;n=n.next){const i={type:n.type,rock:n.rock,disprock:n.disprock,unicode:n.unicode,isbinary:n.isbinary,readcount:n.readcount,writecount:n.writecount,readable:n.readable,writable:n.writable,streaming:n.streaming};switch(n.type){case I:n.win&&(i.win=n.win.disprock);break;case N:if(null!==n.buf){const e=r.get_retained_array(n.buf);i.buf={addr:e.addr,len:e.len,arr:e.arr.slice(0),arg:e.arg.serialize()}}i.buflen=n.buflen,i.bufpos=n.bufpos,i.bufeof=n.bufeof;break;case E:i.resfilenum=n.resfilenum,i.buflen=n.buflen,i.bufpos=n.bufpos,i.bufeof=n.bufeof;break;case L:i.origfmode=n.origfmode,t.streaming?(n.fstream.fflush(),i.ref=n.ref,i.filepos=n.fstream.ftell()):(i.ref=n.ref,ce(n),i.buflen=n.buflen,i.bufpos=n.bufpos,i.bufeof=n.bufeof)}e.streams.push(i)}e.filerefs=[];for(let t=V;t;t=t.next){const r={type:t.type,rock:t.rock,disprock:t.disprock,filename:t.filename,textmode:t.textmode,filetype:t.filetype,filetypename:t.filetypename};r.ref=t.ref,e.filerefs.push(r)}return e.glkote=i.save_allstate(),e},restore_allstate:function(e){if(R||Q||V)throw"restore_allstate: glkapi module has already been launched";for(let t=e.windows.length-1;t>=0;t--){const n=e.windows[t],i={type:n.type,rock:n.rock,disprock:n.disprock,style:n.style,hyperlink:n.hyperlink};r.class_register("window",i,i.disprock),i.prev=null,i.next=R,R=i,i.next&&(i.next.prev=i)}for(let t=e.streams.length-1;t>=0;t--){const n=e.streams[t],i={type:n.type,rock:n.rock,disprock:n.disprock,unicode:n.unicode,isbinary:n.isbinary,readcount:n.readcount,writecount:n.writecount,readable:n.readable,writable:n.writable,streaming:n.streaming};r.class_register("stream",i,i.disprock),i.prev=null,i.next=Q,Q=i,i.next&&(i.next.prev=i)}for(let t=e.filerefs.length-1;t>=0;t--){const n=e.filerefs[t],i={type:n.type,rock:n.rock,disprock:n.disprock,filename:n.filename,textmode:n.textmode,filetype:n.filetype,filetypename:n.filetypename};r.class_register("fileref",i,i.disprock),i.prev=null,i.next=V,V=i,i.next&&(i.next.prev=i)}for(let t=0;t<e.windows.length;t++){const n=e.windows[t],o=r.class_obj_from_id("window",n.disprock);switch(o.parent=r.class_obj_from_id("window",n.parent),o.str=r.class_obj_from_id("stream",n.str),o.echostr=r.class_obj_from_id("stream",n.echostr),o.bbox={left:n.bbox.left,right:n.bbox.right,top:n.bbox.top,bottom:n.bbox.bottom},o.input_generation=null,(n.char_request||n.line_request)&&(o.input_generation=_),o.linebuf=null,void 0!==n.linebuf&&(o.linebuf=n.linebuf.arr,r.retain_array(o.linebuf,n.linebuf)),o.char_request=n.char_request,o.line_request=n.line_request,o.char_request_uni=n.char_request_uni,o.line_request_uni=n.line_request_uni,o.hyperlink_request=n.hyperlink_request,o.mouse_request=n.mouse_request,o.echo_line_input=n.echo_line_input,o.request_echo_line_input=n.request_echo_line_input,o.line_input_terminators=n.line_input_terminators.slice(0),o.type){case b.wintype_TextBuffer:o.accum=[],o.accumstyle=o.style,o.accumhyperlink=o.hyperlink,o.accum_fg=o.fg,o.accum_bg=o.bg,o.accum_reverse=o.reverse,o.content=n.reserve.slice(0),o.clearcontent=!1,o.reserve=[];break;case b.wintype_TextGrid:o.gridwidth=n.gridwidth,o.gridheight=n.gridheight,o.lines=[];for(var i=0;i<n.lines.length;i++){var s=n.lines[i];o.lines.push({dirty:!0,chars:s.chars.slice(0),styles:s.styles.slice(0),hyperlinks:s.hyperlinks.slice(0),fgs:s.fgs.slice(0),bgs:s.bgs.slice(0),reverses:s.reverses.slice(0)})}o.cursorx=n.cursorx,o.cursory=n.cursory;break;case b.wintype_Graphics:o.graphwidth=n.graphwidth,o.graphheight=n.graphheight,o.content=n.reserve.slice(0),o.reserve=[];break;case b.wintype_Pair:o.pair_dir=n.pair_dir,o.pair_division=n.pair_division,o.pair_key=r.class_obj_from_id("window",n.pair_key),o.pair_keydamage=!1,o.pair_size=n.pair_size,o.pair_hasborder=n.pair_hasborder,o.pair_vertical=n.pair_vertical,o.pair_backward=n.pair_backward,o.child1=r.class_obj_from_id("window",n.child1),o.child2=r.class_obj_from_id("window",n.child2)}}for(let i=0;i<e.streams.length;i++){const s=e.streams[i],u=r.class_obj_from_id("stream",s.disprock);switch(u.win=null,u.ref=null,u.file=null,u.buf=null,u.bufpos=0,u.buflen=0,u.bufeof=0,u.timer_id=null,u.flush_func=null,u.fstream=null,u.type){case I:u.win=r.class_obj_from_id("window",s.win);break;case N:void 0!==s.buf&&(u.buf=s.buf.arr,r.retain_array(u.buf,s.buf)),u.buflen=s.buflen,u.bufpos=s.bufpos,u.bufeof=s.bufeof;break;case E:u.resfilenum=s.resfilenum;var o=n.find_data_chunk(u.resfilenum);o&&(u.buf=o.data),u.buflen=s.buflen,u.bufpos=s.bufpos,u.bufeof=s.bufeof;break;case L:if(u.origfmode=s.origfmode,t.streaming){if(u.ref=s.ref,u.fstream=t.file_fopen(u.origfmode,u.ref),!u.fstream){var a=t.file_construct_temp_ref(u.ref.usage);if(u.fstream=t.file_fopen(u.origfmode,a),!u.fstream)throw"restore_allstate: could not reopen even a temp stream for: "+u.ref.filename}u.origfmode!=b.filemode_WriteAppend&&u.fstream.fseek(s.filepos,b.seekmode_Start),u.buffer4=u.fstream.BufferClass.alloc(4)}else{u.ref=s.ref,u.buflen=s.buflen,u.bufpos=s.bufpos,u.bufeof=s.bufeof;var l=t.file_read(u.ref);null==l&&(l=[],t.file_write(u.ref,"",!0)),u.buf=l,u.bufeof=l.length,u.bufpos>u.bufeof&&(u.bufpos=u.bufeof)}}}for(let t=0;t<e.filerefs.length;t++){const n=e.filerefs[t];r.class_obj_from_id("fileref",n.disprock).ref=n.ref}W=r.class_obj_from_id("window",e.rootwin),H=r.class_obj_from_id("stream",e.currentstr),e.timer_interval&&Me(e.timer_interval),B=e.glkote},fatal_error:function(e){c=!0,d=!0,i.error(e);var t={type:"update",gen:_,disable:!0,input:[]};i.update(t)},byte_array_to_string:q,uni_array_to_string:A,Const:b,RefBox:function(){this.value=void 0,this.set_value=function(e){this.value=e},this.get_value=function(){return this.value}},RefStruct:function(){this.fields=[],this.push_field=function(e){this.fields.push(e)},this.set_field=function(e,t){this.fields[e]=t},this.get_field=function(e){return this.fields[e]},this.get_fields=function(){return this.fields}},DidNotReturn:$,call_may_not_return:function(e){return 1==e||192==e||98==e},glk_put_jstring:function(e,t){ve(H,e,t)},glk_put_jstring_stream:ve,glk_exit:function(){return c=!0,d=!0,Y=null,o&&i.warning(o),$},glk_tick:function(){},glk_gestalt:function(e,t){return ye(e,t,null)},glk_gestalt_ext:ye,glk_window_iterate:function(e,t){return(e=e?e.next:R)?(t&&t.set_value(e.rock),e):(t&&t.set_value(0),null)},glk_window_get_rock:function(e){if(!e)throw"glk_window_get_rock: invalid window";return e.rock},glk_window_get_root:function(){return W},glk_window_open:function(e,t,r,n,i){var o,a,l,u,f;if(W){if(!e)throw"glk_window_open: splitwin must not be null";if((l=t&b.winmethod_DivisionMask)!=b.winmethod_Fixed&&l!=b.winmethod_Proportional)throw"glk_window_open: invalid method (not fixed or proportional)";if((l=t&b.winmethod_DirMask)!=b.winmethod_Above&&l!=b.winmethod_Below&&l!=b.winmethod_Left&&l!=b.winmethod_Right)throw"glk_window_open: invalid method (bad direction)";if(a=e.bbox,(o=e.parent)&&o.type!=b.wintype_Pair)throw"glk_window_open: parent window is not Pair"}else{if(e)throw"glk_window_open: splitwin must be null for first window";o=null,a={left:P.outspacingx,top:P.outspacingy,right:P.width-P.outspacingx,bottom:P.height-P.outspacingy}}switch((f=ee(n,i)).type){case b.wintype_TextBuffer:f.accum=[],f.accumstyle=null,f.accumhyperlink=0,f.accum_fg=null,f.accum_bg=null,f.accum_reverse=null,f.content=[],f.clearcontent=!1,f.reserve=[],f.stylehints=[];for(let e=0;e<b.style_NUMSTYLES;e++)f.stylehints.push(Object.assign({},xe.buffer[e]));break;case b.wintype_TextGrid:f.gridwidth=0,f.gridheight=0,f.lines=[],f.cursorx=0,f.cursory=0,f.stylehints=[];for(let e=0;e<b.style_NUMSTYLES;e++)f.stylehints.push(Object.assign({},xe.grid[e]));break;case b.wintype_Graphics:if(!s.graphics)return te(f),null;f.content=[],f.reserve=[];break;case b.wintype_Blank:break;case b.wintype_Pair:throw"glk_window_open: cannot open pair window directly";default:return te(f),null}return e?((u=ee(b.wintype_Pair,0)).pair_dir=t&b.winmethod_DirMask,u.pair_division=t&b.winmethod_DivisionMask,u.pair_key=f,u.pair_keydamage=!1,u.pair_size=r,u.pair_hasborder=(t&b.winmethod_BorderMask)==b.winmethod_Border,u.pair_vertical=u.pair_dir==b.winmethod_Left||u.pair_dir==b.winmethod_Right,u.pair_backward=u.pair_dir==b.winmethod_Left||u.pair_dir==b.winmethod_Above,u.child1=e,u.child2=f,e.parent=u,f.parent=u,u.parent=o,o?o.child1==e?o.child1=u:o.child2=u:W=u,ae(u,a)):(W=f,ae(f,a)),f},glk_window_close:function(e,t){if(!e)throw"glk_window_close: invalid window";if(e!==W&&e.parent){var r,n,i,s,o,a;if(e===(r=e.parent).child1)i=r.child2;else{if(e!==r.child2)throw"glk_window_close: window tree is corrupted";i=r.child1}for(s=r.bbox,(n=r.parent)?(n.child1===r?n.child1=i:n.child2=i,i.parent=n):(W=i,i.parent=null),we(e.str,t),oe(e,!0),e===r.child1?r.child1=null:e===r.child2&&(r.child2=null),oe(r,!1),a=!1,o=i;o;o=o.parent)o.type==b.wintype_Pair&&o.pair_keydamage&&(a=!0,o.pair_keydamage=!1);ae(a?W:i,s)}else W=null,we(e.str,t),oe(e,!0)},glk_window_get_size:function(e,t,r){if(!e)throw"glk_window_get_size: invalid window";var n,i,s=0,o=0;switch(e.type){case b.wintype_TextGrid:n=e.bbox.right-e.bbox.left,i=e.bbox.bottom-e.bbox.top,s=Math.max(0,Math.floor((n-P.gridmarginx)/P.gridcharwidth)),o=Math.max(0,Math.floor((i-P.gridmarginy)/P.gridcharheight));break;case b.wintype_TextBuffer:n=e.bbox.right-e.bbox.left,i=e.bbox.bottom-e.bbox.top,s=Math.max(0,Math.floor((n-P.buffermarginx)/P.buffercharwidth)),o=Math.max(0,Math.floor((i-P.buffermarginy)/P.buffercharheight));break;case b.wintype_Graphics:n=e.bbox.right-e.bbox.left,i=e.bbox.bottom-e.bbox.top,s=n-P.graphicsmarginx,o=i-P.graphicsmarginy}t&&t.set_value(s),r&&r.set_value(o)},glk_window_set_arrangement:function(e,t,r,n){var i,s,o,a;if(!e)throw"glk_window_set_arrangement: invalid window";if(e.type!=b.wintype_Pair)throw"glk_window_set_arrangement: not a pair window";if(n){if(n.type==b.wintype_Pair)throw"glk_window_set_arrangement: keywin cannot be a pair window";for(i=n;i&&i!=e;i=i.parent);if(!i)throw"glk_window_set_arrangement: keywin must be a descendant"}if(o=(s=t&b.winmethod_DirMask)==b.winmethod_Left||s==b.winmethod_Right,a=s==b.winmethod_Left||s==b.winmethod_Above,n||(n=e.pair_key),o&&!e.pair_vertical)throw"glk_window_set_arrangement: split must stay horizontal";if(!o&&e.pair_vertical)throw"glk_window_set_arrangement: split must stay vertical";if(n&&n.type==b.wintype_Blank&&(t&b.winmethod_DivisionMask)==b.winmethod_Fixed)throw"glk_window_set_arrangement: a blank window cannot have a fixed size";(a&&!e.pair_backward||!a&&e.pair_backward)&&(i=e.child1,e.child1=e.child2,e.child2=i),e.pair_dir=s,e.pair_division=t&b.winmethod_DivisionMask,e.pair_key=n,e.pair_size=r,e.pair_hasborder=(t&b.winmethod_BorderMask)==b.winmethod_Border,e.pair_vertical=e.pair_dir==b.winmethod_Left||e.pair_dir==b.winmethod_Right,e.pair_backward=e.pair_dir==b.winmethod_Left||e.pair_dir==b.winmethod_Above,ae(e,e.bbox)},glk_window_get_arrangement:function(e,t,r,n){if(!e)throw"glk_window_get_arrangement: invalid window";if(e.type!=b.wintype_Pair)throw"glk_window_get_arrangement: not a pair window";r&&r.set_value(e.pair_size),n&&n.set_value(e.pair_key),t&&t.set_value(e.pair_dir|e.pair_division|(e.pair_hasborder?b.winmethod_Border:b.winmethod_NoBorder))},glk_window_get_type:function(e){if(!e)throw"glk_window_get_type: invalid window";return e.type},glk_window_get_parent:function(e){if(!e)throw"glk_window_get_parent: invalid window";return e.parent},glk_window_clear:function(e){if(!e)throw"glk_window_clear: invalid window";if(e.line_request)throw"glk_window_clear: window has pending line request";let t=null;switch(e.type){case b.wintype_TextBuffer:e.accum.length=0,e.accumstyle=null,e.accumhyperlink=0,e.accum_fg=null,e.accum_bg=null,e.accum_reverse=null,e.content.length=0,e.clearcontent=!0;break;case b.wintype_TextGrid:e.cursorx=0,e.cursory=0;for(let t=0;t<e.gridheight;t++){const r=e.lines[t];r.dirty=!0;for(let t=0;t<e.gridwidth;t++)r.chars[t]=" ",r.styles[t]=b.style_Normal,r.hyperlinks[t]=0,r.fgs[t]=e.fg,r.bgs[t]=e.bg,r.reverses[t]=e.reverse}break;case b.wintype_Graphics:for(let r=0;r<e.content.length;r++)"setcolor"==e.content[r].special&&(t=e.content[r]);e.content.length=0,null!==t&&e.content.push(t),e.content.push({special:"fill"})}},glk_window_move_cursor:function(e,t,r){if(!e)throw"glk_window_move_cursor: invalid window";if(e.type!=b.wintype_TextGrid)throw"glk_window_move_cursor: not a grid window";e.cursorx=t,e.cursory=r},glk_window_get_stream:function(e){if(!e)throw"glk_window_get_stream: invalid window";return e.str},glk_window_set_echo_stream:function(e,t){if(!e)throw"glk_window_set_echo_stream: invalid window";e.echostr=t},glk_window_get_echo_stream:function(e){if(!e)throw"glk_window_get_echo_stream: invalid window";return e.echostr},glk_set_window:function(e){H=e?e.str:null},glk_window_get_sibling:function(e){if(!e)throw"glk_window_get_sibling: invalid window";const t=e.parent;if(!t)return null;if(e===t.child1)return t.child2;if(e===t.child2)return t.child1;throw"glk_window_get_sibling: window tree is corrupted"},glk_stream_iterate:function(e,t){return(e=e?e.next:Q)?(t&&t.set_value(e.rock),e):(t&&t.set_value(0),null)},glk_stream_get_rock:function(e){if(!e)throw"glk_stream_get_rock: invalid stream";return e.rock},glk_stream_open_file:function(e,r,n){if(!e)throw"glk_stream_open_file: invalid fileref";var i,s;if(r!=b.filemode_Read&&r!=b.filemode_Write&&r!=b.filemode_ReadWrite&&r!=b.filemode_WriteAppend)throw"glk_stream_open_file: illegal filemode";if(r==b.filemode_Read&&!t.file_ref_exists(e.ref))return null;if(t.streaming){if(!(s=t.file_fopen(r,e.ref)))return null}else{var o=null;if(r!=b.filemode_Write&&(o=t.file_read(e.ref)),null==o&&(o=[],r!=b.filemode_Read&&t.file_write(e.ref,"",!0)),null==o.length)throw"glk_stream_open_file: data read had no length"}return(i=le(L,r!=b.filemode_Write,r!=b.filemode_Read,n)).unicode=!1,i.isbinary=!e.textmode,i.ref=e.ref,i.origfmode=r,t.streaming?(i.streaming=!0,i.fstream=s,i.buffer4=s.BufferClass.alloc(4)):(i.streaming=!1,i.buf=o,i.buflen=4294967295,r==b.filemode_Write?i.bufeof=0:i.bufeof=o.length,r==b.filemode_WriteAppend?i.bufpos=i.bufeof:i.bufpos=0),i},glk_stream_open_memory:function(e,t,n){var i;if(t!=b.filemode_Read&&t!=b.filemode_Write&&t!=b.filemode_ReadWrite)throw"glk_stream_open_memory: illegal filemode";return(i=le(N,t!=b.filemode_Write,t!=b.filemode_Read,n)).unicode=!1,e&&(i.buf=e,i.buflen=e.length,i.bufpos=0,t==b.filemode_Write?i.bufeof=0:i.bufeof=i.buflen,r&&r.retain_array(e)),i},glk_stream_close:function(e,r){if(!e)throw"glk_stream_close: invalid stream";if(e.type==I)throw"glk_stream_close: cannot close window stream";e.type==L&&e.writable&&(e.streaming||(null!==e.timer_id&&(clearTimeout(e.timer_id),e.timer_id=null),t.file_write(e.ref,e.buf))),we(e,r),ue(e)},glk_stream_set_position:function(e,t,r){if(!e)throw"glk_stream_set_position: invalid stream";switch(e.type){case L:if(e.streaming){e.fstream.fseek(t,r);break}case E:case N:r==b.seekmode_Current?t=e.bufpos+t:r==b.seekmode_End&&(t=e.bufeof+t),t<0&&(t=0),t>e.bufeof&&(t=e.bufeof),e.bufpos=t}},glk_stream_get_position:function(e){if(!e)throw"glk_stream_get_position: invalid stream";switch(e.type){case L:if(e.streaming)return e.fstream.ftell();case E:case N:return e.bufpos;default:return 0}},glk_stream_set_current:function(e){H=e},glk_stream_get_current:function(){return H},glk_fileref_create_temp:function(e,r){var n=e&b.fileusage_TypeMask,i=U[n],s=t.file_construct_temp_ref(i);return de(s.filename,e,r,s)},glk_fileref_create_by_name:function(e,r,n){return de(r=t.file_clean_fixed_name(r,e&b.fileusage_TypeMask),e,n,null)},glk_fileref_create_by_prompt:function(t,r,n){var i,s=t&b.fileusage_TypeMask,o=U[s];switch(o||(o="xxx"),r){case b.filemode_Write:i="write";break;case b.filemode_ReadWrite:i="readwrite";break;case b.filemode_WriteAppend:i="writeappend";break;case b.filemode_Read:default:i="read"}var a={type:"fileref_prompt",filetype:o,filemode:i},l={usage:t,rock:n};return s==b.fileusage_SavedGame&&(a.gameid=e.get_signature()),h=a,p=l,Y=null,$},glk_fileref_destroy:function(e){if(!e)throw"glk_fileref_destroy: invalid fileref";!function(e){var t,n;r&&r.class_unregister("fileref",e),t=e.prev,n=e.next,e.prev=null,e.next=null,t?t.next=n:V=n,n&&(n.prev=t),e.filename=null,e.ref=null,e.rock=null,e.disprock=null}(e)},glk_fileref_iterate:function(e,t){return(e=e?e.next:V)?(t&&t.set_value(e.rock),e):(t&&t.set_value(0),null)},glk_fileref_get_rock:function(e){if(!e)throw"glk_fileref_get_rock: invalid fileref";return e.rock},glk_fileref_delete_file:function(e){if(!e)throw"glk_fileref_delete_file: invalid fileref";t.file_remove_ref(e.ref)},glk_fileref_does_file_exist:function(e){if(!e)throw"glk_fileref_does_file_exist: invalid fileref";return t.file_ref_exists(e.ref)?1:0},glk_fileref_create_from_fileref:function(e,t,r){if(!t)throw"glk_fileref_create_from_fileref: invalid fileref";return de(t.filename,e,r,null)},glk_put_char:function(e){he(H,255&e)},glk_put_char_stream:function(e,t){he(e,255&t)},glk_put_string:function(e){ve(H,e,!0)},glk_put_string_stream:function(e,t){ve(e,t,!0)},glk_put_buffer:function(e){e=z(e),pe(H,e,!0)},glk_put_buffer_stream:function(e,t){pe(e,t=z(t),!0)},glk_set_style:function(e){be(H,e)},glk_set_style_stream:function(e,t){be(e,t)},glk_get_char_stream:function(e){if(!e)throw"glk_get_char_stream: invalid stream";return _e(e,!1)},glk_get_line_stream:function(e,t){if(!e)throw"glk_get_line_stream: invalid stream";return ge(e,t,!1)},glk_get_buffer_stream:function(e,t){if(!e)throw"glk_get_buffer_stream: invalid stream";return me(e,t,!1)},glk_char_to_lower:function(e){return e>=65&&e<=90||e>=192&&e<=222&&215!=e?e+32:e},glk_char_to_upper:function(e){return e>=97&&e<=122||e>=224&&e<=254&&247!=e?e-32:e},glk_stylehint_set:function(e,t,r,n){var i;r===b.stylehint_Indentation&&(i=n+"em"),r===b.stylehint_ParaIndentation&&(i=n+"em"),r===b.stylehint_Justification&&(i=["left","justify","center","right"][n]),r===b.stylehint_Size&&(i=1+.1*n+"em"),r===b.stylehint_Weight&&(i=["lighter","normal","bold"][n+1]),r===b.stylehint_Oblique&&(i=n?"italic":"normal"),r===b.stylehint_Proportional&&(i=n?"var(--glkote-prop-family)":"var(--glkote-mono-family)"),r===b.stylehint_TextColor&&(i="#"+("000000"+n.toString(16)).slice(-6)),r===b.stylehint_BackColor&&(i="#"+("000000"+n.toString(16)).slice(-6)),r===b.stylehint_ReverseColor&&(i=n),e!==b.wintype_AllTypes&&e!==b.wintype_TextBuffer||(xe.buffer[t][Ue[r]]=i),e!==b.wintype_AllTypes&&e!==b.wintype_TextGrid||(xe.grid[t][Ue[r]]=i)},glk_stylehint_clear:function(e,t,r){e!==b.wintype_AllTypes&&e!==b.wintype_TextBuffer||delete xe.buffer[t][Ue[r]],e!==b.wintype_AllTypes&&e!==b.wintype_TextGrid||delete xe.grid[t][Ue[r]]},glk_style_distinguish:function(){return 0},glk_style_measure:function(e,t,r,n){return n&&n.set_value(0),0},glk_select:function(e){return Y=e,$},glk_select_poll:function(e){e.set_field(0,b.evtype_None),e.set_field(1,null),e.set_field(2,0),e.set_field(3,0),J&&Date.now()-X>J&&(X=Date.now(),K=null,e.set_field(0,b.evtype_Timer))},glk_request_line_event:function(e,t,n){if(!e)throw"glk_request_line_event: invalid window";if(e.char_request||e.line_request)throw"glk_request_line_event: window already has keyboard request";if(e.type!=b.wintype_TextBuffer&&e.type!=b.wintype_TextGrid)throw"glk_request_line_event: window does not support keyboard input";if(n){var i=t.slice(0,n);m||(m={}),m[e.disprock]=q(i)}e.line_request=!0,e.line_request_uni=!1,e.type==b.wintype_TextBuffer?e.request_echo_line_input=e.echo_line_input:e.request_echo_line_input=!0,e.input_generation=_,e.linebuf=t,r&&r.retain_array(t)},glk_cancel_line_event:function(e,t){if(!e)throw"glk_cancel_line_event: invalid window";if(e.line_request){var n,i,s="";for(g&&(i=g[e.disprock])&&(s=i),s.length>e.linebuf.length&&(s=s.slice(0,e.linebuf.length)),e.request_echo_line_input&&(n=e.style,be(e.str,b.style_Input),re(e,s),e.echostr&&ve(e.echostr,s),be(e.str,n),re(e,"\n"),e.echostr&&ve(e.echostr,"\n")),n=0;n<s.length;n++)e.linebuf[n]=s.charCodeAt(n);t&&(t.set_field(0,b.evtype_LineInput),t.set_field(1,e),t.set_field(2,s.length),t.set_field(3,0)),r&&r.unretain_array(e.linebuf),e.line_request=!1,e.line_request_uni=!1,e.request_echo_line_input=null,e.input_generation=null,e.linebuf=null}else t&&(t.set_field(0,b.evtype_None),t.set_field(1,null),t.set_field(2,0),t.set_field(3,0))},glk_request_char_event:function(e){if(!e)throw"glk_request_char_event: invalid window";if(e.char_request||e.line_request)throw"glk_request_char_event: window already has keyboard request";if(e.type!=b.wintype_TextBuffer&&e.type!=b.wintype_TextGrid)throw"glk_request_char_event: window does not support keyboard input";e.char_request=!0,e.char_request_uni=!1,e.input_generation=_},glk_cancel_char_event:function(e){if(!e)throw"glk_cancel_char_event: invalid window";e.char_request=!1,e.char_request_uni=!1},glk_request_mouse_event:function(e){if(!e)throw"glk_request_mouse_event: invalid window";e.type!=b.wintype_TextGrid&&e.type!=b.wintype_Graphics||(e.mouse_request=!0)},glk_cancel_mouse_event:function(e){if(!e)throw"glk_cancel_mouse_event: invalid window";e.mouse_request=!1},glk_request_timer_events:Me,glk_image_get_info:function(e,t,r){if(!n||!n.get_image_info)return null;var i=n.get_image_info(e);return i?(t&&t.set_value(i.width),r&&r.set_value(i.height),1):(t&&t.set_value(0),r&&r.set_value(0),0)},glk_image_draw:function(e,t,r,i){if(!e)throw"glk_image_draw: invalid window";if(!n||!n.get_image_info)return 0;var s=n.get_image_info(t);if(!s)return 0;var o={special:"image",image:t,url:s.url,alttext:s.alttext,width:s.width,height:s.height};switch(e.type){case b.wintype_TextBuffer:var a="inlineup";switch(r){case b.imagealign_InlineUp:a="inlineup";break;case b.imagealign_InlineDown:a="inlinedown";break;case b.imagealign_InlineCenter:a="inlinecenter";break;case b.imagealign_MarginLeft:a="marginleft";break;case b.imagealign_MarginRight:a="marginright"}return o.alignment=a,e.hyperlink&&(o.hyperlink=e.hyperlink),se(e,o),1;case b.wintype_Graphics:return o.x=r,o.y=i,e.content.push(o),1}return 0},glk_image_draw_scaled:function(e,t,r,i,s,o){if(!e)throw"glk_image_draw_scaled: invalid window";if(!n||!n.get_image_info)return 0;var a=n.get_image_info(t);if(!a)return 0;var l={special:"image",image:t,url:a.url,alttext:a.alttext,width:s,height:o};switch(e.type){case b.wintype_TextBuffer:var u="inlineup";switch(r){case b.imagealign_InlineUp:u="inlineup";break;case b.imagealign_InlineDown:u="inlinedown";break;case b.imagealign_InlineCenter:u="inlinecenter";break;case b.imagealign_MarginLeft:u="marginleft";break;case b.imagealign_MarginRight:u="marginright"}return l.alignment=u,e.hyperlink&&(l.hyperlink=e.hyperlink),se(e,l),1;case b.wintype_Graphics:return l.x=r,l.y=i,e.content.push(l),1}return 0},glk_window_flow_break:function(e){if(!e)throw"glk_window_flow_break: invalid window";e.type==b.wintype_TextBuffer&&se(e,void 0,!0)},glk_window_erase_rect:function(e,t,r,n,i){if(!e)throw"glk_window_erase_rect: invalid window";if(e.type!=b.wintype_Graphics)throw"glk_window_erase_rect: not a graphics window";e.content.push({special:"fill",x:t,y:r,width:n,height:i})},glk_window_fill_rect:function(e,t,r,n,i,s){if(!e)throw"glk_window_fill_rect: invalid window";if(e.type!=b.wintype_Graphics)throw"glk_window_fill_rect: not a graphics window";var o=je(t);e.content.push({special:"fill",color:o,x:r,y:n,width:i,height:s})},glk_window_set_background_color:function(e,t){if(!e)throw"glk_window_set_background_color: invalid window";if(e.type!=b.wintype_Graphics)throw"glk_window_set_background_color: not a graphics window";var r=je(t);e.content.push({special:"setcolor",color:r})},glk_schannel_iterate:function(e,t){return(e=e?e.next:null)?(t&&t.set_value(e.rock),e):(t&&t.set_value(0),null)},glk_schannel_get_rock:function(e){if(!e)throw"glk_schannel_get_rock: invalid schannel";return e.rock},glk_schannel_create:function(){return null},glk_schannel_destroy:function(){throw"glk_schannel_destroy: invalid schannel"},glk_schannel_play:function(){throw"glk_schannel_play: invalid schannel"},glk_schannel_play_ext:function(){throw"glk_schannel_play_ext: invalid schannel"},glk_schannel_stop:function(){throw"glk_schannel_stop: invalid schannel"},glk_schannel_set_volume:function(){throw"glk_schannel_set_volume: invalid schannel"},glk_schannel_create_ext:function(){return null},glk_schannel_play_multi:function(){throw"glk_schannel_play_multi: invalid schannel"},glk_schannel_pause:function(){throw"glk_schannel_pause: invalid schannel"},glk_schannel_unpause:function(){throw"glk_schannel_unpause: invalid schannel"},glk_schannel_set_volume_ext:function(){throw"glk_schannel_set_volume_ext: invalid schannel"},glk_sound_load_hint:function(){},glk_set_hyperlink:function(e){ke(H,e)},glk_set_hyperlink_stream:function(e,t){ke(e,t)},glk_request_hyperlink_event:function(e){if(!e)throw"glk_request_hyperlink_event: invalid window";e.type!=b.wintype_TextBuffer&&e.type!=b.wintype_TextGrid||(e.hyperlink_request=!0)},glk_cancel_hyperlink_event:function(e){if(!e)throw"glk_cancel_hyperlink_event: invalid window";e.type!=b.wintype_TextBuffer&&e.type!=b.wintype_TextGrid||(e.hyperlink_request=!1)},glk_buffer_to_lower_case_uni:function(e,t){var r,n,i,s,o,a=e.length,l=e.slice(0,t);if(a<t)throw"buffer_to_lower_case_uni: numchars exceeds array length";for(i=0,r=0;r<t;r++)if(o=l[r],void 0===(s=S[o]))e[i]=o,i++;else if(s instanceof Array)for(n=0;n<s.length;n++)e[i]=s[n],i++;else e[i]=s,i++;return e.length=a,i},glk_buffer_to_upper_case_uni:function(e,t){var r,n,i,s,o,a=e.length,l=e.slice(0,t);if(a<t)throw"buffer_to_upper_case_uni: numchars exceeds array length";for(i=0,r=0;r<t;r++)if(o=l[r],void 0===(s=C[o]))e[i]=o,i++;else if(s instanceof Array)for(n=0;n<s.length;n++)e[i]=s[n],i++;else e[i]=s,i++;return e.length=a,i},glk_buffer_to_title_case_uni:function(e,t,r){var n,i,s,o,a,l=e.length,u=e.slice(0,t);if(l<t)throw"buffer_to_title_case_uni: numchars exceeds array length";if(s=0,0==t)return 0;if(a=u[n=0],void 0===(o=M[a])&&(o=C[a]),void 0===o)e[s]=a,s++;else if(o instanceof Array)for(i=0;i<o.length;i++)e[s]=o[i],s++;else e[s]=o,s++;if(r)for(n=1;n<t;n++)if(a=u[n],void 0===(o=S[a]))e[s]=a,s++;else if(o instanceof Array)for(i=0;i<o.length;i++)e[s]=o[i],s++;else e[s]=o,s++;else for(n=1;n<t;n++)a=u[n],e[s]=a,s++;return e.length=l,s},glk_buffer_canon_decompose_uni:function(e,t){var r,n=e.length;return r=Ge(e,t),e.length=n,r},glk_buffer_canon_normalize_uni:function(e,t){var r,n=e.length;return r=function(e,t){var r,n,i,s,o,a,l,u;if(0==t)return 0;for(u=0,i=e[0],(o=G[i])&&(o=999),n=r=1;;){if(n>=t){e[u]=i,u=r;break}s=e[n],a=G[s],void 0!==(l=T[i])&&void 0!==l[s]&&(!o||a&&o<a)?(i=l[s],e[u]=i):(a||(u=r,i=s),o=a,e[r]=s,r++),n++}return u}(e,r=Ge(e,t)),e.length=n,r},glk_put_char_uni:function(e){he(H,e)},glk_put_string_uni:function(e){ve(H,e,!1)},glk_put_buffer_uni:function(e){pe(H,e,!1)},glk_put_char_stream_uni:function(e,t){he(e,t)},glk_put_string_stream_uni:function(e,t){ve(e,t,!1)},glk_put_buffer_stream_uni:function(e,t){pe(e,t,!1)},glk_get_char_stream_uni:function(e){if(!e)throw"glk_get_char_stream_uni: invalid stream";return _e(e,!0)},glk_get_buffer_stream_uni:function(e,t){if(!e)throw"glk_get_buffer_stream_uni: invalid stream";return me(e,t,!0)},glk_get_line_stream_uni:function(e,t){if(!e)throw"glk_get_line_stream_uni: invalid stream";return ge(e,t,!0)},glk_stream_open_file_uni:function(e,r,n){if(!e)throw"glk_stream_open_file_uni: invalid fileref";var i,s;if(r!=b.filemode_Read&&r!=b.filemode_Write&&r!=b.filemode_ReadWrite&&r!=b.filemode_WriteAppend)throw"glk_stream_open_file_uni: illegal filemode";if(r==b.filemode_Read&&!t.file_ref_exists(e.ref))return null;if(t.streaming){if(!(s=t.file_fopen(r,e.ref)))return null}else{var o=null;if(r!=b.filemode_Write&&(o=t.file_read(e.ref)),null==o&&(o=[],r!=b.filemode_Read&&t.file_write(e.ref,"",!0)),null==o.length)throw"glk_stream_open_file_uni: data read had no length"}return(i=le(L,r!=b.filemode_Write,r!=b.filemode_Read,n)).unicode=!0,i.isbinary=!e.textmode,i.ref=e.ref,i.origfmode=r,t.streaming?(i.streaming=!0,i.fstream=s,i.buffer4=s.BufferClass.alloc(4)):(i.streaming=!1,i.buf=o,i.buflen=4294967295,r==b.filemode_Write?i.bufeof=0:i.bufeof=o.length,r==b.filemode_WriteAppend?i.bufpos=i.bufeof:i.bufpos=0),i},glk_stream_open_memory_uni:function(e,t,n){var i;if(t!=b.filemode_Read&&t!=b.filemode_Write&&t!=b.filemode_ReadWrite)throw"glk_stream_open_memory: illegal filemode";return(i=le(N,t!=b.filemode_Write,t!=b.filemode_Read,n)).unicode=!0,e&&(i.buf=e,i.buflen=e.length,i.bufpos=0,t==b.filemode_Write?i.bufeof=0:i.bufeof=i.buflen,r&&r.retain_array(e)),i},glk_request_char_event_uni:function(e){if(!e)throw"glk_request_char_event: invalid window";if(e.char_request||e.line_request)throw"glk_request_char_event: window already has keyboard request";if(e.type!=b.wintype_TextBuffer&&e.type!=b.wintype_TextGrid)throw"glk_request_char_event: window does not support keyboard input";e.char_request=!0,e.char_request_uni=!0,e.input_generation=_},glk_request_line_event_uni:function(e,t,n){if(!e)throw"glk_request_line_event: invalid window";if(e.char_request||e.line_request)throw"glk_request_line_event: window already has keyboard request";if(e.type!=b.wintype_TextBuffer&&e.type!=b.wintype_TextGrid)throw"glk_request_line_event: window does not support keyboard input";if(n){var i=t.slice(0,n);m||(m={}),m[e.disprock]=A(i)}e.line_request=!0,e.line_request_uni=!0,e.type==b.wintype_TextBuffer?e.request_echo_line_input=e.echo_line_input:e.request_echo_line_input=!0,e.input_generation=_,e.linebuf=t,r&&r.retain_array(t)},glk_set_echo_line_event:function(e,t){if(!e)throw"glk_set_echo_line_event: invalid window";e.echo_line_input=0!=t},glk_set_terminators_line_event:function(e,t){if(!e)throw"glk_set_terminators_line_event: invalid window";if(null===y){y={};for(let e in k)y[k[e]]=e}const r=[];if(t)for(let e=0;e<t.length;e++){const n=y[t[e]];n&&r.push(n)}e.line_input_terminators=r},glk_current_time:function(e){var t,r=(new Date).getTime();e.set_field(0,Math.floor(r/4294967296e3)),e.set_field(1,Math.floor(r/1e3)>>>0),(t=Math.floor(r%1e3*1e3))<0&&(t=1e6+t),e.set_field(2,t)},glk_current_simple_time:function(e){var t=(new Date).getTime();return Math.floor(t/(1e3*e))},glk_time_to_date_utc:function(e,t){var r=4294967296e3*e.get_field(0)+1e3*e.get_field(1)+e.get_field(2)/1e3,n=new Date(r);t.set_field(0,n.getUTCFullYear()),t.set_field(1,1+n.getUTCMonth()),t.set_field(2,n.getUTCDate()),t.set_field(3,n.getUTCDay()),t.set_field(4,n.getUTCHours()),t.set_field(5,n.getUTCMinutes()),t.set_field(6,n.getUTCSeconds()),t.set_field(7,1e3*n.getUTCMilliseconds())},glk_time_to_date_local:function(e,t){var r=4294967296e3*e.get_field(0)+1e3*e.get_field(1)+e.get_field(2)/1e3,n=new Date(r);t.set_field(0,n.getFullYear()),t.set_field(1,1+n.getMonth()),t.set_field(2,n.getDate()),t.set_field(3,n.getDay()),t.set_field(4,n.getHours()),t.set_field(5,n.getMinutes()),t.set_field(6,n.getSeconds()),t.set_field(7,1e3*n.getMilliseconds())},glk_simple_time_to_date_utc:function(e,t,r){var n=new Date(e*(1e3*t));r.set_field(0,n.getUTCFullYear()),r.set_field(1,1+n.getUTCMonth()),r.set_field(2,n.getUTCDate()),r.set_field(3,n.getUTCDay()),r.set_field(4,n.getUTCHours()),r.set_field(5,n.getUTCMinutes()),r.set_field(6,n.getUTCSeconds()),r.set_field(7,1e3*n.getUTCMilliseconds())},glk_simple_time_to_date_local:function(e,t,r){var n=new Date(e*(1e3*t));r.set_field(0,n.getFullYear()),r.set_field(1,1+n.getMonth()),r.set_field(2,n.getDate()),r.set_field(3,n.getDay()),r.set_field(4,n.getHours()),r.set_field(5,n.getMinutes()),r.set_field(6,n.getSeconds()),r.set_field(7,1e3*n.getMilliseconds())},glk_date_to_time_utc:function(e,t){var r=new Date(0);r.setUTCFullYear(e.get_field(0)),r.setUTCMonth(e.get_field(1)-1),r.setUTCDate(e.get_field(2)),r.setUTCHours(e.get_field(4)),r.setUTCMinutes(e.get_field(5)),r.setUTCSeconds(e.get_field(6)),r.setUTCMilliseconds(e.get_field(7)/1e3);var n,i=r.getTime();t.set_field(0,Math.floor(i/4294967296e3)),t.set_field(1,Math.floor(i/1e3)>>>0),(n=Math.floor(i%1e3*1e3))<0&&(n=1e6+n),t.set_field(2,n)},glk_date_to_time_local:function(e,t){var r,n=new Date(e.get_field(0),e.get_field(1)-1,e.get_field(2),e.get_field(4),e.get_field(5),e.get_field(6),e.get_field(7)/1e3).getTime();t.set_field(0,Math.floor(n/4294967296e3)),t.set_field(1,Math.floor(n/1e3)>>>0),(r=Math.floor(n%1e3*1e3))<0&&(r=1e6+r),t.set_field(2,r)},glk_date_to_simple_time_utc:function(e,t){var r=new Date(0);r.setUTCFullYear(e.get_field(0)),r.setUTCMonth(e.get_field(1)-1),r.setUTCDate(e.get_field(2)),r.setUTCHours(e.get_field(4)),r.setUTCMinutes(e.get_field(5)),r.setUTCSeconds(e.get_field(6)),r.setUTCMilliseconds(e.get_field(7)/1e3);var n=r.getTime();return Math.floor(n/(1e3*t))},glk_date_to_simple_time_local:function(e,t){var r=new Date(e.get_field(0),e.get_field(1)-1,e.get_field(2),e.get_field(4),e.get_field(5),e.get_field(6),e.get_field(7)/1e3).getTime();return Math.floor(r/(1e3*t))},glk_stream_open_resource:function(e,t){var r;if(!n||!n.find_data_chunk)return null;var i=n.find_data_chunk(e);if(!i)return null;var s=i.data,o="BINA"==i.type;return(r=le(E,!0,!1,t)).unicode=!1,r.isbinary=o,r.resfilenum=e,r.streaming=!1,s&&(r.buf=s,r.buflen=s.length,r.bufpos=0,r.bufeof=r.buflen),r},glk_stream_open_resource_uni:function(e,t){var r;if(!n||!n.find_data_chunk)return null;var i=n.find_data_chunk(e);if(!i)return null;var s=i.data,o="BINA"==i.type;return(r=le(E,!0,!1,t)).unicode=!0,r.isbinary=o,r.resfilenum=e,r.streaming=!1,s&&(r.buf=s,r.buflen=s.length,r.bufpos=0,r.bufeof=r.buflen),r},garglk_set_zcolors:function(e,t){Ce(H,e,t)},garglk_set_zcolors_stream:Ce,garglk_set_reversevideo:function(e){Se(H,e)},garglk_set_reversevideo_stream:Se}}(),s=function(){let e=null,t=null;var r=null,n=void 0,i="windowport",o="gameport",a=0,l=-1,u=!1,f=null,c=!1,d=null,h=null,p=null,_=0,g=0,m=0,w=[],v=null,b=null,k=null,y=null,x=!1,U=null,C=null,S=8,M=9,j=27,G=37,T=38,z=39,q=40,A=36,F=35,D=33,L=34,I={escape:j,func1:112,func2:113,func3:114,func4:115,func5:116,func6:117,func7:118,func8:119,func9:120,func10:121,func11:122,func12:123},N={},E=!1,B=null,R=null,W=null,O={},P={};const Q=["normal","emphasized","preformatted","header","subheader","alert","note","blockquote","input","user1","user2"],V={normal:0,emphasized:1,preformatted:2,header:3,subheader:4,alert:5,note:6,blockquote:7,input:8,user1:9,user2:10};function H(){var e,t,i,s,a,l={},u=$("#"+o,n);if(!u.length)return"Cannot find gameport element #"+o+" in this document.";$("#layouttestpane",n).remove(),l.width=u.width(),l.height=u.height(),l.width=u.width(),l.height=u.height();var f=$("<div>",{id:"layout_test_pane"});f.text("This should not be visible"),f.css({position:"absolute",visibility:"hidden",left:"-1000px"});var c=$("<div>");c.append($("<span>",{class:"Style_normal"}).text("12345678"));var d=$("<div>",{class:"WindowFrame GridWindow"}),h=c.clone().addClass("GridLine").appendTo(d),p=c.clone().addClass("GridLine").appendTo(d),_=h.children("span");f.append(d);var g=$("<div>",{class:"WindowFrame BufferWindow"}),m=c.clone().addClass("BufferLine").appendTo(g),w=c.clone().addClass("BufferLine").appendTo(g),v=m.children("span");f.append(g);var b=$("<div>",{class:"WindowFrame GraphicsWindow"}),k=$("<canvas>");k.attr("width",64),k.attr("height",32),b.append(k),f.append(b),u.append(f);var y=function(e){return{width:e.outerWidth(),height:e.outerHeight()}};return e=y(d),s=y(_),t=y(h),i=y(p),l.gridcharheight=p.position().top-h.position().top,l.gridcharwidth=_.width()/8,l.gridmarginx=e.width-s.width,l.gridmarginy=e.height-(t.height+i.height),e=y(g),s=y(v),t=y(m),i=y(w),l.buffercharheight=w.position().top-m.position().top,l.buffercharwidth=v.width()/8,l.buffermarginx=e.width-s.width,l.buffermarginy=e.height-(t.height+i.height),e=y(b),a=y(k),l.graphicsmarginx=e.width-a.width,l.graphicsmarginy=e.height-a.height,f.remove(),l.outspacingx=0,l.outspacingy=0,l.inspacingx=0,l.inspacingy=0,null!=r.spacing&&(l.outspacingx=r.spacing,l.outspacingy=r.spacing,l.inspacingx=r.spacing,l.inspacingy=r.spacing),null!=r.outspacing&&(l.outspacingx=r.outspacing,l.outspacingy=r.outspacing),null!=r.inspacing&&(l.inspacingx=r.inspacing,l.inspacingy=r.inspacing),null!=r.inspacingx&&(l.inspacingx=r.inspacingx),null!=r.inspacingy&&(l.inspacingy=r.inspacingy),null!=r.outspacingx&&(l.outspacingx=r.outspacingx),null!=r.outspacingy&&(l.outspacingy=r.outspacingy),l}function Y(e){var t,r;if(e){if(null==(r=d[e.id])){const a="window"+e.id;var s;r={id:e.id,type:e.type,rock:e.rock},d[e.id]=r,"grid"==r.type&&(s="GridWindow"),"buffer"==r.type&&(s="BufferWindow"),"graphics"==r.type&&(s="GraphicsWindow");var o="WindowRock_"+e.rock;(t=$("<div>",{id:a,class:"WindowFrame "+s+" "+o})).data("winid",e.id),t.on("mousedown",e.id,ve),"buffer"==r.type&&t.on("scroll",e.id,Me),"grid"!=r.type&&"graphics"!=r.type||t.on("click",r.id,be),"buffer"==r.type&&t.attr({"aria-live":"polite","aria-atomic":"false","aria-relevant":"additions"}),r.frameel=t,r.gridheight=0,r.gridwidth=0,r.input=null,r.inputel=null,r.terminators={},r.reqhyperlink=!1,r.reqmouse=!1,r.needscroll=!1,r.needspaging=!1,r.topunseen=0,r.pagefrommark=0,r.coords={left:null,top:null,right:null,bottom:null},r.history=new Array,r.historypos=0,e.stylehints&&(r.stylehints=e.stylehints,te(r,t)),$("#"+i,n).append(t)}else t=r.frameel,r.type!=e.type&&ne("Window "+e.id+" was created with type "+r.type+", but now is described as type "+e.type);if(r.inplace=!0,"grid"==r.type){if(e.gridheight>r.gridheight)for(let t=r.gridheight;t<e.gridheight;t++){const e=$("<div>",{id:"win"+r.id+"_ln"+t,class:"GridLine"});e.append(" "),r.frameel.append(e)}if(e.gridheight<r.gridheight)for(let t=e.gridheight;t<r.gridheight;t++){const e=$("#win"+r.id+"_ln"+t,n);e.length&&e.remove()}r.gridheight=e.gridheight,r.gridwidth=e.gridwidth}if(r.type,"graphics"==r.type){var a=$("#win"+r.id+"_canvas",n);if(a.length){if(r.graphwidth!=e.graphwidth||r.graphheight!=e.graphheight){r.graphwidth=e.graphwidth,r.graphheight=e.graphheight,a.attr("width",r.graphwidth*r.scaleratio),a.attr("height",r.graphheight*r.scaleratio),a.css("width",r.graphwidth+"px"),a.css("height",r.graphheight+"px");let t=le(a);t&&(t.setTransform(r.scaleratio,0,0,r.scaleratio,0,0),t.fillStyle=r.defcolor,t.fillRect(0,0,r.graphwidth,r.graphheight),t.fillStyle="#000000"),r.frameel.css("background-color",r.defcolor);var l=r.id;fe((function(){ge(l)}))}}else{r.graphwidth=e.graphwidth,r.graphheight=e.graphheight,r.defcolor="#FFF",a=$("<canvas>",{id:"win"+r.id+"_canvas"}),r.backpixelratio=1;let t=le(a);t&&(r.backpixelratio=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1),r.scaleratio=p/r.backpixelratio,a.attr("width",r.graphwidth*r.scaleratio),a.attr("height",r.graphheight*r.scaleratio),a.css("width",r.graphwidth+"px"),a.css("height",r.graphheight+"px"),r.frameel.css("background-color",r.defcolor),t&&t.setTransform(r.scaleratio,0,0,r.scaleratio,0,0),r.frameel.append(a)}}var u,f=h.width-(e.left+e.width),c=h.height-(e.top+e.height);u={left:e.left+"px",top:e.top+"px",right:f+"px",bottom:c+"px"},r.coords.left=e.left,r.coords.top=e.top,r.coords.right=f,r.coords.bottom=c,t.css(u)}}function Z(e){e.frameel.remove(),delete d[e.id],e.frameel=null;var t=$("#win"+e.id+"_moreprompt",n);t.length&&t.remove()}function J(e){var r=d[e.id];if(null!=r)if(r.input&&"line"==r.input.type)ne("Got content update for window "+e.id+", which is awaiting line input.");else{if(r.needscroll=!0,"grid"==r.type){var i=e.lines;for(let t=0;t<i.length;t++){var s=i[t],o=s.line,a=s.content,l=$("#win"+r.id+"_ln"+o,n);if(l.length)if(a&&a.length){l.empty();for(let e=0;e<a.length;e++){var u,f,c,p=a[e],_=null,g=null,m=0;if("object"===jQuery.type(p)){if(r.lastrdesc=p,void 0!==p.special)continue;u=p.style,f=p.text,c=p.hyperlink,_=p.fg,g=p.bg,m=p.reverse}else u=p,e++,f=a[e],c=void 0;let t="Style_"+u;(m=m||r.stylehints[V[u]].reverse)&&(t+=" reverse");var v=$("<span>",{class:t});if(_||g){const e={};_&&(e[m?"background-color":"color"]=_),g&&(e[m?"color":"background-color"]=g),v.css(e)}if(c){var b=$("<a>",{href:"#",class:"Internal"});b.text(f),b.on("click",je(r.id,c)),v.append(b)}else ae(v,f);l.append(v)}}else l.text(" ");else ne("Got content for nonexistent line "+o+" of window "+e.id+".")}}if("buffer"==r.type){var k=e.text;r.inputel&&r.inputel.detach();var y=$("#win"+r.id+"_cursor",n);y.length&&y.remove(),y=null,e.clear&&(r.frameel.empty(),r.topunseen=0,r.pagefrommark=0,r.lastrdesc=null,r.stylehints&&(e["background-color"]&&(r.stylehints[0]["background-color"]=e["background-color"]),te(r,r.frameel))),void 0===k&&(k=[]);for(let e=0;e<k.length;e++){var x=k[e];const n=x.content;let i=null;if(x.append){if(!n||!n.length)continue;i=X(r)}if(null==i&&(i=$("<div>",{class:"BufferLine"}),i.data("blankpara",!0),r.frameel.append(i)),x.flowbreak&&i.addClass("FlowBreak"),n&&n.length){i.data("blankpara")&&(i.data("blankpara",!1),i.empty());for(let e=0;e<n.length;e++){const s=n[e];let o,a,l,u=null,f=null,c=0;if("object"===jQuery.type(s)){if(r.lastrdesc=s,void 0!==s.special){if("image"==s.special){var U=s.url;if(t&&t.get_image_url){var C=t.get_image_url(s.image);C&&(U=C)}let e=$("<img>",{src:U,width:""+s.width,height:""+s.height});switch(s.alttext?e.attr("alt",s.alttext):e.attr("alt","Image "+s.image),s.alignment){case"inlineup":e.addClass("ImageInlineUp");break;case"inlinedown":e.addClass("ImageInlineDown");break;case"inlinecenter":e.addClass("ImageInlineCenter");break;case"marginleft":e.addClass("ImageMarginLeft");break;case"marginright":e.addClass("ImageMarginRight");break;default:e.addClass("ImageInlineUp")}if(null!=s.hyperlink){const t=$("<a>",{href:"#",class:"Internal"});t.append(e),t.on("click",je(r.id,s.hyperlink)),e=t}i.append(e);continue}re("Unknown special entry in line data: "+s.special);continue}o=s.style,a=s.text,l=s.hyperlink,u=s.fg,f=s.bg,c=s.reverse}else o=s,e++,a=n[e],l=void 0;c=c||r.stylehints[V[o]].reverse;let d="Style_"+o;c&&(d+=" reverse");let h=$("<span>",{class:d});if(u||f){const e={};u&&(e[c?"background-color":"color"]=u),f&&(e[c?"color":"background-color"]=f),h.css(e)}if(l){const e=$("<a>",{href:"#",class:"Internal"});e.text(a),e.on("click",je(r.id,l)),h.append(e)}else ae(h,a);i.append(h)}}else i.data("blankpara")&&i.append($("<span>",{class:"BlankLineSpan"}).text(" "))}var S=r.frameel.children();if(S.length){var M=S.length-200;if(M>0){var j=S.get(M).offsetTop;r.topunseen-=j,r.topunseen<0&&(r.topunseen=0),r.pagefrommark-=j,r.pagefrommark<0&&(r.pagefrommark=0);for(let e=0;e<M;e++){const t=S[e];"STYLE"!==t.tagName&&$(t).remove()}}}const i=X(r);if(i&&((y=$("<span>",{id:"win"+r.id+"_cursor",class:"InvisibleCursor"})).append(" "),i.append(y),r.inputel)){var G=r.inputel,T=y.position(),z=r.frameel.width()-(h.buffermarginx+T.left+2);if(z<1&&(z=1),G.css({position:"absolute",left:"0px",top:"0px",width:z+"px"}),r.lastrdesc){const e=r.lastrdesc;if(G.toggleClass("reverse",!!e.reverse),e.fg||e.bg){const t={};t[e.reverse?"background-color":"color"]=e.fg||"",t[e.reverse?"color":"background-color"]=e.bg||"",G.css(t)}}y.append(G)}}if("graphics"==r.type){var q=e.draw;void 0===q&&(q=[]);var A=0==w.length;for(let e=0;e<q.length;e++){var F=q[e],D={winid:r.id};jQuery.extend(D,F),w.push(D)}A&&w.length>0&&function e(r,i){if(0==w.length)return void re("perform_graphics_ops called with no queued ops"+(r?" (plus image!)":""));for(;w.length;){var s=w[0],o=d[s.winid];if(o){var a=le($("#win"+o.id+"_canvas",n));if(a){var l=s.special;switch(l){case"setcolor":o.defcolor=s.color;break;case"fill":void 0===s.color?a.fillStyle=o.defcolor:a.fillStyle=s.color,void 0===s.x?(a.fillRect(0,0,o.graphwidth,o.graphheight),o.frameel.css("background-color",a.fillStyle)):a.fillRect(s.x,s.y,s.width,s.height),a.fillStyle="#000000";break;case"image":if(!r){var u=P[s.image];u&&u.width>0&&u.height>0?(r=u,i=!0):delete P[s.image]}if(!r){var f=s.url;if(t&&t.get_image_url){var c=t.get_image_url(s.image);c&&(f=c)}var h=new Image;return $(h).on("load",(function(t){e(h,t)})),$(h).on("error",(function(){e(h,null)})),void(h.src=f)}i&&(P[s.image]=r,a.drawImage(r,s.x,s.y,s.width,s.height)),i=null,r=null;break;default:re("Unknown special entry in graphics content: "+l)}w.shift()}else re("perform_graphics_ops: op for nonexistent canvas "+o.id),w.shift()}else re("perform_graphics_ops: op for nonexistent window "+s.winid),w.shift()}}(null)}}else ne("Got content update for window "+e.id+", which does not exist.")}function X(e){var t,r,n=(t=e.frameel,(r=t.children())&&r.length?r.get(r.length-1):null);return null==n||"BufferLine"!=n.className?null:$(n)}function K(e){var t=X(e);return t&&t.length?t.get(0).offsetTop:0}function ee(e){m=0;var t=0;if(jQuery.each(d,(function(e,r){r.needspaging&&(m+=1,t&&r.id!=g||(t=r.id))})),m&&(g=t),!m&&e){var r=0;if(u||m||jQuery.each(d,(function(e,t){t.input&&(r&&t.id!=_||(r=t.id))})),r){var n=d[r];n.inputel&&n.inputel.focus()}}}function te(e,t){const r="window"+e.id,n=[];for(let t=0;t<11;t++){const i=e.stylehints[t];let s=[];for(const t in i)"reverse"===t||"font-family"===t&&"buffer"!==e.type||s.push(`${t}: ${i[t]}`);if(s.length&&n.push(`#${r} .Style_${Q[t]} {${s.join("; ")}}`),i.color||i["background-color"]){let e=[];i.color&&e.push("background-color: "+i.color),i["background-color"]&&e.push("color: "+i["background-color"]),n.push(`#${r} .Style_${Q[t]}.reverse {${e.join("; ")}}`)}}e.stylehints[0]["background-color"]&&n.push(`#${r} {background-color: ${e.stylehints[0]["background-color"]}}`),n.length&&t.append(`<style>${n.join("\n")}</style>`)}function re(e){window.console&&console.log&&console.log(e)}function ne(e){e||(e="???");var t=document.getElementById("errorcontent");oe(t),t.appendChild(document.createTextNode(e)),"WarningPane"==(t=document.getElementById("errorpane")).className&&(t.className=null),t.style.display="",c=!0,se()}function ie(){y=null,re("Retrying update..."),de("refresh",null,null)}function se(){if(0!=f){f=!1;var e=document.getElementById("loadingpane");e&&(e.style.display="none")}}function oe(e){var t,r;for(r=e.childNodes;r.length>0;)t=r.item(0),e.removeChild(t)}function ae(e,t){if(x){if("match"==x){if(U.test(t)){var r=$("<a>",{href:t,class:"External",target:"_blank"});return r.text(t),void e.append(r)}}else if("search"==x){for(;;){var n=U.exec(t);if(!n)break;if(n.index>0){var i=t.substring(0,n.index);e.append(document.createTextNode(i))}const r=$("<a>",{href:n[0],class:"External",target:"_blank"});r.text(n[0]),e.append(r),t=t.substring(n.index+n[0].length)}if(!t.length)return}e.append(document.createTextNode(t))}else e.append(document.createTextNode(t))}function le(e){if(e&&e.length){var t=e.get(0);return t&&t.getContext?t.getContext("2d"):void 0}}function ue(e,t){return window.setTimeout(t,1e3*e)}function fe(e){return window.setTimeout(e,10)}function ce(e,t,r){var n=null;e.history.length&&(n=e.history[e.history.length-1]),t&&t!=n&&(e.history.push(t),e.history.length>20&&e.history.shift()),de("line",e,t,r)}function de(e,t,n,i){if(!u||"specialresponse"==e)if(a<=l&&"init"!=e&&"refresh"!=e)re("Not sending repeated generation number: "+a);else{var s=0;t&&(s=t.id);var o={type:e,gen:a};l=a,"line"==e?(o.window=t.id,o.value=n,i&&(o.terminator=i)):"char"==e||"hyperlink"==e?(o.window=t.id,o.value=n):"mouse"==e?(o.window=t.id,o.x=n,o.y=i):"external"==e?o.value=n:"specialresponse"==e?(o.response=n,o.value=i):"debuginput"==e?o.value=n:"redraw"==e?o.window=t.id:"init"==e?(o.metrics=n,o.support=["timer","graphics","graphicswin","hyperlinks","garglktext"]):"arrange"==e&&(o.metrics=n),"init"!=e&&"refresh"!=e&&"specialresponse"!=e&&"debuginput"!=e&&jQuery.each(d,(function(t,r){if(("line"!=e&&"char"!=e||r.id!=s)&&r.input&&"line"==r.input.type&&r.inputel&&r.inputel.val()){var n=o.partial;n||(n={},o.partial=n),n[r.id]=r.inputel.val()}})),E&&(B.input=o,B.timestamp=(new Date).getTime()),r.accept(o)}}function he(e){jQuery.ajax(W,{type:"POST",contentType:"application/json",data:JSON.stringify(e),error:function(e,t,r){re("Transcript recording failed; deactivating. Error "+t+": "+r),E=!1}})}function pe(){null!=k&&(window.clearTimeout(k),k=null),k=ue(.2,_e)}function _e(){if(k=null,u)k=ue(.2,_e);else{var e,t,r=H();if(t=h,(e=r).width!=t.width||e.height!=t.height||e.gridcharwidth!=t.gridcharwidth||e.gridcharheight!=t.gridcharheight||e.buffercharwidth!=t.buffercharwidth||e.buffercharheight!=t.buffercharheight)de("arrange",null,h=r)}}function ge(e){var t=d[e];t&&"graphics"==t.type&&de("redraw",t,null)}function me(){var e=window.devicePixelRatio||1;e!=p&&(re("### devicePixelRatio changed to "+(p=e)),jQuery.each(d,(function(e,t){if("graphics"==t.type){var r=$("#win"+t.id+"_canvas",n);t.scaleratio=p/t.backpixelratio;var i=le(r);r.attr("width",t.graphwidth*t.scaleratio),r.attr("height",t.graphheight*t.scaleratio),r.css("width",t.graphwidth+"px"),r.css("height",t.graphheight+"px"),i&&(i.setTransform(t.scaleratio,0,0,t.scaleratio,0,0),i.fillStyle=t.defcolor,i.fillRect(0,0,t.graphwidth,t.graphheight),i.fillStyle="#000000"),t.frameel.css("background-color",t.defcolor),fe((function(){ge(e)}))}})))}function we(e){if(!u){var t,r=0;if(e&&(r=e.which),"INPUT"!=e.target.tagName.toUpperCase())if(!(e.target.className.indexOf("CanHaveInputFocus")>=0))if(!(e.altKey||e.metaKey||e.ctrlKey))if(m&&(t=d[g])){if(!(r>=32&&r<=126||13==r))return;e.preventDefault();var i=t.frameel;i.scrollTop(t.topunseen-h.buffercharheight);var s=i.outerHeight(),o=K(t),a=i.scrollTop()+s;if(a>o&&(a=o),t.topunseen<a&&(t.topunseen=a),t.needspaging&&i.scrollTop()+s+2>=i.get(0).scrollHeight){t.needspaging=!1;var l=$("#win"+t.id+"_moreprompt",n);l.length&&l.remove(),ee(!0)}}else if((t=d[_])&&t.inputel){if(t.inputel.focus(),"line"!=t.input.type){var f=null;return 13==r?f="return":r==S?f="delete":r&&(f=String.fromCharCode(r)),f&&de("char",t,f),void e.preventDefault()}if(13==r)return ce(t,t.inputel.val(),null),void e.preventDefault();if(r){if(r>=32){var c=String.fromCharCode(r);t.inputel.val(t.inputel.val()+c)}e.preventDefault()}else;}}}function ve(e){var t=e.data,r=d[t];r&&(r.inputel&&(_=r.id),r.needspaging?g=r.id:r.inputel&&(g=0))}function be(e){var t=e.data,r=d[t];if(r&&0==e.button&&r.reqmouse){var i=0,s=0;if("grid"==r.type){var o=$("#win"+r.id+"_ln0",n);if(o.length){var a=o.offset();i=Math.floor((e.clientX-a.left)/h.gridcharwidth),s=Math.floor((e.clientY-a.top)/h.gridcharheight)}i>=r.gridwidth&&(i=r.gridwidth-1),i<0&&(i=0),s>=r.gridheight&&(s=r.gridheight-1),s<0&&(s=0)}else{if("graphics"!=r.type)return;var l=$("#win"+r.id+"_canvas",n);if(l.length){var u=l.offset();i=e.clientX-u.left,s=e.clientY-u.top}i>=r.graphwidth&&(i=r.graphwidth-1),i<0&&(i=0),s>=r.graphheight&&(s=r.graphheight-1),s<0&&(s=0)}e.preventDefault(),de("mouse",r,i,s)}}function ke(e){var t=0;if(e&&(t=e.keyCode),!t)return!0;var r=null;switch(t){case G:r="left";break;case z:r="right";break;case T:r="up";break;case q:r="down";break;case S:r="delete";break;case j:r="escape";break;case M:r="tab";break;case D:r="pageup";break;case L:r="pagedown";break;case A:r="home";break;case F:r="end";break;case 112:r="func1";break;case 113:r="func2";break;case 114:r="func3";break;case 115:r="func4";break;case 116:r="func5";break;case 117:r="func6";break;case 118:r="func7";break;case 119:r="func8";break;case 120:r="func9";break;case 121:r="func10";break;case 122:r="func11";break;case 123:r="func12"}if(r){var n=$(this).data("winid"),i=d[n];return!i||!i.input||(de("char",i,r),!1)}return!0}function ye(e){var t,r=0;if(e&&(r=e.which),!r)return!1;t=13==r?"return":String.fromCharCode(r);var n=$(this).data("winid"),i=d[n];return!i||!i.input||(de("char",i,t),!1)}function xe(e){var t=0;if(e&&(t=e.keyCode),!t)return!0;if(t==T||t==q){var r=$(this).data("winid"),n=d[r];return!n||!n.input||(t==T&&n.historypos>0&&(n.historypos-=1,n.historypos<n.history.length?this.value=n.history[n.historypos]:this.value=""),t==q&&n.historypos<n.history.length&&(n.historypos+=1,n.historypos<n.history.length?this.value=n.history[n.historypos]:this.value=""),!1)}if(N[t]){const e=$(this).data("winid"),r=d[e];if(!r||!r.input)return!0;if(r.terminators[N[t]])return ce(r,r.inputel.val(),N[t]),!1}return!0}function Ue(e){var t=0;if(e&&(t=e.which),!t)return!0;if(13==t){var r=$(this).data("winid"),n=d[r];return!n||!n.input||(ce(n,this.value,null),!1)}return!0}function Ce(e){var t=e.data;d[t]&&(_=t,g=t)}function Se(e){var t=e.data;d[t]}function Me(e){var t=e.data,r=d[t];if(r&&r.needspaging){var i=r.frameel,s=i.outerHeight(),o=K(r),a=i.scrollTop()+s;if(a>o&&(a=o),r.topunseen<a&&(r.topunseen=a),i.scrollTop()+s+2>=i.get(0).scrollHeight){r.needspaging=!1;var l=$("#win"+r.id+"_moreprompt",n);return l.length&&l.remove(),void ee(!0)}}}function je(e,t){return function(){var r=d[e];return!!r&&(!!r.reqhyperlink&&(de("hyperlink",r,t),!1))}}function Ge(){v&&b&&(v=window.setTimeout(Ge,b),u||de("timer"))}function Te(e){de("debuginput",null,e)}return{version:"2.2.5",init:function(s){if(!s&&window.Game&&(s=window.Game),s)if(s.accept)if(r=s,s.Dialog&&(e=s.Dialog),s.GiLoad&&(t=s.GiLoad),window.jQuery&&jQuery.fn.jquery){var a=jQuery.fn.jquery.split(".");if(a.length<2||a[0]<1||1==a[0]&&a[1]<9)ne("This version of the jQuery library is too old. (Version "+jQuery.fn.jquery+" found; 1.9.0 required.)");else{for(var l in I)N[I[l]]=l;d={},s.windowport&&(i=s.windowport),s.gameport&&(o=s.gameport);var f=$("#"+i,n);if(f.length){f.empty(),$(document).on("keypress",we),$(window).on("resize",pe),p=window.devicePixelRatio||1,window.matchMedia&&(window.matchMedia("screen and (min-resolution: 1.5dppx)").addListener(me),window.matchMedia("screen and (min-resolution: 2dppx)").addListener(me),window.matchMedia("screen and (min-resolution: 3dppx)").addListener(me),window.matchMedia("screen and (min-resolution: 4dppx)").addListener(me));var c=H();if("string"!==jQuery.type(c)){if(h=c,function(){var e=$("#"+o,n);if(!e.length)return"Cannot find gameport element #"+o+" in this document.";var t=$("<div>",{id:"resize-sensor-shrink"}).css({position:"absolute",left:"0",right:"0",top:"0",bottom:"0",overflow:"hidden",visibility:"hidden","z-index":"-1"});t.append($("<div>",{id:"resize-sensor-shrink-child"}).css({position:"absolute",left:"0",right:"0",width:"200%",height:"200%"}));var r=$("<div>",{id:"resize-sensor-expand"}).css({position:"absolute",left:"0",right:"0",top:"0",bottom:"0",overflow:"hidden",visibility:"hidden","z-index":"-1"});r.append($("<div>",{id:"resize-sensor-expand-child"}).css({position:"absolute",left:"0",right:"0"}));var i=t.get(0),s=r.get(0),a=s.childNodes[0],l=function(){i.scrollLeft=1e5,i.scrollTop=1e5,a.style.width="100000px",a.style.height="100000px",s.scrollLeft=1e5,s.scrollTop=1e5};e.append(t),e.append(r),l();var u=function(e){pe(),l()};t.on("scroll",u),r.on("scroll",u)}(),(x=s.detect_external_links)&&((U=s.regex_external_links)||(U="search"==x?RegExp("\\b((?:https?://)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?«»“”‘’]))","i"):RegExp("^https?:","i"))),s.recording_url&&(E=!0,R=he,W=s.recording_url),s.recording_handler&&(E=!0,R=s.recording_handler,W="(custom handler)"),E){var _=function(){var e={},t=location.search.substring(1,location.search.length);if(t.length){var r=t.split("&");t=t.replace(/\+/g," ");for(var n=0;n<r.length;n++){var i=r[n].split("="),s=decodeURIComponent(i[0]),o=2==i.length?decodeURIComponent(i[1]):s;e[s]=o}}return e}().feedback;"undefined"!=jQuery.type(_)&&"1"!=_?(E=!1,re("User has opted out of transcript recording.")):(B={sessionId:(new Date).getTime()+""+Math.ceil(1e4*Math.random()),input:null,output:null,timestamp:0,outtimestamp:0},s.recording_label&&(B.label=s.recording_label),"simple"==s.recording_format?B.format="simple":B.format="glkote",re("Transcript recording active: session "+B.sessionId+' "'+B.label+'", destination '+W))}if(s.debug_commands){var g=window.GiDebug;1!=s.debug_commands&&(g=s.debug_commands),g?(g.init(Te),C=g.output,s.debug_console_open&&g.open()):re("The debug_commands option is set, but there is no GiDebug module.")}s.font_load_delay?(u=!0,fe((function(){u=!1,de("init",null,h=H())}))):de("init",null,h)}else ne(c)}else ne("Cannot find windowport element #"+i+" in this document.")}}else ne("The jQuery library has not been loaded.");else ne("The game interface object must have an accept() function.");else ne("No game interface object has been provided.")},update:function(t){se();var r=null;if(t.autorestore&&0==a&&(r=t.autorestore),delete t.autorestore,E&&function(e){B.output=e,B.outtimestamp=(new Date).getTime();var t=!0;if("simple"==B.format){var r=B.input,n=B.output,i=null;if(r&&(i=r.type),"line"==i||"char"==i?B.input=r.value:"init"!=i&&"external"!=i&&"specialresponse"!=i&&i?t=!1:B.input="",n.windows){O.bufferwins={};for(var s=0;s<n.windows.length;s++)"buffer"==n.windows[s].type&&(O.bufferwins[n.windows[s].id]=!0)}let e="";if(n.content)for(let t=0;t<n.content.length;t++){var o=n.content[t];if(O.bufferwins&&O.bufferwins[o.id]&&o.text)for(var a=0;a<o.text.length;a++){var l=o.text[a];if(l.append||(e+="\n"),l.content)for(var u=0;u<l.content.length;u++){var f=l.content[u];"string"==jQuery.type(f)?(u++,e+=l.content[u]):f.text&&(e+=f.text)}}}B.output=e}t&&R(B);B.input=null,B.output=null,B.timestamp=0,B.outtimestamp=0}(t),t.debugoutput&&C&&C(t.debugoutput),"error"!=t.type){if("pass"!=t.type)if("retry"!=t.type)if("update"==t.type)if(t.gen!=a)if(t.gen<a)re("Ignoring out-of-order generation number: got "+t.gen+", currently at "+a);else{a=t.gen,u&&(jQuery.each(d,(function(e,t){t.inputel&&t.inputel.prop("disabled",!1)})),u=!1),null!=t.input&&function(e){var t={};jQuery.map(e,(function(e){e.type&&(t[e.id]=e)})),jQuery.each(d,(function(e,r){if(r.input){var n=t[r.id];(null==n||n.gen>r.input.gen)&&(r.input=null,r.inputel&&(r.inputel.remove(),r.inputel=null))}}))}(t.input),null!=t.windows&&function(e){jQuery.each(d,(function(e,t){t.inplace=!1})),jQuery.map(e,Y);var t=jQuery.map(d,(function(e){if(!e.inplace)return e}));jQuery.map(t,Z)}(t.windows),null!=t.content&&function(e){jQuery.map(e,J)}(t.content),null!=t.input&&function(e){var t={},r={},i={};jQuery.map(e,(function(e){e.type&&(t[e.id]=e),e.hyperlink&&(r[e.id]=!0),e.mouse&&(i[e.id]=!0)})),jQuery.each(d,(function(e,s){s.reqhyperlink=r[s.id],s.reqmouse=i[s.id];var o=t[s.id];if(null!=o){s.input=o;var a=1;"line"==o.type&&(a=o.maxlen);var l=!1,u=s.inputel;if(null==u){l=!0;var f="Input";if("line"==o.type?f+=" LineInput":"char"==o.type?f+=" CharInput":ne("Window "+s.id+" has requested unrecognized input type "+o.type+"."),(u=$("<input>",{id:"win"+s.id+"_input",class:f,type:"text",maxlength:a})).attr("autocapitalize","off"),u.attr({"aria-live":"off"}),"line"==o.type){if(u.on("keypress",Ue),u.on("keydown",xe),o.initial&&u.val(o.initial),s.terminators={},o.terminators)for(var c=0;c<o.terminators.length;c++)s.terminators[o.terminators[c]]=!0}else"char"==o.type&&(u.on("keypress",ye),u.on("keydown",ke));if(u.on("focus",s.id,Ce),u.on("blur",s.id,Se),u.data("winid",s.id),s.inputel=u,s.historypos=s.history.length,s.needscroll=!0,s.lastrdesc){const e=s.lastrdesc;if(u.toggleClass("reverse",!!e.reverse),e.fg||e.bg){const t={};t[e.reverse?"background-color":"color"]=e.fg||"",t[e.reverse?"color":"background-color"]=e.bg||"",u.css(t)}}}if("grid"==s.type){var d=$("#win"+s.id+"_ln"+o.ypos,n);if(!d.length)return void ne("Window "+s.id+" has requested input at unknown line "+o.ypos+".");var p=d.position(),_=p.left+Math.round(o.xpos*h.gridcharwidth),g=Math.round(a*h.gridcharwidth),m=s.frameel.width()-(h.buffermarginx+_+2);g>m&&(g=m),u.css({position:"absolute",left:_+"px",top:p.top+"px",width:g+"px"}),l&&s.frameel.append(u)}if("buffer"==s.type){var w=$("#win"+s.id+"_cursor",n);w.length||((w=$("<span>",{id:"win"+s.id+"_cursor",class:"InvisibleCursor"})).append(" "),s.frameel.append(w));const e=w.position();let t=s.frameel.width()-(h.buffermarginx+e.left+2);t<1&&(t=1),u.css({position:"absolute",left:"0px",top:"0px",width:t+"px"}),l&&w.append(u)}}}))}(t.input),void 0!==t.timer&&function(e){v&&(window.clearTimeout(v),v=null,b=null);e&&(b=e,v=window.setTimeout(Ge,b))}(t.timer),null!=t.specialinput&&function(t){if("fileref_prompt"==t.type){var r=function(e){de("specialresponse",null,"fileref_prompt",e)};try{var n="read"!=t.filemode;e.open(n,t.filetype,t.gameid,r)}catch(e){s.log("Unable to open file dialog: "+e),fe(r=function(){de("specialresponse",null,"fileref_prompt",null)})}}else ne("Request for unknown special input type: "+t.type)}(t.specialinput),jQuery.each(d,(function(e,t){if("buffer"==t.type&&t.needscroll&&(t.needscroll=!1,!t.needspaging)){var r=t.frameel;r.scrollTop(t.topunseen-h.buffercharheight),t.pagefrommark=t.topunseen;var s=r.outerHeight(),o=K(t),a=r.scrollTop()+s;a>o&&(a=o),t.topunseen<a&&(t.topunseen=a),r.scrollTop()+s+2>=r.get(0).scrollHeight?t.needspaging=!1:t.needspaging=!0;var l=$("#win"+t.id+"_moreprompt",n),u=$("#win"+t.id+"_prevmark",n);if(t.needspaging){if(!l.length){(l=$("<div>",{id:"win"+t.id+"_moreprompt",class:"MorePrompt"})).append("More");var f=t.coords.right+20,c=t.coords.bottom;l.css({bottom:c+"px",right:f+"px"}),$("#"+i,n).append(l)}u.length||(u=$("<div>",{id:"win"+t.id+"_prevmark",class:"PreviousMark"}),r.prepend(u)),u.css("top",t.pagefrommark+"px")}else l.length&&l.remove(),u.length&&u.remove()}})),ee(!1),u=!1,(t.disable||t.specialinput)&&(u=!0,jQuery.each(d,(function(e,t){t.inputel&&t.inputel.prop("disabled",!0)})));var o=0;if(u||m||jQuery.each(d,(function(e,t){t.input&&(o&&t.id!=_||(o=t.id))})),o){fe((function(){var e=d[o];e.inputel&&e.inputel.focus()}))}r&&(r.history&&jQuery.each(r.history,(function(e,t){const r=d[e];null!=r&&(r.history=t.slice(0),r.historypos=r.history.length)})),r.defcolor&&jQuery.each(r.defcolor,(function(e,t){const r=d[e];null!=r&&(r.defcolor=t)})),jQuery.each(d,(function(e,t){"buffer"==t.type&&function(e){var t=e.frameel,r=t.outerHeight();t.scrollTop(t.get(0).scrollHeight-r);var i=K(e),s=t.scrollTop()+r;s>i&&(s=i);e.topunseen<s&&(e.topunseen=s);if(e.needspaging&&t.scrollTop()+r+2>=t.get(0).scrollHeight){e.needspaging=!1;var o=$("#win"+e.id+"_moreprompt",n);o.length&&o.remove(),ee(!0)}}(t)})),r.metrics&&r.metrics.width==h.width&&r.metrics.height==h.height||(h.width+=2,pe()))}else re("Ignoring repeated generation number: "+a);else re("Ignoring unknown message type "+t.type+".");else y?re("Event has timed out, but a retry is already queued!"):(re("Event has timed out; will retry..."),function(){if(1==f)return;f=!0;var e=document.getElementById("loadingpane");e&&(e.style.display="")}(),y=ue(2,ie))}else ne(t.message)},extevent:function(e){de("external",null,e)},getinterface:function(){return r},getdomcontext:function(){return n},setdomcontext:function(e){n=e},save_allstate:function(){var e={metrics:{width:h.width,height:h.height},history:{}};return jQuery.each(d,(function(t,r){r.history&&r.history.length&&(e.history[t]=r.history.slice(0)),r.defcolor&&(void 0===e.defcolor&&(e.defcolor={}),e.defcolor[t]=r.defcolor)})),e},log:re,warning:function(e){if(!c)if(e){var t=document.getElementById("errorcontent");oe(t),t.appendChild(document.createTextNode(e)),$("#errorpane").addClass("WarningPane"),$("#errorpane").show(),se()}else $("#errorpane").hide()},error:ne}}(),o=s,a=r(6),l=r.n(a),u=r(7),f=r.n(u),c=r(8),d=r.n(c),h=r(2),p=r.n(h),_=r(3),g=r.n(_);$((function(){if(!window.parchment_options)return o.error("No storyfile specified");const e=window.parchment_options.story[0];let t;if(/zblorb|z3|z4|z5|z8/.test(e))t="zcode";else{if(!/gblorb|ulx/.test(e))return o.error("Unknown storyfile format");t="glulx"}$.ajax({cache:!0,crossDomain:!0,dataType:"jsonp",jsonp:!1,jsonpCallback:"processBase64Zcode",url:e}).catch(e=>{o.error("Error loading storyfile: "+e.status)}).then(e=>{const r=function(e){const t=[];let r,n=0;for(r=e.length%8;n<r;++n)t.push(255&e.charCodeAt(n));for(r=e.length;n<r;)t.push(255&e.charCodeAt(n++),255&e.charCodeAt(n++),255&e.charCodeAt(n++),255&e.charCodeAt(n++),255&e.charCodeAt(n++),255&e.charCodeAt(n++),255&e.charCodeAt(n++),255&e.charCodeAt(n++));return t}(atob(e));if("zcode"===t){const e=new l.a,t=Uint8Array.from(r),s={vm:e,Dialog:n.a,Dispatch:f.a,Glk:i,GlkOte:o};e.prepare(t,s),i.init(s)}"glulx"===t&&(window.GiDispa=p.a.GiDispa,window.Glk=i,window.GlkOte=o,g.a.GiLoad.load_run({blorb_gamechunk_type:"GLUL",Dialog:n.a,GiDispa:p.a.GiDispa,GiLoad:g.a.GiLoad,GlkOte:o,image_info_map:"StaticImageInfo",io:i,set_page_title:!1,spacing:0,vm:d.a.Quixe},r,"array"))}).catch(e=>{o.error(e)})}))}]);